<!DOCTYPE html>
<html>
	<head>
		
<title>kubernetes-Quiet</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" type="image/x-icon" href="/image/favicon.ico">

<link rel="stylesheet" href="/css/index.css">



<meta name="keywords" content="k8s,">
<meta name="description" content="">


<script src="/js/jquery.min.js"></script>


<script src="/js/index.js"></script>


<script src="/js/fancybox.umd.js"></script>


<script src="/js/fancybox-images.js"></script>


<script src="/js/gitalk.min.js"></script>


<script src="/js/hljs.min.js"></script>
 
<script>hljs.highlightAll();</script>

	<meta name="generator" content="Hexo 5.4.2"></head>

	<body>
		
	<div class="header">
		<div class="header-top" id="header-top">
			<div class="h-left">
				<a href="/">
					<img src="/image/logo.png" alt="Quiet">
				</a>
			</div>
			<div class="h-right">
				<ul>
					
						
								<li>
									<a href="/">
										HOME
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/archives">
										ARCHIVE
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/categories">
										CATEGORIES
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/tags">
										TAGS
									</a>
									<span class="dot"></span>
								</li>
								
									
				</ul>
			</div>
			<div class="h-right-close">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
					<path fill="none" d="M0 0h24v24H0z" />
					<path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(68,68,68,1)" />
				</svg>
			</div>
		</div>
	</div>
	<div class="sidebar">
    <div class="topo">
        <h2>Joey</h2>
    </div>
    <ul>
        
        <li>
            <a href="/">HOME</a>
        </li>
        
        <li>
            <a href="/archives">ARCHIVE</a>
        </li>
        
        <li>
            <a href="/categories">CATEGORIES</a>
        </li>
        
        <li>
            <a href="/tags">TAGS</a>
        </li>
        
    </ul>
    <div class="my_foot">
        
        <a target="_blank" rel="noopener" href="https://github.com/79E/hexo-theme-quiet">
            <img src="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quiet主题">
        </a>
        
    </div>
</div>
<div class='shelter'>
</div>
<style>
    .shelter{
        background-color: #333;
        opacity:0.5;
        cursor: pointer;
        display: none; 
        position: fixed;
        left: 0;
        top: 0; 
        right: 0;
        bottom: 0;
        z-index: 1998;
    }
    .sidebar {
        width: 66%;
        height: 100%;
        position: fixed;
        top: 0;
        right: -100%;
        bottom: 0;
        background: #fff;
        z-index: 1999;
        text-align: center;
        box-shadow: -6px 0 20px rgba(98, 94, 94, .815);
    }

    .topo {
        width: 100%;
        height: 200px;
        background: url(https://api.ixiaowai.cn/gqapi/gqapi.php) no-repeat;
        background-size: 100% 100%;
        position: relative;
        display: flex;
        align-items: flex-end
    }

    .topo h2 {
        color: #fff;
        z-index: 1;
        position: relative;
        margin: 0 0 10px 10px;
        font-size: 1.2em;
        box-sizing: border-box
    }

    .topo:before {
        content: '';
        background-image: url(/image/pattern.png);
        background-repeat: repeat;
        height: 100%;
        left: 0;
        position: absolute;
        top: 0;
        width: 100%;
        z-index: 1
    }

    .sidebar ul {
        width: 100%;
        margin-top: 50px
    }

    .sidebar ul li {
        height: 50px;
        list-style: none;
        font-size: 1.2em;
        text-align: right;
        margin-right: 10px
    }

    .sidebar ul li a {
        display: grid;
        color: #5d606a;
        text-overflow: ellipsis;
        width: 100%;
        text-decoration: none
    }

    .my_foot {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        position: absolute;
        bottom: 0
    }

    .my_foot a {
        text-decoration: none;
        margin-right: 10px;
        display: inline-block
    }

    .my_foot a img {
        width: 30px;
        height: 30px
    }
</style>

<script>
    $( function () {
	$( '.h-right-close>svg' )
		.click( function () {
			$( '.sidebar' )
				.animate( {
					right: "0"
				}, 500 );
			$( '.shelter' )
				.fadeIn( "slow" )
		} );
	$( '.shelter' )
		.click( function ( e ) {
			$( '.sidebar' )
				.animate( {
					right: "-100%"
				}, 500 );
			$( '.shelter' )
				.fadeOut( "slow" )
		} )
} )

</script>

<div class="post">
    <div class="post-header-background post-header-img"
    style="background: url('https://api.ixiaowai.cn/gqapi/gqapi.php')" 
>
    <div class="post-header-background-content">
        <ul class="post-header-tag">
            
            
            <li><a href="/tags/k8s">k8s</a></li>
            
            
        </ul>
        
        <h1>kubernetes</h1>
        <div class="post-header-info">
            <div class="post-header-info-author">
                
                    <svg t="1604839279282" class="icon" viewBox="0 0 1024 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" p-id="2901" width="20" height="20">
                        <path
                            d="M513 956.3c-247.7 0-448-200.3-448-448S265.3 66.2 513 66.2s448 200.3 448 448-200.3 442.1-448 442.1z m0-830.9c-212.2 0-388.8 170.7-388.8 388.8C124.2 726.3 294.9 903 513 903c212.2 0 388.8-170.7 388.8-388.8S725.2 125.4 513 125.4z m0 430.2c-94.2 0-170.7-76.5-170.7-170.7S418.8 207.8 513 207.8s170.7 76.5 170.7 170.7S607.2 555.6 513 555.6z m0-289.1c-64.6 0-112 52.8-112 112s47.4 117.9 112 117.9 112-52.8 112-112-47.4-117.9-112-117.9z m0 689.8c-135.7 0-259-58.7-341.9-158.9l-11.8-17.8 11.8-17.8c76.5-117.9 206.2-188.5 347.8-188.5 135.7 0 265 64.6 341.9 182.6l11.8 17.8-11.8 17.8C778 897.1 648.7 956.3 513 956.3zM230.3 773.2C300.9 849.7 406.9 897 513 897c112 0 218.1-47.4 288.6-129.8-70.5-88.2-170.7-135.6-282.7-135.6s-218.1 53.3-288.6 141.6z"
                            p-id="2902" fill="#ffffff"></path>
                    </svg>
                    
                <span class="post-header-info-author-text"> <a href="../../about">Joey</a></span>
                <div class="post-header-info-author-categories">
                    
                         <a href="../../categories/learn/" target="_blank" >learn</a>
                    
                </div>
                <p>2022-04-23 23:06:20</p>
            </div>
        </div>
    </div>
</div>
    <div class="post-content" id="content">
  
  <div id="article" class="post-content-info">
    

    <h1 id="kubernetes"><a href="#kubernetes" class="headerlink" title="kubernetes"></a>kubernetes</h1><h2 id="feature"><a href="#feature" class="headerlink" title="feature"></a>feature</h2><ul>
<li>high availablity or no downtime</li>
<li>scalability or high performance</li>
<li>disaster recovery (backup and restore)</li>
</ul>
<h2 id="process-of-worker-nodes"><a href="#process-of-worker-nodes" class="headerlink" title="process of worker nodes"></a>process of worker nodes</h2><p>there are three processes in worker loads</p>
<ul>
<li><strong>kubectl</strong>: operate on pods, with the ability of resource devision</li>
<li><strong>kube proxy</strong>: communicate with nodes, with the ability of load balance</li>
<li><strong>container runtime</strong>: run container</li>
</ul>
<h2 id="process-of-main-nodes"><a href="#process-of-main-nodes" class="headerlink" title="process of main nodes"></a>process of main nodes</h2><p>there are four processes in master nodes</p>
<ul>
<li><strong>api server</strong>: access all web ui or ctl operation commands</li>
<li><strong>scheduler</strong>: calculate worker nodes resource and decide which worker node the pod will start up</li>
<li><strong>controller manager</strong>: monitor pods’s availability and restart/rebuild the broken pods</li>
<li><strong>etcd</strong>: the database of master nodes, stores all collected information from worker  nodes</li>
</ul>
<h2 id="main-kubernetes-components"><a href="#main-kubernetes-components" class="headerlink" title="main kubernetes components"></a>main kubernetes components</h2><table>
<thead>
<tr>
<th>components</th>
<th>feature</th>
</tr>
</thead>
<tbody><tr>
<td>pod</td>
<td>the smallest unit in k8s</td>
</tr>
<tr>
<td>service</td>
<td>add permanent ip address for deployment</td>
</tr>
<tr>
<td>ingress</td>
<td>map url with service</td>
</tr>
<tr>
<td>configmap</td>
<td></td>
</tr>
<tr>
<td>secret</td>
<td>store secret user name/password (encoded with base64)</td>
</tr>
<tr>
<td>volume</td>
<td>add persistence data storage</td>
</tr>
<tr>
<td>deployment</td>
<td>the method(blueprint) deploy pod</td>
</tr>
<tr>
<td>statefulset</td>
<td>the method(blueprint) deploy pod, with the ability of data sync</td>
</tr>
</tbody></table>
<h2 id="install-minikube"><a href="#install-minikube" class="headerlink" title="install minikube"></a>install minikube</h2><p><a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/start/">minikube</a> has kubernetes’s all availability but tool installed in one machine.</p>
<pre><code class="shell"># install in centos with new docker version
# don&#39;t install docker with yum default repo, for the version is too old
# follow this link :https://docs.docker.com/engine/install/centos/
sudo yum install -y yum-utils

sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
    
sudo yum install docker-ce docker-ce-cli containerd.io -y
sudo systemctl enable --now docker
  


# install minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-latest.x86_64.rpm
sudo rpm -Uvh minikube-latest.x86_64.rpm


# start minikube with none root priviledge user
useradd -G docker kube &amp;&amp; newgrp docker &amp;&amp; su - kube
minikube start
</code></pre>
<h2 id="create-pods"><a href="#create-pods" class="headerlink" title="create pods"></a>create pods</h2><p>there are two ways to create pods:</p>
<ul>
<li><strong>command line</strong>: simple usage  </li>
<li><strong>configure file</strong>: full feature</li>
</ul>
<h3 id="via-command-line"><a href="#via-command-line" class="headerlink" title="via command line"></a>via command line</h3><p><strong>get information</strong> of default configuration</p>
<pre><code class="shell">alias kubectl=&quot;minikube kubectl --&quot;
kubectl get nodes/deployment/pods/configmap/services/replicaset/all [-o wide] [--watch]
</code></pre>
<p><strong>create</strong> new pod</p>
<pre><code class="shell">kubectl create deployment nginx --image=nginx
</code></pre>
<blockquote>
<p>Note:</p>
<p>kubernetes doesn’t create pod directly, but the layer: deployment</p>
</blockquote>
<p>the command above creates a <strong>blueprint</strong> of nginx automatically, we can edit it</p>
<pre><code class="shell">kubectl edit deployment nginx
</code></pre>
<p>check pod’s <strong>detail</strong> information</p>
<pre><code class="shell"># deploy info
kubectl describe pod [pod-name]
# running log
kubectl logs [pod-name]
</code></pre>
<p><strong>login</strong> container</p>
<pre><code class="shell">kubectl exec -it [pod-name] -- /bin/bash
</code></pre>
<p><strong>delete</strong> deployment</p>
<pre><code class="shell">kubectl get deployment
kubectl delete [deployment-name]
</code></pre>
<blockquote>
<p>Note:</p>
<p>we can only delete pod at the deployment layer, for deployment will restart new pod if we delete the pod with <code>kubectl delete pod [pod-name]</code></p>
</blockquote>
<h3 id="via-configure-file"><a href="#via-configure-file" class="headerlink" title="via configure file"></a>via configure file</h3><p>configure file include three parts</p>
<ul>
<li><strong>metadata</strong></li>
<li><strong>specification</strong></li>
<li><strong>status</strong>(kubernetes auto generate)</li>
</ul>
<p>if we create pod via command line deployment, we can export the configuration file created by kubernetes.</p>
<pre><code class="shell">kubectl get deployment [deploy-name] -o yaml &gt; [deploy-name].yaml
</code></pre>
<p>create or delete deployment</p>
<pre><code class="shell">kubectl create -f [deploy-name].yaml
kubectl delete -f [deploy-name].yaml
</code></pre>
<p>mongodb.yaml</p>
<pre><code class="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb-deployment
  labels:
    app: mongodb
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
      - name: mongodb
        image: mongo
        ports:
          - containerPort: 27017
        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          valueFrom:
            secretKeyRef:
              name: mongodb-secret
              key: root-username
        - name: MONGO_INITDB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-secret
              key: root-password

---
apiVersion: v1
kind: Service
metadata:
  name: mongodb-service
spec:
  selector:
    app: mongodb
  ports:
    - protocol: TCP
      port: 3306
      targetPort: 27017
</code></pre>
<p>mongo-express.yaml</p>
<pre><code class="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo-express
  labels:
    app: mongo-express
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongo-express
  template:
    metadata:
      labels:
        app: mongo-express
    spec:
      containers:
      - name: mongo-express
        image: mongo-express
        ports:
          - containerPort: 8081
        env:
          - name: ME_CONFIG_MONGODB_ADMINUSERNAME
            valueFrom:
              secretKeyRef: 
                name: mongodb-secret
                key: root-username
          - name: ME_CONFIG_MONGODB_ADMINPASSWORD
            valueFrom:
              secretKeyRef: 
                name: mongodb-secret
                key: root-username
          - name: ME_CONFIG_MONGODB_SERVER  
            valueFrom:
              configMapKeyRef:
                name: mongodb-configmap
                key: database_url

---
apiVersion: v1
kind: Service
metadata:
  name: mongo-express-service
spec:
  selector:
    app: mongo-express
  type: LoadBalancer
  ports:
    - protocol: TCP
      port: 8081
      targetPort: 8081
      nodePort: 30000
</code></pre>
<p>mongodb-configmap.yaml</p>
<pre><code class="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-configmap
data:
  database_url: mongodb-service
</code></pre>
<p>mongodb-secret.yaml</p>
<pre><code class="shell">apiVersion: v1
kind: Secret
metadata:
  name: mongodb-secret
type: Opaque
data:
  root-username: bW9uZ28=
  root-password: bW9uZ28=
</code></pre>
<h2 id="network-realization"><a href="#network-realization" class="headerlink" title="network realization"></a>network realization</h2><p><strong>resource link:</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kristenjacobs/container-networking">https://github.com/kristenjacobs/container-networking</a></p>
<p><a target="_blank" rel="noopener" href="https://static.sched.com/hosted_files/kccna18/c1/slides.pdf">https://static.sched.com/hosted_files/kccna18/c1/slides.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=6v_BDHIgOY8">https://www.youtube.com/watch?v=6v_BDHIgOY8</a></p>
<h3 id="communication-between-network-namespaces"><a href="#communication-between-network-namespaces" class="headerlink" title="communication between network namespaces"></a>communication between network namespaces</h3><p><em><strong>each network namespace has its own network stack, they cannot communicate with each other directly</strong></em></p>
<hr>
<p><em><strong>pod is the group of containers, all the containers in a pod share the same network  stack, owns one ip and localhost address</strong></em></p>
<p>so, how can we resolve the problem that host machine(root  namespace) communicates with container /pod (another new created namespace)?</p>
<p>and the answer is <strong>veth pair</strong>(virtual network device), with veth pair two network namespaces can be connected together. packet can flow between the two ethernet interfaces. </p>
<p>in this example, i will use one network namespace instaead of a pod’s or containers’ network stack.</p>
<blockquote>
<p>Note:</p>
<ul>
<li><p>via virtual network technology, eth1-1 is the same as veth1</p>
</li>
<li><p>host(eth0) can ping each container network, but reverse cannot. because all namespace transparency to host </p>
</li>
</ul>
</blockquote>
<p><img src=".images/kubernetes-single-netns.png"></p>
<pre><code class="shell">pod_namespace=cont1
pod_interface=eth1-1
pod_ip=10.10.0.11
vpair=veth1

# create network namespace
sudo ip netns add $&#123;pod_namespace&#125;

# create veth pairs in host root namespace
sudo ip link add $&#123;vpair&#125; type veth peer name $&#123;pod_interface&#125;

# add interface to new network namespace
sudo ip link set $&#123;pod_interface&#125; netns $&#123;pod_namespace&#125;

# add ip address for new interface
sudo ip netns exec $&#123;pod_namespace&#125; ip addr add $&#123;pod_ip&#125;/24 dev $&#123;pod_interface&#125;

# start new namespace loopback up
sudo ip netns exec $&#123;pod_namespace&#125; ip link set lo up

# start new namespace ethernet up
sudo ip netns exec $&#123;pod_namespace&#125; ip link set dev $&#123;pod_interface&#125; up

# start root namespace vpair interface up
sudo ip link set dev $&#123;vpair&#125; up

# add default route for new namespace via ethernet interface
sudo ip netns exec $&#123;pod_namespace&#125; ip route add default via $&#123;pod_ip&#125; dev $&#123;pod_interface&#125;

# add route for root namespace vpair interface
sudo ip route add $&#123;pod_ip&#125; dev $&#123;vpair&#125;

# ping new namespace ethernet ip address in host
ping -c 2 $&#123;pod_ip&#125;
</code></pre>
<h3 id="communication-between-pods"><a href="#communication-between-pods" class="headerlink" title="communication between pods"></a>communication between pods</h3><p>above veth pair can resolve the problem of two network namespaces communication, but not two pods, for there are lots of pods in kubernetes node, we cannot establish veth pairs for each two pods. </p>
<p>and the bridge network device can resolve this problem, a bridge has its own ip address and route table, so pod can communication with each other once they connect to the bridge, it acts just like a router(switch). another benefit of bridge is that bridge device and the host net device are in the same root namespace, both have ip address, so they can communicate directly.</p>
<blockquote>
<p>Note:</p>
<ul>
<li>via bridge network technology, eth1-1 and eth2-2 can ping each other</li>
<li>eth1-1 can ping host eth0, because br0 and eth0 both in the same root namespace</li>
</ul>
</blockquote>
<p><img src=".images/kubernetes-bridge-net.png"></p>
<pre><code class="shell">pod1_namespace=cont1
pod1_interface=eth1-1
pod1_ip=10.10.0.11
vpair1=veth1

bridge_interface=br0
bridge_ip=10.10.0.1

pod2_namespace=cont2
pod2_interface=eth2-2
pod2_ip=10.10.0.22
vpair2=veth2


# create network namespace
sudo ip netns add $&#123;pod1_namespace&#125;
sudo ip netns add $&#123;pod2_namespace&#125;

# create veth pairs in host root namespace
sudo ip link add $&#123;vpair1&#125; type veth peer name $&#123;pod1_interface&#125;
sudo ip link add $&#123;vpair2&#125; type veth peer name $&#123;pod2_interface&#125;

# add interface to new network namespace
sudo ip link set $&#123;pod1_interface&#125; netns $&#123;pod1_namespace&#125;
sudo ip link set $&#123;pod2_interface&#125; netns $&#123;pod2_namespace&#125;

# add ip address for new interface
sudo ip netns exec $&#123;pod1_namespace&#125; ip addr add $&#123;pod1_ip&#125;/24 dev $&#123;pod1_interface&#125;
sudo ip netns exec $&#123;pod2_namespace&#125; ip addr add $&#123;pod2_ip&#125;/24 dev $&#123;pod2_interface&#125;

# start new namespace loopback up
sudo ip netns exec $&#123;pod1_namespace&#125; ip link set lo up
sudo ip netns exec $&#123;pod2_namespace&#125; ip link set lo up

# start new namespace ethernet up
sudo ip netns exec $&#123;pod1_namespace&#125; ip link set dev $&#123;pod1_interface&#125; up
sudo ip netns exec $&#123;pod2_namespace&#125; ip link set dev $&#123;pod2_interface&#125; up

# start root namespace vpair interface up
sudo ip link set dev $&#123;vpair1&#125; up
sudo ip link set dev $&#123;vpair2&#125; up

# create a bridge
sudo ip link add name $&#123;bridge_interface&#125; type bridge

# assign a IP address to the bridge
sudo ip addr add $&#123;bridge_ip&#125;/24 dev $&#123;bridge_interface&#125;

# add two veth pair interface to bridge
sudo ip link set dev $&#123;vpair1&#125; master $&#123;bridge_interface&#125;
sudo ip link set dev $&#123;vpair2&#125; master $&#123;bridge_interface&#125;

# start the bridge up
sudo ip link set dev $&#123;bridge_interface&#125; up

# add the default route in two network namespaces
sudo ip netns exec $&#123;pod1_namespace&#125; ip route add default via $&#123;bridge_ip&#125; dev $&#123;pod1_interface&#125;
sudo ip netns exec $&#123;pod2_namespace&#125; ip route add default via $&#123;bridge_ip&#125; dev $&#123;pod2_interface&#125;

# two containers ping each other
ip netns exec $&#123;pod1_namespace&#125; ping -c 3 $&#123;pod2_ip&#125;
ip netns exec $&#123;pod2_namespace&#125; ping -c 3 $&#123;pod1_ip&#125;
</code></pre>
<h3 id="communication-between-nodes-with-different-subnet"><a href="#communication-between-nodes-with-different-subnet" class="headerlink" title="communication between nodes with different subnet"></a>communication between nodes with different subnet</h3><p>with veth pair and bridge network technology, the container can reach host network and other pod’s network in one node. so communication in two nodes, the only thing we need to do is assigning a route table.</p>
<p>run script in one node. node ip is <code>192.168.31.100/24</code> and ether interface is <code>eth0</code></p>
<blockquote>
<p>Note:</p>
<ul>
<li>container network can reach the host point already, we only need to specify each node to other node’s route table</li>
</ul>
</blockquote>
<p><img src=".images/kubernetes-multi-nodes.png"></p>
<pre><code class="shell">pod1_namespace=cont1
pod1_interface=eth1-1
pod1_ip=10.10.0.11
vpair1=veth1

bridge_interface=br0
bridge_ip=10.10.0.1

pod2_namespace=cont2
pod2_interface=eth2-2
pod2_ip=10.10.0.22
vpair2=veth2


# create network namespace
sudo ip netns add $&#123;pod1_namespace&#125;
sudo ip netns add $&#123;pod2_namespace&#125;

# create veth pairs in host root namespace
sudo ip link add $&#123;vpair1&#125; type veth peer name $&#123;pod1_interface&#125;
sudo ip link add $&#123;vpair2&#125; type veth peer name $&#123;pod2_interface&#125;

# add interface to new network namespace
sudo ip link set $&#123;pod1_interface&#125; netns $&#123;pod1_namespace&#125;
sudo ip link set $&#123;pod2_interface&#125; netns $&#123;pod2_namespace&#125;

# add ip address for new interface
sudo ip netns exec $&#123;pod1_namespace&#125; ip addr add $&#123;pod1_ip&#125;/24 dev $&#123;pod1_interface&#125;
sudo ip netns exec $&#123;pod2_namespace&#125; ip addr add $&#123;pod2_ip&#125;/24 dev $&#123;pod2_interface&#125;

# start new namespace loopback up
sudo ip netns exec $&#123;pod1_namespace&#125; ip link set lo up
sudo ip netns exec $&#123;pod2_namespace&#125; ip link set lo up

# start new namespace ethernet up
sudo ip netns exec $&#123;pod1_namespace&#125; ip link set dev $&#123;pod1_interface&#125; up
sudo ip netns exec $&#123;pod2_namespace&#125; ip link set dev $&#123;pod2_interface&#125; up

# start root namespace vpair interface up
sudo ip link set dev $&#123;vpair1&#125; up
sudo ip link set dev $&#123;vpair2&#125; up

# create a bridge
sudo ip link add name $&#123;bridge_interface&#125; type bridge

# assign a IP address to the bridge
sudo ip addr add $&#123;bridge_ip&#125;/24 dev $&#123;bridge_interface&#125;

# add two veth pair interface to bridge
sudo ip link set dev $&#123;vpair1&#125; master $&#123;bridge_interface&#125;
sudo ip link set dev $&#123;vpair2&#125; master $&#123;bridge_interface&#125;

# start the bridge up
sudo ip link set dev $&#123;bridge_interface&#125; up

# add the default route in two network namespaces
sudo ip netns exec $&#123;pod1_namespace&#125; ip route add default via $&#123;bridge_ip&#125; dev $&#123;pod1_interface&#125;
sudo ip netns exec $&#123;pod2_namespace&#125; ip route add default via $&#123;bridge_ip&#125; dev $&#123;pod2_interface&#125;

# two containers ping each other
ip netns exec $&#123;pod1_namespace&#125; ping -c 3 $&#123;pod2_ip&#125;
ip netns exec $&#123;pod2_namespace&#125; ping -c 3 $&#123;pod1_ip&#125;

######################################## above almost the same ############################################################
# add route to another node&#39;s bridge
sudo ip route add 10.10.1.0/24 via 192.168.31.200 dev eth0
sudo sysctl -w net.ipv4.ip_forward=1

# test 
ip netns exec $&#123;pod1_namespace&#125; ping -c 3 10.10.1.11
</code></pre>
<p>run script in another node, node ip is <code>192.168.31.200/24</code> and ether interface is <code>eth0</code></p>
<pre><code class="shell">pod1_namespace=cont1
pod1_interface=eth1-1
pod1_ip=10.10.1.11
vpair1=veth1

bridge_interface=br0
bridge_ip=10.10.1.1

pod2_namespace=cont2
pod2_interface=eth2-2
pod2_ip=10.10.1.22
vpair2=veth2


# create network namespace
sudo ip netns add $&#123;pod1_namespace&#125;
sudo ip netns add $&#123;pod2_namespace&#125;

# create veth pairs in host root namespace
sudo ip link add $&#123;vpair1&#125; type veth peer name $&#123;pod1_interface&#125;
sudo ip link add $&#123;vpair2&#125; type veth peer name $&#123;pod2_interface&#125;

# add interface to new network namespace
sudo ip link set $&#123;pod1_interface&#125; netns $&#123;pod1_namespace&#125;
sudo ip link set $&#123;pod2_interface&#125; netns $&#123;pod2_namespace&#125;

# add ip address for new interface
sudo ip netns exec $&#123;pod1_namespace&#125; ip addr add $&#123;pod1_ip&#125;/24 dev $&#123;pod1_interface&#125;
sudo ip netns exec $&#123;pod2_namespace&#125; ip addr add $&#123;pod2_ip&#125;/24 dev $&#123;pod2_interface&#125;

# start new namespace loopback up
sudo ip netns exec $&#123;pod1_namespace&#125; ip link set lo up
sudo ip netns exec $&#123;pod2_namespace&#125; ip link set lo up

# start new namespace ethernet up
sudo ip netns exec $&#123;pod1_namespace&#125; ip link set dev $&#123;pod1_interface&#125; up
sudo ip netns exec $&#123;pod2_namespace&#125; ip link set dev $&#123;pod2_interface&#125; up

# start root namespace vpair interface up
sudo ip link set dev $&#123;vpair1&#125; up
sudo ip link set dev $&#123;vpair2&#125; up

# create a bridge
sudo ip link add name $&#123;bridge_interface&#125; type bridge

# assign a IP address to the bridge
sudo ip addr add $&#123;bridge_ip&#125;/24 dev $&#123;bridge_interface&#125;

# add two veth pair interface to bridge
sudo ip link set dev $&#123;vpair1&#125; master $&#123;bridge_interface&#125;
sudo ip link set dev $&#123;vpair2&#125; master $&#123;bridge_interface&#125;

# start the bridge up
sudo ip link set dev $&#123;bridge_interface&#125; up

# add the default route in two network namespaces
sudo ip netns exec $&#123;pod1_namespace&#125; ip route add default via $&#123;bridge_ip&#125; dev $&#123;pod1_interface&#125;
sudo ip netns exec $&#123;pod2_namespace&#125; ip route add default via $&#123;bridge_ip&#125; dev $&#123;pod2_interface&#125;

# two containers ping each other
ip netns exec $&#123;pod1_namespace&#125; ping -c 3 $&#123;pod2_ip&#125;
ip netns exec $&#123;pod2_namespace&#125; ping -c 3 $&#123;pod1_ip&#125;

######################################## above almost the same ############################################################
# add route to another node&#39;s bridge
sudo ip route add 10.10.0.0/24 via 192.168.31.100 dev eth0
sudo sysctl -w net.ipv4.ip_forward=1

# test
ip netns exec $&#123;pod1_namespace&#125; ping -c 3 10.10.0.11
</code></pre>
<blockquote>
<p>Note:</p>
<ul>
<li>it is a huge work if there are hundreds of nodes, so instead of manually configure, there are lots of CNI plugin for us to choose. such as flannel, calico…</li>
</ul>
</blockquote>
<p><img src=".images/kubernetes-cni-net.png"></p>

  </div>
  <div id="gitalk-container"></div>
</div>

<script>
  
Fancybox.bind('[data-fancybox="fancybox-gallery-img"]', {
  dragToClose: true,
  Toolbar: true,
  closeButton: "top",
  Image: {
    zoom: true,
  },
  on: {
    initCarousel: (fancybox) => {
      const slide = fancybox.Carousel.slides[fancybox.Carousel.page];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
    "Carousel.change": (fancybox, carousel, to, from) => {
      const slide = carousel.slides[to];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
  },
});
</script>

<style>
    #noneimg img {
        display: none;
        z-index: 9999;
        /* width: 600px !important; */
        min-width: 0%;
        max-width: 90%;
        max-height: 80%;
        border-radius: 0px;
        position: fixed;
        box-shadow: 0 0 0px #c3c3c300 !important;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        margin: auto !important;
    }

    @media screen and (max-width:600px) {
        #noneimg img {
            max-width: 88%
        }
    }
</style>

    <div class="post-paging">
    
    <a href="/2022/04/23/noResponseGrub/">
        <div class="post-paging-last">
            <span>上一篇</span>
            <p>noResponseGrub</p>
        </div>
    </a>
    

    
    <a href="/2022/04/23/k8s/">
        <div class="post-paging-next">
            <span>下一篇</span>
            <p>k8s</p>
        </div>
    </a>
    
</div>
</div>
		
<div class="footer">
	<div class="Copyright">
		©2022 By Joey. 主题：<a
			style="text-decoration: none;display: contents; color: #898F9F;"
			target="_blank" rel="noopener" href="https://github.com/79e/hexo-theme-quiet">Quiet</a>
	</div>
	<div class="contact">
		
		<a target="_blank" rel="noopener" href="https://github.com/79E/hexo-theme-quiet">
			<img src="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quiet主题">
		</a>
		
	</div>
</div>

<script src="/js/gotop.js"></script>


<style type="text/css">
    @media screen and (min-width: 600px) {
        .goTop>span {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            opacity: 0.8;
            background: rgba(18, 24, 58, 0.06);
            text-align: center;
            transition: border .5s;
            border: 1px solid rgba(18, 24, 58, 0.06);

            -moz-transition: border .5s;
            /* Firefox 4 */
            -webkit-transition: border .5s;
            /* Safari 和 Chrome */
            -o-transition: border .5s;
            /* Opera */
        }

        .goTop>span:hover {
            border: 1px solid #6680B3;
        }


        .goTop {
            position: fixed;
            right: 30px;
            bottom: 80px;
        }

        .goTop>span>svg {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }

    }

    @media screen and (max-width: 600px) {
        .goTop {
            display: none;
        }
    }
</style>
<div class="goTop" id="js-go_top">
    <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <g>
                <path d="M13 12v8h-2v-8H4l8-8 8 8z"></path>
            </g>
        </svg>
    </span>
</div>
<script>
    $( '#js-go_top' )
	.gotoTop( {
		offset: 500,
		speed: 300,
		animationShow: {
			'transform': 'translate(0,0)',
			'transition': 'transform .5s ease-in-out'
		},
		animationHide: {
			'transform': 'translate(100px,0)',
			'transition': 'transform .5s ease-in-out'
		}
	} );
</script>


    <!-- Gitalk -->
    <script>
        const data = '{"clientID":"02b3c","clientSecret":"adfc7b4","repo":"gimment","owner":"duneng","admin":"duneng"}'
        const gitalk = new Gitalk({
            ...JSON.parse( data),
            id:location.pathname,
            distractionFreeMode:false
        })
        
        if(Boolean('true')){
            gitalk.render('gitalk-container')
        }
    </script>

<script>
	console.log('\n %c Hexo-Quiet 主题 %c https://github.com/79e/hexo-theme-quiet \n', 'color: #fadfa3; background: #030307; padding:5px 0;', 'background: #fadfa3; padding:5px 0;')
</script>
	</body>
</html>

