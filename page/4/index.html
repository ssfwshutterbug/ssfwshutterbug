<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>shutterbug sweet diary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="shutterbug sweet diary">
<meta property="og:url" content="https://raw.githubusercontent.com/ssfwshutterbug/ssfwshutterbug.github.io/main/page/4/index.html">
<meta property="og:site_name" content="shutterbug sweet diary">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="shutterbug">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="shutterbug sweet diary" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">shutterbug sweet diary</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://raw.githubusercontent.com/ssfwshutterbug/ssfwshutterbug.github.io/main"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-python" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/04/23/python/" class="article-date">
  <time datetime="2022-04-23T15:09:35.000Z" itemprop="datePublished">2022-04-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/learn/">learn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/23/python/">python</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="PYTHON"><a href="#PYTHON" class="headerlink" title="PYTHON"></a>PYTHON</h1><p>python is a dynamic language, very powerful, useful and simple to use.</p>
<h2 id="python-interpreter"><a href="#python-interpreter" class="headerlink" title="python interpreter"></a>python interpreter</h2><p>because python is a dynamic language, a interpreter is needed for using. there are two ways to install python interpreter:</p>
<ol>
<li><p>install from  source code, this way need compiling,  and it is complex, download <a target="_blank" rel="noopener" href="https://www.python.org/downloads/">in official website</a>, uncompress then compile</p>
<pre><code class="shell">./configure
make
make test
sudo make install
</code></pre>
</li>
<li><p>if we use linux distribution, it is easy to download with package manager.</p>
<pre><code class="shell"># such as in archlinux
pacman -S python
</code></pre>
</li>
</ol>
<p>after installing, check it’s version</p>
<pre><code class="shell">python --version
</code></pre>
<h2 id="pip"><a href="#pip" class="headerlink" title="pip"></a>pip</h2><p>what is pip? it is a package manager of python module. let’s install it.</p>
<p><strong>install</strong></p>
<p>note that there are two pip package available,</p>
<ul>
<li>pip2: this is used for python2</li>
<li>pip3:  this is used for python3</li>
</ul>
<p>so, which one should we choose depend on which python version we use.</p>
<pre><code class="shell">python --version
</code></pre>
<p>in centos:</p>
<pre><code class="shell"># epel repo needed
yum install epel-release
yum install python2-pip
</code></pre>
<p>in archlinux:</p>
<pre><code class="shell">pacman -S python-pip
</code></pre>
<p><strong>repo config</strong></p>
<p>in defalut, download speed is very slow. we need to modify mirror configuration</p>
<pre><code class="shell">pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre>
<p>the command will change mirror to tnua, and we can find the config in <code>~/.config/pip/pip.conf</code></p>
<p><strong>module location</strong></p>
<p>command to find the default position</p>
<pre><code class="shell">python -m site
</code></pre>
<p>be careful the <code>USER_SITE</code> value, it stores the package location pip installed</p>
<p>now let us to see where is the config file</p>
<pre><code class="shell">python -m site --help
</code></pre>
<p>the config file is <code>/usr/lib/python3.8/site.py</code></p>
<p>then we can change the default value to any other site you want, such as</p>
<pre><code>USER_SITE = &quot;/home/narcissus/Software/python_lib&quot;
</code></pre>
<p>from now on, we use pip command install packages, they will be stored in customized position</p>
<p>example:</p>
<pre><code class="shell">pip install pandas --user
</code></pre>
<h2 id="代码风格"><a href="#代码风格" class="headerlink" title="代码风格"></a>代码风格</h2><ul>
<li><p>python代码的一个很明显的特点就是缩进。代码块是通过缩进来组织的，代码块使用冒号<code>:</code>来标识</p>
</li>
<li><p>单行注释使用<code>#</code></p>
<pre><code class="python"># 单行注释
</code></pre>
</li>
<li><p>多行注释使用<code>&quot;&quot;&quot; &quot;&quot;&quot;</code></p>
<pre><code class="python">&quot;&quot;&quot;
多行
注释
&quot;&quot;&quot;
</code></pre>
</li>
<li><p>一行代码拆分多行使用<code>\</code></p>
<pre><code class="python">user = &#123;&quot;name&quot;:&quot;snippet&quot;,\
      &quot;age&quot;:&quot;12&quot;,\
      &quot;gender&quot;:&quot;male&quot;
      &#125;
print(user[&quot;age&quot;])
</code></pre>
</li>
<li><p>命名规范</p>
<ul>
<li><p>类命名：<br>使用大驼峰的规范，即每个单词都以大写字母开头</p>
<pre><code class="python">class UserInfo():
  name = &quot;python&quot;
</code></pre>
</li>
<li><p>变量命名：</p>
<ol>
<li>第一种：小驼峰，即第一个单词小写开头，其余字母大写开头<pre><code class="python">baiduUrl = &quot;https://www.baidu.com&quot;
</code></pre>
</li>
<li>第二种：所有字母全部小写，并用<code>_</code>连接，我比较喜欢这个<pre><code class="python">baidu_url = &quot;https://www.baidu.com&quot;
</code></pre>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><h3 id="作用："><a href="#作用：" class="headerlink" title="作用："></a>作用：</h3><ul>
<li>变量是一个字符串，用来保存数据的内存地址，指向内存中数据Data的位置。</li>
<li>变量所保存的内存地址可以被改变，所以变量可变</li>
<li>如果在程序中多处都要使用到这个数据，那么使用变量则可以只修改一个地方就行</li>
</ul>
<h3 id="赋值："><a href="#赋值：" class="headerlink" title="赋值："></a>赋值：</h3><ul>
<li><p>由于python是解释型语言，所以在声明变量时，不需要指定变量的类型</p>
<pre><code class="python">name = &quot;xiaotianquan&quot;
</code></pre>
</li>
<li><p>还可以一次性赋值多个</p>
<pre><code class="python">name,age,like = &quot;gou&quot;,2,&quot;food&quot;
print(name,age,like)
</code></pre>
</li>
</ul>
<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p>直接写变量名即可</p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><h3 id="标准数据类型："><a href="#标准数据类型：" class="headerlink" title="标准数据类型："></a>标准数据类型：</h3><ol>
<li><p>数字</p>
<p> 直接写数字，不加引号，加了引号作为字符串</p>
<pre><code class="python">age = 3
</code></pre>
</li>
<li><p>字符串 str</p>
<p> 用引号括起来的作为字符串，可以使用单引号和双引号<br> 这两种没有区别，因为没有变量置换（shell和perl中）这种操作，它使用的是拼接</p>
</li>
<li><p>布尔 True/False</p>
<p> 在python中，布尔值也可以作为数字使用<br> True = 1, False = 0</p>
<pre><code class="python">age = 3
print(age+True)
</code></pre>
</li>
<li><p>列表 list</p>
<p> 用<code>[]</code>表示，可以存储不同类型的数据</p>
<pre><code class="python">data = [1,2,3,4,5,6,7,&quot;a&quot;,&quot;b&quot;]
print(data)
</code></pre>
<p> 切片操作</p>
<ul>
<li>使用<code>:</code>，取出指定范围的数据，可以使用函数<code>id()</code>查看取出数据的内存地址<pre><code class="python">list[start_index:end_index:step]
</code></pre>
```python<br>data1 = [1,2,3,4]</li>
</ul>
<h1 id="作用为复制列表，使用频率高，有效的避免对原数组数据造成破坏"><a href="#作用为复制列表，使用频率高，有效的避免对原数组数据造成破坏" class="headerlink" title="作用为复制列表，使用频率高，有效的避免对原数组数据造成破坏"></a>作用为复制列表，使用频率高，有效的避免对原数组数据造成破坏</h1><p> data2 = data1[:]</p>
<h1 id="内存地址不同"><a href="#内存地址不同" class="headerlink" title="内存地址不同"></a>内存地址不同</h1><p> print(id(data1),id(data2))</p>
<h1 id="与data-作用相同，-1为最后一个元素的索引"><a href="#与data-作用相同，-1为最后一个元素的索引" class="headerlink" title="与data[:]作用相同，-1为最后一个元素的索引"></a>与data[:]作用相同，-1为最后一个元素的索引</h1><p> data3 = data1[0:-1]</p>
<h1 id="指定位置-前闭后开"><a href="#指定位置-前闭后开" class="headerlink" title="指定位置,前闭后开[)"></a>指定位置,前闭后开[)</h1><p> data4 = data1[0:2]</p>
<h1 id="指定步幅"><a href="#指定步幅" class="headerlink" title="指定步幅"></a>指定步幅</h1><p> data4 = data1[::2]</p>
<h1 id="逆序"><a href="#逆序" class="headerlink" title="逆序"></a>逆序</h1><p> data8 = data1[-1::-1]</p>
<h1 id="负数索引"><a href="#负数索引" class="headerlink" title="负数索引"></a>负数索引</h1><p> data5 = data1[-3:-1]</p>
<pre><code>
其它
```python
# 删除指定元素
data6 = data1.remove(2)

# 从后往前取出数据（删除）
data7 = data1.pop()

# 乘
data9 = data1 * 2

# 列表生成式
data10 = [ i for i in range(1,10) ]

# 嵌套
data11 = [data,data10]

# 循环取出嵌套数据
for i in data11:
    for j in i:
        print(j)
    
# 如果嵌套的两个list元素个数一致，可以使用一层嵌套即可取出所有值
la = [1,2,3,4]
lb = [&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;]
lc = [la,lb]
for i,j,k,l in lc:
    print(i,j,k,l)

# 查看list元素个数
len(data)

# 全部为数字时，可以取最大值，最小值
max(la)
min(la)

# 查看某个元素存在多少个
la.count(1)
</code></pre>
</li>
<li><p>元组 tuple</p>
<p> 使用<code>()</code>，为一个不可修改列表，大部分用法与list一致</p>
<pre><code class="python">data = (1,2,3,4,&quot;a&quot;,&quot;b&quot;)

# 创建一个只有一个元素的tuple，后面需要一个逗号
data = (1,)
print(type(data))

# 可以不加括号
data = 1,
print(type(data))
data = 1,2,3,4
print(type(data))

# 创建空的tuple
data = tuple()
data = ()

# 通过list创建tuple
mylist = [i for i in range(1,9)]
data = tuple(mylist)

# tuple的特殊用法，两个元素交换
a = 1
b = 2
a,b = b,a
</code></pre>
</li>
<li><p>集合 set</p>
<ul>
<li><p>数据有序，而且不可重复,具有取出重复的作用</p>
</li>
<li><p>通过list和tuple来生成集合</p>
<pre><code class="python">a = [1,2,3,4,2,1,3]
b = set(a)
print(type(b))
print(b)
</code></pre>
</li>
<li><p>通过<code>&#123;&#125;</code>来定义集合</p>
<pre><code class="python">a = &#123;1,2,2,5,3,4&#125;
print(type(a))
</code></pre>
</li>
<li><p>集合没有索引，只能for循环取出元素</p>
<pre><code class="python">a = &#123;i**2 for i in range(1,10)&#125;
for i in a:
  print(i)
</code></pre>
</li>
<li><p>集合运算</p>
<pre><code class="python">a = &#123;i for i in range(1,5)&#125;
b = &#123;i for i in range(3,7)&#125;
# 交集
c = a.intersection(b)
# 并集
d = a.union(b)
# 差集
e = a.difference(b)
</code></pre>
</li>
<li><p>让集合不可修改</p>
<pre><code class="python">a = &#123; i for i in range(1,5)&#125;
b = frozenset(a)
</code></pre>
</li>
</ul>
<p> 其它 </p>
<pre><code class="python"># 生成奇数、偶数集合
a = &#123;i for i in range(1,10) if i % 2 == 0&#125;
b = &#123;i for i in range(1,10) if i % 2 != 0&#125;

# 删除集合中的数，如果不存在则会报错
sa = &#123;i for i in range(1,10)&#125;
sa.remove(1)

# 删除集合中的数，如果不存在不会报错
sa.discard(11)

# 集合中也有pop函数，但是是随机的
sa.pop()
</code></pre>
</li>
<li><p>字典 dict</p>
<p> 输入字典数，以及字典数据，进行去重（相同key值相加），排序</p>
<pre><code class="python">num = int(input())
lt = &#123;&#125;

for i in range(num):
    # map可同时设置数据类型
    a,b = map(int, input().split())
    if a in lt.keys():
        lt[a] += b
    else:
        lt[a] = b
# sorted可对字典进行排序，key可以使用lambda来指定使用key或者value排序
lt = sorted(lt.items(), key=lambda a: a)
for i in lt:
    print(i[0], i[1])
</code></pre>
</li>
</ol>
<h3 id="数据类型嵌套-对象"><a href="#数据类型嵌套-对象" class="headerlink" title="数据类型嵌套-对象"></a>数据类型嵌套-对象</h3><p>在list，tuple，set，dict中均可以存储对象</p>
<pre><code class="python">class User():
    name = &quot;ls&quot;
    age = 21
user = User()

a = [user]
b = (user,)
c = &#123;user&#125;
d = &#123;&quot;obj&quot;:user&#125;

print(type(a),type(b),type(c),type(d))
print(a[0].name,b[0].name,d[&quot;obj&quot;].name)
for i in c:
    print(i.name,i.age)
</code></pre>
<h1 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h1><ul>
<li>算数运算符</li>
<li>关系运算符</li>
<li>赋值运算符</li>
<li>逻辑运算符</li>
<li>位运算</li>
<li>成员运算符</li>
<li>身份运算符</li>
</ul>
<h2 id="算数运算符"><a href="#算数运算符" class="headerlink" title="算数运算符"></a>算数运算符</h2><ul>
<li>python没有自增自减运算符</li>
<li>包括：<ul>
<li>加 <code>+</code></li>
<li>减 <code>-</code></li>
<li>乘 <code>*</code></li>
<li>除<ul>
<li>普通除法 <code>/</code></li>
<li>取余 <code>%</code></li>
<li>取整 <code>//</code></li>
</ul>
</li>
</ul>
</li>
<li>所有运算符都可以使用运算赋值的缩写：<br>  <code>+=</code>，<code>-=</code>，<code>*=</code>,<code>/=</code>,<code>%=</code>,<code>//=</code><pre><code class="python">a = 1
a += 1
print(a)
</code></pre>
  已经有运算赋值这两个操作了，所以不能再赋值</li>
</ul>
<h2 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h2><p>比较运算的结果一定为一个布尔值：True/False</p>
<ul>
<li>等于 <code>==</code></li>
<li>不等于 <code>!=</code><pre><code class="python">print(3!=4)
</code></pre>
</li>
<li>其它<ul>
<li><code>&gt;</code></li>
<li><code>&gt;=</code></li>
<li><code>&lt;</code></li>
<li><code>&lt;=</code></li>
</ul>
</li>
</ul>
<h2 id="赋值运算符"><a href="#赋值运算符" class="headerlink" title="赋值运算符"></a>赋值运算符</h2><p>使用等号来赋值<code>=</code>，将数据data赋值给变量</p>
<h2 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h2><p>返回结果为True/False</p>
<ul>
<li>and</li>
<li>or</li>
<li>not</li>
</ul>
<pre><code class="python">a = 1
if a == 3 or a == 2 :
    print(&quot;true&quot;)
else:
    print(&quot;false&quot;)
</code></pre>
<h2 id="成员运算符"><a href="#成员运算符" class="headerlink" title="成员运算符"></a>成员运算符</h2><p>用来检测一个值或者变量是否在一个集合中,返回结果为True/False</p>
<ul>
<li>in</li>
<li>not in<pre><code class="python">a = 1
b = [i for i in range(1,5)]
c = a in b
d = a not in b
print(c,d)
</code></pre>
</li>
</ul>
<h2 id="身份运算符"><a href="#身份运算符" class="headerlink" title="身份运算符"></a>身份运算符</h2><p>用来判断两个变量是否一致,返回结果为True/False</p>
<ul>
<li>is</li>
<li>is not<pre><code class="python">a = 1
b = 1
c = 2
print(a is b)
print(a is c)
print(a is not c)
</code></pre>
</li>
</ul>
<h1 id="程序结构"><a href="#程序结构" class="headerlink" title="程序结构"></a>程序结构</h1><ul>
<li>顺序<br>  程序从上到下依次执行</li>
<li>循环<br>  <code>for</code><br>  <code>while</code></li>
<li>分支<br>  <code>if</code></li>
</ul>
<h2 id="分支结构"><a href="#分支结构" class="headerlink" title="分支结构"></a>分支结构</h2><p><em>这里的条件表达式只要是返回结果为True/False即可</em></p>
<pre><code class="python">if 条件表达式:
    语句1
elif 条件表达式:
    语句2
else:
    语句3
</code></pre>
<p>举例1：</p>
<pre><code class="python">user = input(&quot;type your name: &quot;)
if user == &quot;root&quot;:
    print(&quot;you are the admin&quot;)
elif user == &quot;narcissus&quot;:
    print(&quot;you are the normal user&quot;)
else:
    print(&quot;you are the user not in group sudo&quot;)
</code></pre>
<p>举例2：空字符串为假</p>
<pre><code class="python">if &quot;&quot;:
    print(&quot;true&quot;)
else:
    print(&quot;false&quot;)
</code></pre>
<h2 id="循环结构"><a href="#循环结构" class="headerlink" title="循环结构"></a>循环结构</h2><h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><p><em>用来遍历序列中的所有元素</em></p>
<pre><code class="python">for 变量 in 序列:
    语句
</code></pre>
<p>举例：</p>
<pre><code class="python">for i in range(1,10):
    print(i)
</code></pre>
<ul>
<li>循环中的条件跳转<ul>
<li>break 终止循环</li>
<li>continue 跳过continue后的语句</li>
<li>pass 没有实际作用，用来占位</li>
</ul>
</li>
</ul>
<p>举例：</p>
<pre><code class="python">for i in range(2,20):
    if i % 2 == 0:
        print(str(i) + &quot;能被2整除&quot;)
        continue
    elif i % 3 == 0:
        print(str(i) + &quot;能被3整除&quot;)
        pass
    else:
        break
</code></pre>
<h3 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h3><p>当条件成立时，一直循环。这个条件必须要有终止，否则会形成死循环。</p>
<pre><code class="python">while 条件表达式:
    语句
</code></pre>
<p>举例1：<br>求a，b的最小公约数</p>
<pre><code class="python">a = 2
b = 5
c = 1
while c % a != 0 or c % b != 0:
    c += 1
    print(a,b,c)
</code></pre>
<p>举例2：</p>
<pre><code class="python">i = 1
while i &lt; 3:
    i += 1
    try:
        num =  int(input(&quot;num&quot;))
        a = 5 / num
        print(a)
    except Exception as e:
        print(&quot;输入非零整数&quot;)
</code></pre>
<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><ul>
<li><p>命名<br>一般采用:<code>动词_名词</code>的形式</p>
</li>
<li><p>意义<br>复用代码</p>
</li>
<li><p>定义</p>
<pre><code class="python">def 函数名():
  语句
</code></pre>
</li>
<li><p>调用</p>
<pre><code class="python">函数名()
</code></pre>
</li>
<li><p>举例：</p>
<pre><code class="python">import time
def get_time():
  now = time.strftime(&quot;%Y%m%d-%H:%M:%S&quot;)
  print(now)
get_time()
</code></pre>
</li>
</ul>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><ul>
<li><p>分类方式1：</p>
<ul>
<li><p>形参：在写函数时，括号中的那个参数</p>
<pre><code class="python">def get_name(name):
  print(name)
</code></pre>
</li>
<li><p>实参：在函数调用时括号中传入的参数</p>
<pre><code class="python">get_name(&quot;小舞&quot;)
</code></pre>
</li>
</ul>
</li>
<li><p>分类方式2：</p>
<ul>
<li><p>位置参数：在传参时必须一一对应</p>
<pre><code class="python">def normal(name,age,like):
  print(&quot;&#123;&#125; is &#123;&#125; years old and like &#123;&#125;&quot;.format(name,age,like))
normal(&quot;小舞&quot;,20,&quot;star&quot;)
</code></pre>
</li>
<li><p>关键字参数：在传参时不必一一对应，而是使用参数名来设置参数</p>
<pre><code class="python">def keyword(name,age,like):
  print(&quot;&#123;&#125; is &#123;&#125; years old and like &#123;&#125;&quot;.format(name,age,like))
keyword(age=20, name=&quot;小舞&quot;, like=&quot;star&quot;)
</code></pre>
</li>
<li><p>默认参数: 给参数设置默认值，如果不传则使用默认值，不过默认参数后面不能写位置参数</p>
<pre><code class="python">def default(a,b,c=1):
  print((a + b) / c)
default(1,2)
</code></pre>
</li>
<li><p>收集参数：在不确定会传入参数个数的情况下使用</p>
<ol>
<li>如果后面还有位置参数，那么位置参数会作为关键字参数，而且位置不能变</li>
<li>如果有两个星号，那么表示收集所有参数包括关键字参数<pre><code class="python">def collection(*count):
sum = 0
for i in count:
 sum += i
return sum
collection(1,2,3,4)
</code></pre>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<pre><code>def collection(*count,another=1):
sum = 0
for i in count:
    sum += i
return sum + another
collection(1,2,3,4,another=5)
```

- 分解参数：
    1. 将list和元组作为参数传给函数时
    ```python
    def expend(*args):
        sum = 0 
        for i in args:
            sum += i
        return sum
    a = (i for i in range(1,10))
    b = [i for i in range(1,10)]
    print(expend(*a))
    print(expend(*b))
    ```

    2. 将字典作为参数传给函数时
    ```python
    def expend(**args):
        sum = 0
        for i in args:
            sum += args[i]
        return sum
    c = &#123;&quot;a&quot;:1,&quot;b&quot;:2,&quot;c&quot;:3&#125;
    expend(**c)
    ```
</code></pre>
<h2 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h2><ul>
<li>函数可以有返回值，也可以没有返回值，使用<code>return</code>来返回执行结果</li>
<li>但是在python中还是推荐有返回值，如果没有实际值返回可以返回一个<code>None</code></li>
<li>函数一旦执行return之后函数就会结束，return后面的语句不会执行</li>
</ul>
<p>举例：</p>
<pre><code class="python">def sum(a,b):
    return a + b
a = sum(1,2)
print(a)

c = 1
def plus():
    global c
    c += 1
    return None
# 函数没有返回值，每次调用函数c的值就自增1
plus()
print(c)
</code></pre>
<p>计算九九乘法表：我写的挺复杂</p>
<pre><code class="python">for y in range(1,10):
    x = 1
    while x &lt;= y:
        print(str(x) + &quot;*&quot; + str(y) + &quot;=&quot; + str(x*y) \
        + &quot; &quot;,end=&#39;&#39;)
        x += 1
        if x &gt; y:
            print(end=&quot;\n&quot;)
</code></pre>
<p>简单写法</p>
<pre><code class="python">for y in range(1,10):
    for x in range(1,y+1):
        print(&#39;&#123;&#125;*&#123;&#125;=&#123;&#125;\t&#39;.format(x,y,x*y),end=&quot;&quot;)
    print()
</code></pre>
<p>三角形</p>
<pre><code class="python">for y in range(1,10):
    for x in range(1,10-y):
        print(&quot;   &quot;,end=&quot;&quot;)
    for x in range(1,2*y):
        print(&quot; 1 &quot;,end=&quot;&quot;)
    print()
</code></pre>
<h2 id="递归函数"><a href="#递归函数" class="headerlink" title="递归函数"></a>递归函数</h2><p>函数直接或者间接调用自己，需要有结束条件</p>
<p>优缺点：</p>
<ul>
<li>优点：书写理解简单</li>
<li>缺点：执行速度慢</li>
</ul>
<p>写法：</p>
<ul>
<li><p>结束条件</p>
<pre><code class="python">def plus(num):
  if num == 1:
      return 1
# 这个函数调用时，传入1，得到plus(1) = 1
# 不能这么写，这么写是错误的
def plus(num):
  plus(1) = 1
</code></pre>
</li>
<li><p>返回自己</p>
<pre><code class="python">def plus(num):
  if num == 1:
      return 1
  return num + plus(num-1)
plus(100)
</code></pre>
</li>
<li><p>举例：斐波拉契数列</p>
</li>
</ul>
<p>普通写法</p>
<pre><code class="python"># 1, 1, 2, 3, 5, 8, 13.....
def fun(num):
    a = b = i = 1
    sum = 1 if num == 1 else 2
    while i &lt; num-1:
        a,b = b,a+b
        i += 1
        sum = sum + b 
    print(&quot;第&#123;&#125;个斐波拉契数为：&#123;&#125;，总数为：&#123;&#125;&quot;.format(num,b,sum)) 
fun(3)
</code></pre>
<p>使用递归写法</p>
<pre><code class="python"># 1, 1, 2, 3, 5, 8, 13.....
def fib(num):
    if num == 1 or num == 2:
        return 1
    return fib(num-1) + fib(num-2)

def fib_list(num):
    for i in range(1,num+1):
        print(fib(i))
fib_list(10)
</code></pre>
<h2 id="尾递归"><a href="#尾递归" class="headerlink" title="尾递归"></a>尾递归</h2><p>对比普通写法和递归的写法，递归函数在调用40次时已经停止调用了，而且在求同一个斐波拉契数的时候，普通写法速度秒杀递归写法。普通写法单线程求第十万个斐波拉契数不到一秒，第一百万个斐波拉契数约六秒。所以递归函数不适合复杂计算</p>
<p>递归函数为什么慢？因为递归函数运行时，每一次调用都会返回一个<code>表达式</code>，不能返回一个确定的值，那么原函数的参数，逻辑结构等这些都不能修改，每次计算机在调用函数时会使用堆栈，每调用一个函数会增加一层栈帧，所以当递归过程多次调用函数的时候可能会导致大小有限的堆栈溢出。优化方式之一是尾递归</p>
<p>为什么尾递归可以优化？尾递归与递归都需要调用自身，看起来没多大区别（我刚开始也没看懂），但是尾递归每次都不是返回的表达式，而是返回的一个函数，至于计算结果，那是通过变量的形式进行传递的，这么做的好处就是不用开新的栈，而是刷新原函数，将参数传递进去就好了。所以做到了优化，但是python中即使是使用了尾递归，次数仍然只能达到999次。并不是真正意义上的尾递归</p>
<p>在很多时候我们都是在刷新变量的值，而并不是重新用一个别的变量</p>
<pre><code class="python">sum = 0
for i in range(1,10):
    sum += i
print(sum)
</code></pre>
<p>尾递归的斐波拉契函数写法：</p>
<pre><code class="python"># 1, 1, 2, 3, 5, 8, 13.....
def fib(num, first=1, second=1, sum=2):
    if num == 2 or num == 1:
        return second,sum
    return fib(num-1, second, first+second, sum+first+second)
fib(7)
</code></pre>
<p>利用三目运算简写</p>
<pre><code class="python">def fib(num, first=1, second=1, sum=2):
    return 1 if num == 1 else(sum  if num == 2 else fib(num-1, second, first+second, sum+first+second))
fib(7)
</code></pre>
<p>通过上面尾递归的写法，可以看出函数调用自身的作用类似于计数，真正计算的过程在参数中。其实类似于普通函数的写法</p>
<h2 id="函数的使用"><a href="#函数的使用" class="headerlink" title="函数的使用"></a>函数的使用</h2><p>在python中一切皆是对象，所以函数也是对象，函数名指向的是代码段的内存地址</p>
<ul>
<li><p>作为元素使用：放在list，tuple，set，dict中</p>
<pre><code class="python">def user():
  print(&quot;hello&quot;)
one = user()
a = [one]
</code></pre>
</li>
<li><p>作为参数传递给函数</p>
</li>
<li><p>可以被赋值</p>
</li>
<li><p>作为函数的返回值</p>
</li>
</ul>
<h1 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h1><p>在linux相关的运维上，有很多都是处理字符串，所以字符串有点重要的</p>
<h2 id="路径问题"><a href="#路径问题" class="headerlink" title="路径问题"></a>路径问题</h2><p>在很多情况下，输入路径需要各种转义才行，为了避免这种麻烦，使用<code>r</code></p>
<pre><code class="python">location = r&#39;c:\user\kite\desktop&#39;
print(location)
</code></pre>
<h2 id="变量替换（字符串拼接、格式化）"><a href="#变量替换（字符串拼接、格式化）" class="headerlink" title="变量替换（字符串拼接、格式化）"></a>变量替换（字符串拼接、格式化）</h2><ul>
<li><p><code>%</code></p>
<pre><code class="python">print(&quot;i like %s and %s&quot;%(&quot;cat&quot;,&quot;dog&quot;))
</code></pre>
</li>
<li><p><code>format</code>函数，使用<code>&#123;&#125;</code></p>
<ul>
<li><p>直接使用</p>
<pre><code class="python">print(&quot;i like &#123;&#125; and &#123;&#125;&quot;.format(&quot;cat&quot;,&quot;dog&quot;))
</code></pre>
</li>
<li><p>使用变量</p>
<pre><code class="python">a = &quot;i like &#123;&#125; and &#123;&#125;&quot;
print(a.format(&quot;cat&quot;,&quot;dog&quot;))
</code></pre>
</li>
<li><p>指定位置</p>
<pre><code class="python">a = &quot;i like &#123;0&#125; and &#123;0&#125; and &#123;1&#125;&quot;
print(a.format(&quot;cat&quot;,&quot;dog&quot;))
</code></pre>
</li>
<li><p>使用命名：</p>
<ul>
<li>我觉得这种还不错，虽然字多了一点，但是很清晰<pre><code class="python">a = &quot;i like &#123;animal&#125; and &#123;animal&#125; and &#123;drink&#125;&quot;
print(a.format(animal=&quot;cat&quot;,drink=&quot;juice&quot;))
</code></pre>
</li>
<li>在传入的参数比较多时，使用字典是最好的,需要使用到参数分解，这个是目前我觉得最好的<pre><code class="python">a = &quot;i like &#123;animal&#125; and &#123;animal&#125; and &#123;drink&#125;&quot;
b = &#123;&quot;animal&quot;:&quot;cat&quot;,&quot;drink&quot;:&quot;juice&quot;&#125;
print(a.format(**b))
</code></pre>
</li>
</ul>
</li>
<li><p>指定数字长度</p>
<pre><code class="python">a = &quot;pi is &#123;:.2f&#125;&quot;
print(a.format(1.1314))
</code></pre>
</li>
</ul>
</li>
</ul>
<h2 id="判断类函数"><a href="#判断类函数" class="headerlink" title="判断类函数"></a>判断类函数</h2><p>函数以<code>is</code>开头，返回值为<code>True</code>/<code>False</code></p>
<h2 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h2><p>字符串的关键字为<code>str</code>，通过str来查看帮助文档</p>
<pre><code class="python">help(str)
</code></pre>
<p>举例</p>
<pre><code class="python">url = r&quot;https://www.baidu.com&quot;
# 查找，索引，未找到返回-1
url.find(&quot;http&quot;)
# 从指定位置开始查找，优化查找速度
url.find(&quot;d&quot;,10)

# 从右边查找，查找字符在结尾时优化查找速度
url.rfind(&quot;m&quot;)

# 查找，索引，未找到报错
url.index(&quot;h&quot;)

# 开头，结尾，返回True，False
url.startswith(&quot;https&quot;)
url.endswith(&quot;com&quot;)

# 是否全大小写,返回True，False
url.isupper()
url.islower()

# 大小写转换
url.upper()
url.lower()

# 首字母大写
url.capitalize()

# 不带参数代表空格，去除开头结尾空格
error = r&quot;   https://www.baidu.com   &quot;
a = error.strip()

# 带参数去除开头结尾指定字符
url.strip(&quot;https&quot;)
</code></pre>
<h1 id="类与对象"><a href="#类与对象" class="headerlink" title="类与对象"></a>类与对象</h1><p>类通过class来定义，对象由类实例化而来。类的作用在于为对象提供一个模板，它包含了属性和函数。最重要的是类提供了继承，封装，多态这三大特性。</p>
<pre><code class="python"># 定义类
class User():
    pass

# 实例化
xiaolu = User()
</code></pre>
<p>查看类的所有方法：<code>__dict__</code></p>
<pre><code class="python">str.__dict__
</code></pre>
<h2 id="类属性和方法"><a href="#类属性和方法" class="headerlink" title="类属性和方法"></a>类属性和方法</h2><p>在类定义之后，就在内存中保存了类的属性和方法，可以直接调用</p>
<pre><code class="python">class User():
    name = &quot;jounr&quot;
    def get_name(self):
        return self.name
print(User.name)
print(User.get_name(User))
</code></pre>
<ul>
<li><p>实例方法：使用最多的方法，需要将类实例化成为对象，通过对象调用方法</p>
</li>
<li><p>静态方法：</p>
<ul>
<li>不需要实例化，通过类直接调用</li>
<li>静态方法包装在staticmethod类的对象中，定义中没有self，可直接通过类来调用方法<br>```python<br>class MyClass():<br>def tellme():<br>  print(“i am a static method,without self”)<br>tellme = staticmethod(tellme)</li>
</ul>
</li>
</ul>
<p>MyClass.tellme()</p>
<pre><code>
- 类方法：
    - 不需要实例化，通过类直接调用，如果调用需要传参的函数，则将类自己作为参数传递进去
    - 类方法包装在classmethod类的对象中，参数为cls，虽然可以通过对象来调用，但是实际上cls还是会关联到类的方法
```python
class MyClass():
    def tellme(cls):
        print(&quot;i am a class method,with args sls&quot;)
    tellme = classmethod(tellme)

MyClass.tellme()
</code></pre>
<h2 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h2><ul>
<li>上面的类方法和静态方法，需要手动写，但是可以通过使用装饰器来自动包装</li>
<li>用来替代手工包装，可用于包装任何可调用对象，还可用于方法和函数。装饰器可以有多个，指定多个时，应用的顺序与列出的顺序相反<pre><code class="python">class MyClass():
  @staticmethod
  def tellme():
      print(&quot;new decorator&quot;)
MyClass.tellme()
</code></pre>
</li>
</ul>
<h2 id="self"><a href="#self" class="headerlink" title="self"></a>self</h2><ul>
<li>self作为一个参数，常常用在类的函数中，但并不是所有类的函数都需要这个参数</li>
<li>self并不是一个关键字，也可以用其它的替代</li>
<li>如果这个函数需要访问类的属性，那么需要self这个参数，它用来指代实例自身</li>
<li>如果这个函数不需要访问类的属性，那么不需要self这个参数</li>
<li>在有self的时候，首先会看函数自己是否定义属性，如果没有，则访问类的属性<pre><code class="python">class User():
  age = 20
  id = 1
  qq = 102832343
  def info():
      print(&quot;hello&quot;)
  def get_age(self):
      return self.age
  def get_qq(self):
      self.qq = 2312323123
      return self.qq,self.age
one = User()
one.info()
print(one.get_age())
print(one.get_qq())
</code></pre>
</li>
</ul>
<h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><ul>
<li>继承父类的属性，函数等。避免了代码的冗余，也可重写父类的方法</li>
<li>将父类作为参数传递给子类</li>
<li>子类可以继承自多个类<br>```python<br>class User():<br>  name = “one”<br>  age = 20<br>  def get_name(self):<pre><code>  return self.name
</code></pre>
class Customer():<br>  id = 1<br>class Realone(User,Customer):<br>  pass</li>
</ul>
<p>a = Realone()<br>a.get_name()<br>print(a.id)</p>
<pre><code>
- 子类扩充父类的方法：使用`super()`调用父类方法
```python
class User():
    name = &quot;journal&quot;
    def get_name(self):
        print(self.name)
class SomeOne(User):
    def get_info(self):
        super().get_name()
        print(&quot;attend super&quot;)

a = SomeOne()
a.get_info())
</code></pre>
<ul>
<li>检测是否为子类<pre><code class="python">print(issubclass(Realone,User))
</code></pre>
</li>
</ul>
<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><ul>
<li>在类实例化的时候第一个自动调用的函数，作用是给对象初始化一些数据</li>
<li>必须有参数self,函数名为<code>__init__</code><br>```python<br>class User():<br>  def <strong>init</strong>(self):<pre><code>  self.name = &quot;lixingyun&quot;
</code></pre>
</li>
</ul>
<p>a = User()<br>print(a.name)</p>
<pre><code>
- 通过继承，扩展父类的构造函数
```python
class User():
    def __init__(self,name):
        self.name = name
        print(name)

# 直接写父类的init方法，只能写一个父类，不推荐使用
class One(User):
    def __init__(self,name):
        # 先调用父类的init函数
        User.__init__(self,name)
        print(&quot;initial finish&quot;)

# 可以自动向上寻找父类的init方法，父类没有写死，推荐使用
class Two(User):
    def __init__(self,name):
        super(Two,self).__init__(name)
        print(&quot;initial finish&quot;)

a = One(&quot;小小&quot;)
b = Two(&quot;小小&quot;)
</code></pre>
<ul>
<li>构造函数默认被继承</li>
<li>如果定义了自己的构造函数，那么父类的构造函数不再被继承。也叫重写父类函数</li>
</ul>
<h2 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h2><p>封装即为对对象成员进行访问限制</p>
<ul>
<li><p>私有：最高级别的限制，只能在当前类或者对象中访问。通过在变量前加<code>__</code>实现</p>
<pre><code class="python">class User():
  __name = &quot;喜洋洋&quot;
  __age = 20
one = User()
# 无法直接访问
print(one.name)
</code></pre>
<p>其实私有也不是真的无法访问，还是可以访问的</p>
<pre><code class="python">print(one._User__age)
</code></pre>
</li>
<li><p>受保护的：在外部不可访问，可以在内部和子类中访问。通过在变量前加<code>_</code>实现</p>
</li>
<li><p>公有的：任何地方都可以使用</p>
</li>
</ul>
<h2 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h2><ul>
<li>同一个对象在不同情况下有不同的状态</li>
<li>在python中是一种设计思想，并没有语法要求，其实我也搞不懂</li>
</ul>
<h2 id="类的函数转属性"><a href="#类的函数转属性" class="headerlink" title="类的函数转属性"></a>类的函数转属性</h2><p>类中的get，set，del函数可以转换为属性</p>
<pre><code class="python">class User():
    def __init__(self,name):
        self.name = name
    def get_name(self):
        return self.name
    def set_name(self,name):
        self.name = name

one = User(&quot;小小&quot;)
one.get_name()
one.set_name(&quot;小青&quot;)
one.get_name()
</code></pre>
<p>可以使用<code>property(get,set,del)</code>函数对get，set，del封装。将函数转换为一个属性值</p>
<pre><code class="python">class User():
    def __init__(self,name):
        self.name = name
    def get_name(self):
        return self.name
    def set_name(self,name):
        self.name = name
    sname = property(get_name, set_name)

two = User(&quot;小二&quot;)
two.sname
two.sname = &quot;可可&quot;
two.sname
</code></pre>
<h2 id="类的内置属性"><a href="#类的内置属性" class="headerlink" title="类的内置属性"></a>类的内置属性</h2><ul>
<li><code>__dict__</code>： 显示类的属性和方法</li>
<li><code>__doc__</code>： 类的说明文档</li>
<li><code>__name__</code>： 类的名称</li>
<li><code>__bases__</code>： 类的所有父类</li>
</ul>
<h2 id="类的魔法函数"><a href="#类的魔法函数" class="headerlink" title="类的魔法函数"></a>类的魔法函数</h2><p>不需要手动调用，达到触发条件，自动调用</p>
<ul>
<li><p><code>__init__</code>： 初始化类的属性</p>
</li>
<li><p><code>__call__</code>： 当对象被当做函数使用的时候，调用此函数</p>
<pre><code class="python">class User():
  def __call__(self):
      print(&quot;此时对象被当做函数调用了&quot;)
one = User()
one()
</code></pre>
</li>
<li><p><code>__str__</code>： 当对象被当做字符串使用的时候，调用此函数</p>
<pre><code class="python">class User():
  def __str__(self):
      return &quot;此时对象被当做字符串使用了&quot;
one = User()
print(one)
</code></pre>
</li>
<li><p><code>__getattr__</code>： 当访问一个不存在的属性时，调用此函数<br>```python<br>class User():<br>  def <strong>getattr</strong>(self,method):</p>
<pre><code>  return &quot;此函数不存在&quot;
</code></pre>
</li>
</ul>
<p>one = User()<br>print(one.age)</p>
<pre><code>
## 抽象
- 抽象方法

定义了方法，但没有实现
```python
class User():
    def get_name(self):
        pass
</code></pre>
<ul>
<li><p>抽象类</p>
<ul>
<li>必须导入模块<code>abc</code></li>
<li>抽象类不可以实例化，必须继承后实例化，继承的子类需要实现所有的继承来的抽象方法</li>
<li>作用为设定类的标准</li>
</ul>
</li>
</ul>
<pre><code class="python">import abc

class User(metaclass=abc.ABCMeta):

    # 定义抽象方法
    @abc.abstractmethod
    def get_name(self):
        pass

    # 定义类抽象方法
    @abc.abstractclassmethod
    def get_age(self):
        pass

    # 定义静态抽象方法
    @abc.abstractstaticmethod
    def get_id(self):
        pass

    # 定义普通方法
    def set_qq(self,qq):
        self.qq = qq
</code></pre>
<h2 id="组装类"><a href="#组装类" class="headerlink" title="组装类"></a>组装类</h2><p>函数名可以作为变量使用</p>
<pre><code class="python">class User():
    pass
def he(self):
    print(&quot;hello&quot;)

User.he = he
one = User()
one.he()
</code></pre>
<h1 id="Package"><a href="#Package" class="headerlink" title="Package"></a>Package</h1><p>package is a collection of modules, which must be included with a file called <code>__init__.py</code></p>
<ul>
<li><p>how to import a package</p>
<ul>
<li>import all include <code>__init__.py</code><br>```python<br>import package_name</li>
</ul>
<p>  package_name.function_name()<br>  package_name.class_name.function_name()</p>
<pre><code>
- only import specify module,except `__init__.py`
```python
import package_name.module_name as md1

md1.function_name()
md1.class_name()
</code></pre>
<ul>
<li>another way import should be mentiond<pre><code class="python">from package_name import *
</code></pre>
the way import only import function and class which in <code>__init__.py</code></li>
</ul>
</li>
</ul>
<h2 id="module"><a href="#module" class="headerlink" title="module"></a>module</h2><p>a module is a file contains python code.it’s suffix with .py</p>
<ul>
<li><p>why we need module?</p>
<ul>
<li>shrink program,make it easy to maintain</li>
<li>module can be reused</li>
<li>used as a namespace,reduce name conflict</li>
</ul>
</li>
<li><p>how to use module?</p>
<ul>
<li>import directily<br>```python<br>import module_name</li>
</ul>
<p>  module_name.function_name()<br>  module_name.class_name()</p>
<pre><code>
- if the module name prefix with num such as 2.py
```python
import importlib

variable = importlib.import_module(&quot;02&quot;)

variable.function_name()
variable.class_name()
</code></pre>
<ul>
<li><p>use as rename module when the name of module is long</p>
<pre><code class="python">import module_name as somename
</code></pre>
</li>
<li><p>import module’s class or function,not whole module<br>```python<br>from module_name import someclass,somefunction</p>
</li>
</ul>
<p>  variable1 = someclass()<br>  variable2 = somefunction()</p>
<pre><code>
- import all class and function

the benifit of it is writing class or function directily without module name prefix
```python
from module_name import *

variable = someclass()
</code></pre>
</li>
<li><p>where modules store?</p>
<ul>
<li>default location<br>```python<br>import sys</li>
</ul>
<p>  for i in sys.path:</p>
<pre><code>  print(i)
</code></pre>
<pre><code>
- add own module location
```python
import sys

sys.path.append(directory)
</code></pre>
</li>
</ul>
<h2 id="the-entrance-of-code"><a href="#the-entrance-of-code" class="headerlink" title="the entrance of code"></a>the entrance of code</h2><ul>
<li>in genreal,all entrance of code should be started with this</li>
<li>it can control whether to execute some code,if used as a code which will be execute,if used as a module which will not be execute</li>
</ul>
<pre><code class="python">if __name__ == &quot;__main__&quot;:
    print(&quot;first execute code&quot;)
</code></pre>
<h1 id="Error-catch"><a href="#Error-catch" class="headerlink" title="Error catch"></a>Error catch</h1><p>some days ago,i really don’t know why we need to catch error.in my mind,i think we should not write code with error.until one day,i get a problem,i need to create a temporary table first and then delete it every time the script run.and the error appeard.some times the table isn’t exist,when execute the delete code,the program broken.at last i use error catch to avoid the error</p>
<p>eg:get user type in</p>
<pre><code class="python">try:
    num = int(input(&quot;num:&quot;))
    result = 100 / num
    print(result)
except:
    print(&quot;not a none zero number&quot;)
</code></pre>
<ul>
<li>syntax<pre><code class="python">try:
  ...
  # can raise error by hand
  raise some_error_type
# if it is the error below(tuple),execute this code
except (error_type1,error_type2...):
  ...
  # exit() can exit the program
  exit()
# we can print error infomation
except ZeroDivisionError as e:
  print(e)
# Exception is the supper of all except type
except Exception as e:
  ...
# if not in the error above execute this code
else:
  ...
# what ever error happend,will execute this code
finally:
  ...
</code></pre>
</li>
</ul>
<h1 id="Time-mudule"><a href="#Time-mudule" class="headerlink" title="Time mudule"></a>Time mudule</h1><pre><code class="python">import time

# get time now with format
now = time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)

# another way to get the format time
hour = time.localtime().tm_hour

# get the timestamp
unique = time.time()

# sleep
time.sleep(second_number)
</code></pre>
<pre><code class="python">import timeit

# calcute program execute time with number times repeat
t1 = timeit.timeit(stmt=&quot;[i for i in range(10)]&quot;,number=100)

def number():
    lt = []
    for i in range(10):
        lt.append(i)

t2 = timeit.timeit(stmt=number,number=100)
</code></pre>
<pre><code class="python">import datetime

# convert string to date
a = datetime.date(2020,10,10)
print(a)
b= datetime.time(10,10,10)
print(b)
c = datetime.datetime(2020,10,10,10,10,10)
print(c)

# get the current datetime
d = datetime.date.today()
print(d)
</code></pre>
<h1 id="OS-module"><a href="#OS-module" class="headerlink" title="OS module"></a>OS module</h1><p>associated with operate system</p>
<p>three important modules:</p>
<ul>
<li>os</li>
<li>os.path, used for path</li>
<li>shutil, used for directory,file</li>
</ul>
<pre><code class="python">import os

dir = os.getcwd()

os.chdir(&quot;../&quot;)

# get file and dir of current directory with out hidden file
lt = [i for i in os.listdir() if not i.startswith(&quot;.&quot;)]

# execute shell command
os.system(&quot;htop&quot;)

# get system environment variables
os.getenv(&quot;SHELL&quot;)
</code></pre>
<pre><code class="python">import os.path as op

absc = op.abspath(&quot;.&quot;)

# used for different operate system
d1 = &quot;/home/narcissus&quot;
d2 = &quot;1.txt&quot;
os.join(d1,d2)

# os.path.split return a tuple,so can be used like this
d1,d2 = op.split(&quot;/home/narcissus/1.txt&quot;)

# whether a path exists
op.exists(&quot;/home/narcissus/1.txt&quot;)
</code></pre>
<pre><code class="python">import shutil

shutil.copy(&quot;1.txt&quot;,&quot;2.txt&quot;)

shutil.move(&quot;1.txt&quot;,&quot;2.txt&quot;)

# archive all file of Desktop into test.tar
shutil.make_archive(&quot;/home/narcissus/Desktop/test&quot;,&quot;tar&quot;,&quot;/home/narcissus/Desktop/&quot;)

# unarchive file
shutil.unpack_archive(&quot;/home/narcissus/Desktop/test.tar&quot;,&quot;.&quot;,&quot;tar&quot;)
</code></pre>
<h1 id="Random-module"><a href="#Random-module" class="headerlink" title="Random module"></a>Random module</h1><pre><code class="python">import random

# return a number in the interval [0,1)
r1 = random.random()

# return a number in the interval [0,100)
r2 = int(random.random()*100)

# random choice in the interval [1,100)
l1 = [i for i in range(0,100)]
random.choice(l1)

# shuffle list
l1 = [i for i in range(1,10)]
print(l1)
random.shuffle(l1)
print(l1)

# random integer
random.randint(1,100)
</code></pre>
<h1 id="Functional-programming"><a href="#Functional-programming" class="headerlink" title="Functional programming"></a>Functional programming</h1><p>features:</p>
<ul>
<li>function can be used as a parameter </li>
<li>function can be used as return value</li>
</ul>
<h2 id="lambda"><a href="#lambda" class="headerlink" title="lambda"></a>lambda</h2><p>lambda exprssion</p>
<ul>
<li>begin with lambda</li>
<li>have zero or more parameter</li>
<li>use : split lambda with expression</li>
<li>no return keyword</li>
</ul>
<pre><code class="python">la = lambda x: x * 100
la(10)

lb = lambda x,y,z: x + y*10 + z/2
lb(2,4,8)
</code></pre>
<h2 id="high-level-function"><a href="#high-level-function" class="headerlink" title="high-level function"></a>high-level function</h2><pre><code class="python">def get_name():
    print(&quot;小小&quot;)

# function is a variable
variable = get_name
variable()
</code></pre>
<pre><code class="python"># normal function
def plus(num):
    return num * 100
def add(num):
    return plus(num) + 100
add(3)

# high_level function
def plus(num):
    return num * 100
def high_level(fun,num):
    return fun(num) + 100
high_level(plus,2)
</code></pre>
<h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p><code>map(func,*iterables)</code></p>
<pre><code class="python">l1 = [i for i in range(10)]
print(l1)

# use lambda expression ,ten times a num
mult = lambda num: num * 10

# use map to generate a class map
l2 = map(mult,l1)
print(l2)

# class object can be iterabled
l3 = [i for i in l2]
print(l3)
</code></pre>
<h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h3><p>notice:</p>
<ul>
<li>need import module</li>
<li>function need two parameters</li>
<li>function need return value</li>
</ul>
<p>principle:<br>reduce(1,2,3) = f(f(1,2),3)</p>
<pre><code class="python">from functools import reduce

l1 = [i for i in range(10)]

plus = lambda x,y: x + y

l2 = reduce(plus,l1)
print(l2)
</code></pre>
<h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p>notice:</p>
<ul>
<li>function need return a boolean</li>
<li>filter return a class object which can be iterabled</li>
</ul>
<p><code>filter(function,*iterables)</code></p>
<pre><code class="python">l1 = [i for i in range(10)]

fit = lambda x: x % 2 == 0

l2 = filter(fit,l1)

l3 = [i for i in l2]
print(l3)
</code></pre>
<h3 id="sorted"><a href="#sorted" class="headerlink" title="sorted"></a>sorted</h3><p>number sorted</p>
<pre><code class="python">import random

l1 = [i for i in range(10)]
random.shuffle(l1)
print(l1)

l2 = sorted(l1)
print(l2)

l3 = sorted(l1,reverse=True)
print(l3)
</code></pre>
<p>charactor sorted</p>
<pre><code class="python">l1 = [&quot;sda&quot;,&quot;dev&quot;,&quot;HOME&quot;,&quot;Alian&quot;,&quot;alias&quot;]

l2 = sorted(l1)
print(l2)

l3 = sorted(l1, key=str.lower)
print(l3)

l4 = sorted(l1, key=str.lower, reverse=True)
print(l4)
</code></pre>
<h3 id="Closure-package"><a href="#Closure-package" class="headerlink" title="Closure package"></a>Closure package</h3><p>B function defined inside A function,and B function as a return vlaue,all parameters of A can be used by B,it is called closure</p>
<pre><code class="python">def A(*args):
    def B():
        sum = 0
        for i in args:
            sum += i
        return sum
    return B

l1 = [i for i in range(20)]
one = A(*l1)
one()
</code></pre>
<h3 id="Decorator"><a href="#Decorator" class="headerlink" title="Decorator"></a>Decorator</h3><p>Decorator is a high-level function,i can return a function.</p>
<p>feature:</p>
<ul>
<li>extend origion function without change its code</li>
<li>use <code>@</code> to called a decorator</li>
</ul>
<pre><code class="python">import time

def now(func):
    def pf(*args,**kwargs):
        print(&quot;Time:&quot;,time.ctime())
        return func(*args,**kwargs)
    return pf

def line(func):
    def pf(*args,**kwargs):
        print(&quot;=&quot;*50)
        return func(*args,**kwargs)
    return pf

# use system decorator @
@now
@line
def he(name):
    print(&quot;hello&quot;,name)

he(&quot;小小&quot;)


# by hand execute without system decorator @
return_fun = now(he)
return_fun(&quot;小小&quot;)
</code></pre>
<h3 id="Partial-function"><a href="#Partial-function" class="headerlink" title="Partial function"></a>Partial function</h3><p>return a new function with some of its parameters fixed</p>
<pre><code class="python">import functools

# convert 16 to 10
int16 = functools.partial(int,base=16)
int16(&quot;f&quot;)


# we can realize this by hand
def int16(num,base=16):
    return int(num,base)
int16(&quot;f&quot;)
</code></pre>
<h3 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h3><p>combine two iterable object into several tuples</p>
<pre><code class="python">l1 = [i for i in range(1,10)]
l2 = [i for i in range(100,110)]
l3 = [i for i in zip(l1,l2)]
print(l3)
</code></pre>
<h3 id="enumerate"><a href="#enumerate" class="headerlink" title="enumerate"></a>enumerate</h3><p>give each iterable object a index and return several tuples,notice that the index can be customized</p>
<pre><code class="python">l1 = [i for i in range(1,10)]

l2 = [i for i in enumerate(l1,start=1)]

print(l2)
</code></pre>
<h3 id="collections-module"><a href="#collections-module" class="headerlink" title="collections module"></a>collections module</h3><ul>
<li>namedtuple: it can limit the number of tuple</li>
<li>deque: it is much faster than list</li>
<li>defaultdict: no error report when query none exist key</li>
<li>Counter: regard string as a iterable dict</li>
</ul>
<pre><code class="python">import collections

circle = collections.namedtuple(&quot;circle&quot;,[&quot;x&quot;,&quot;y&quot;,&quot;r&quot;])
p = circle(3,4,5)
if p.x**2 + p.y**2 == p.r**2:
    print(&quot;it is a circle&quot;)
</code></pre>
<pre><code class="python">import collections

ql = collections.deque()
ql.append(1)
print(ql)
</code></pre>
<pre><code class="python">import collections

func = lambda : &quot;no key exist&quot;
dd = collections.defaultdict(func)
dd[&quot;one&quot;] = &quot;first&quot;
dd[&quot;one&quot;]
dd[&quot;four&quot;]
</code></pre>
<pre><code class="python">import collections

cr = &quot;ksjflajowielzxkjowieof1242lkjlk&quot;
cd = collections.Counter(cr)
print(cd)
print(cd[&quot;j&quot;])
</code></pre>
<h1 id="File-operate"><a href="#File-operate" class="headerlink" title="File operate"></a>File operate</h1><h2 id="open"><a href="#open" class="headerlink" title="open"></a>open</h2><ul>
<li>mode<ul>
<li>r: read only</li>
<li>w: new write,will erase origional file</li>
<li>x: open exist file,if not error reportd</li>
<li>a: append mode</li>
<li>b: binary write</li>
<li>t: file mode open</li>
<li>+: read and write</li>
</ul>
</li>
</ul>
<p>in this way, we need to close file handle by hand</p>
<pre><code class="python">dir = r&quot;/home/narcissus/Desktop/遍历游标的三种方式.md&quot;
f = open(dir,&quot;r&quot;)
for i in f:
    print(i)
f.close()
</code></pre>
<p>in this way, file handle will be closed automatically</p>
<pre><code class="python">dir = r&quot;/home/narcissus/Desktop/遍历游标的三种方式.md&quot;
with open(dir,&quot;r&quot;) as f:
    for i in f:
        print(i)
</code></pre>
<p>read only one line,so should be carefully</p>
<pre><code class="python">dir = r&quot;/home/narcissus/Desktop/遍历游标的三种方式.md&quot;
with open(dir,&quot;r&quot;) as f:
    i = f.readline()
    while i:
        print(i)
        i = f.readline()
</code></pre>
<p>read all lines</p>
<pre><code class="python">dir = r&quot;/home/narcissus/Desktop/遍历游标的三种方式.md&quot;
with open(dir,&quot;r&quot;) as f:
    i = f.readlines()
    for j in i:
        print(j)

# or use this
with open(dir,&quot;r&quot;) as f:
    i = list(f)
    for j in i:
        print(j)
</code></pre>
<p>read each word</p>
<pre><code class="python">dir = r&quot;/home/narcissus/Desktop/遍历游标的三种方式.md&quot;
with open(dir,&quot;r&quot;) as f:
    word = f.read(1)
    while word:
        print(word,end=&quot;&quot;)
        word = f.read(1)
</code></pre>
<h2 id="write"><a href="#write" class="headerlink" title="write"></a>write</h2><ul>
<li>write: only support string</li>
<li>writeline: can write list directily</li>
</ul>
<pre><code class="python">import os

dir = r&quot;/home/narcissus/Desktop/1.txt&quot;
txt = os.listdir(&quot;/home/narcissus&quot;)
needed = [i for i in txt if not i.startswith(&quot;.&quot;)]
with open(dir, &quot;w&quot;) as f:
    # write whole list once without space
    f.writelines(needed)

    # can not write list directily,but can use loop to write new line per element
    # for i in needed:
    #     f.write(i)
    #     f.write(&quot;\n&quot;)
with open(dir,&quot;r&quot;) as f:
    info = f.readlines()
    print(info)
</code></pre>
<h2 id="pickle-module"><a href="#pickle-module" class="headerlink" title="pickle module"></a>pickle module</h2><p>it is used for persistence file, can save program’s information to disk while the program runing</p>
<p>feature:</p>
<ul>
<li>it can store infomation immediately</li>
<li>it can store infomation with format unchanged</li>
</ul>
<p>function:</p>
<ul>
<li>pickle.dump: write</li>
<li>pickle.load: read</li>
</ul>
<p>notice:<br>use binary mode to write or read file</p>
<pre><code class="python">import pickle,os

dir = r&quot;/home/narcissus/Desktop/1.txt&quot;
txt = os.listdir(&quot;/home/narcissus&quot;)
info = [i for i in txt if not i.startswith(&quot;.&quot;)]
with open(dir,&quot;wb&quot;) as f:
    pickle.dump(info,f)
with open(dir,&quot;rb&quot;) as f:
    get = pickle.load(f)
    print(get)
</code></pre>
<h1 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h1><p>why we need log?<br>recording some information at important points, suitable log information can let us to know program running statius<br>but that isn’t to say log is much more much better,because io operation will slow down program.</p>
<p>there are several log level:</p>
<ul>
<li>debug</li>
<li>info</li>
<li>notice</li>
<li>warning</li>
<li>error</li>
<li>critical</li>
<li>alert</li>
<li>emergency</li>
</ul>
<p>log include:<br>[time location level content]</p>
<p>good log module:</p>
<ul>
<li>log4j -&gt; java</li>
<li>log4php -&gt; php</li>
<li>logging -&gt; python</li>
</ul>
<h2 id="python-logging-module"><a href="#python-logging-module" class="headerlink" title="python logging module"></a>python logging module</h2><p>level:</p>
<ul>
<li>debug</li>
<li>info</li>
<li>warning</li>
<li>error</li>
<li>critical</li>
</ul>
<p>default log level:</p>
<ul>
<li>specify a log level in program</li>
<li>only log level which equal or high above than specified level will be write in log</li>
</ul>
<h2 id="usage"><a href="#usage" class="headerlink" title="usage:"></a>usage:</h2><h3 id="specify-default-log-level"><a href="#specify-default-log-level" class="headerlink" title="specify default log level"></a>specify default log level</h3><p>only logging once at first time executes</p>
<p>feature:</p>
<ul>
<li>specify the default log level</li>
<li>output: sys.stderr</li>
<li>default level: warning</li>
<li>format: level:log_name:content</li>
</ul>
<pre><code class="python">logging.basicConfig(**kwargs)
</code></pre>
<p>eg:</p>
<pre><code class="python">import logging

dir = r&quot;/home/narcissus/Desktop/info.log&quot;
log_format = &quot;%(asctime)s   %(levelname)s   %(message)s&quot;
logging.basicConfig(filename=dir, level=logging.DEBUG, format=log_format)
</code></pre>
<h3 id="use-level-function"><a href="#use-level-function" class="headerlink" title="use level function"></a>use level function</h3><pre><code class="python">logging.debug(msg, *args, **kwargs)
logging.info(msg, *args, **kwargs)
logging.warning(msg, *args, **kwargs)
logging.error(msg, *args, **kwargs)
logging.critical(msg, *args, **kwargs)
</code></pre>
<p>eg:</p>
<pre><code class="python">import logging

logging.debug(&quot;this is a debug log&quot;)
logging.info(&quot;this is a info log)
</code></pre>
<h3 id="use-log-function"><a href="#use-log-function" class="headerlink" title="use log function"></a>use log function</h3><pre><code class="python">logging.log(level, *args, **kwargs)
</code></pre>
<p>eg:</p>
<pre><code class="python">import logging

logging.log(logging.DEBUG,&quot;this is a debug log&quot;)
logging.log(logging.INFO,&quot;this is a info log&quot;)
</code></pre>
<p>complete example</p>
<pre><code class="python">import logging

dir = r&quot;/home/narcissus/Desktop/info.log&quot;
log_format = &quot;%(asctime)s\t%(levelname)s\t%(lineno)d %(message)s&quot;
logging.basicConfig(filename=dir, level=logging.DEBUG, format=log_format)


logging.debug(&quot;this is a debug log&quot;)
logging.info(&quot;this is a info log&quot;)

logging.log(logging.DEBUG,&quot;this is a debug log&quot;)
logging.log(logging.INFO,&quot;this is a info log&quot;)
</code></pre>
<h2 id="by-hand-usage"><a href="#by-hand-usage" class="headerlink" title="by hand usage"></a>by hand usage</h2><ul>
<li>logger: a interface of log produces log</li>
<li>handler: decide where log stores</li>
<li>filter: what should be displayed</li>
<li>formatter: format</li>
</ul>
<p>logger:</p>
<pre><code class="python">Logger.setLevel()
Logger.addHandler()/Logge.removeHandler()
Logger.addFilter()/Logger.removeFilter()
Logger.debug()/info/error
Logger.exception()
Logger.log()


logging.getLogger()
</code></pre>
<p>and so on …..</p>
<h1 id="Json"><a href="#Json" class="headerlink" title="Json"></a>Json</h1><p>convert:</p>
<ul>
<li>json.dumps(): python -&gt; json</li>
<li>json.loads(): json -&gt; json</li>
</ul>
<p>read and write with file:</p>
<ul>
<li>json.dump(): write to file</li>
<li>json.load(): read from file</li>
</ul>
<pre><code class="python">import json,os

data = &#123;
    &quot;user&quot;: &quot;小小&quot;,
    &quot;age&quot;: 20,
    &quot;like&quot;: [&quot;juice&quot;,&quot;apple&quot;,&quot;cherry&quot;],
    &quot;score&quot;: &#123;
        &quot;chinese&quot;: 80,
        &quot;math&quot;: 90,
        &quot;english&quot;: 100
    &#125;
&#125;

jd = json.dumps(data)
print(type(jd),jd)
nd = json.loads(jd)
print(type(nd),nd)

dir = r&quot;/home/narcissus/Desktop&quot;
os.chdir(dir)
with open(&quot;test.js&quot;,&quot;w&quot;) as f:
    json.dump(data,f)

with open(&quot;test.js&quot;,&quot;r&quot;) as f:
    file = json.load(f)
    print(file[&quot;score&quot;][&quot;chinese&quot;])
</code></pre>
<h1 id="Multi-threads"><a href="#Multi-threads" class="headerlink" title="Multi threads"></a>Multi threads</h1><p>process vs thread:<br>process totally different,but thread will share something.<br>process builds with threads</p>
<h2 id="basic-usage"><a href="#basic-usage" class="headerlink" title="basic usage"></a>basic usage</h2><p>syntax:</p>
<pre><code class="python">import threading
# args is tuple
td = threading.thread(target=function_name,args=())
# set thread name,it is optional
td.setName(&quot;thread1&quot;)
# start thread
td.start()
# waiting for thread finish
td.join()   
</code></pre>
<p>notice:<br>the type of args is tuple</p>
<h2 id="daemon-thread"><a href="#daemon-thread" class="headerlink" title="daemon thread"></a>daemon thread</h2><p>when process stops the daemon thread will stop immediately</p>
<p>syntax:</p>
<pre><code class="python">import threading
# args is tuple
td = threading.thread(target=function_name,args=())
td.daemon = True # or td.setDaemon(True)
td.start()
# waiting for thread finish
td.join()   
</code></pre>
<h2 id="shared-variables"><a href="#shared-variables" class="headerlink" title="shared variables"></a>shared variables</h2><p>it is appeard when several threads access one variable at the same time, it will lead wrong result. In order to resolve this problem, we can lock the use of variable</p>
<p>syntax:</p>
<pre><code class="python">lock = threading.Lock()
lock.acquire()
lockd_variable
lock.release()
</code></pre>
<p>without lock</p>
<pre><code class="python">import threading

sum = 0
num = 1000000

def add(num):
    global sum
    for i in range(num):
        sum += 1
    return sum

def miu(num):
    global sum
    for i in range(num):
        sum -= 1
    return sum
# normal usage will return sum = 0
# miu(num)
# add(num)
# print(sum)


# use thread access one variable at the same time will lead wrong result
def calcu():
    td1 = threading.Thread(target=add,args=(num,))
    td2 = threading.Thread(target=miu,args=(num,))

    td1.start()
    td2.start()
    td1.join()
    td2.join()

if __name__ == &quot;__main__&quot;:
    calcu()
    print(sum)
</code></pre>
<p>use lock</p>
<pre><code class="python">import threading

sum = 0
num = 1000000
lock = threading.Lock()

# lock variable to be accessd by one at the same time
def add(num):
    global sum
    for i in range(num):
        lock.acquire()
        sum += 1
        lock.release()
    return sum

def miu(num):
    global sum
    for i in range(num):
        lock.acquire()
        sum -= 1
        lock.release()
    return sum


def lock_calcu():
    ld1 = threading.Thread(target=add,args=(num,))
    ld2 = threading.Thread(target=miu,args=(num,))

    ld1.start()
    ld2.start()

    ld1.join()
    ld2.join()

if __name__ == &quot;__main__&quot;:
    lock_calcu()
    print(sum)
</code></pre>
<h2 id="thread-safe"><a href="#thread-safe" class="headerlink" title="thread safe"></a>thread safe</h2><p>if one variable to be used by multi threads at the same time without lock variable but no problem happend, it is called thread safe.</p>
<p>not thread safe: list, set, dict</p>
<p>thread safe: queue</p>
<h2 id="deadlock"><a href="#deadlock" class="headerlink" title="deadlock"></a>deadlock</h2><p>two lock both not release, lead to both waitting, deadlock appeard, leading program dead</p>
<h1 id="muiti-processes"><a href="#muiti-processes" class="headerlink" title="muiti processes"></a>muiti processes</h1><p>we know multi threads will cause problem usually, but there are several method more useful than multi threads:</p>
<ul>
<li>subprocess</li>
<li>multiprocessing</li>
<li>concurrent.futures</li>
</ul>
<h1 id="iterable-iterator"><a href="#iterable-iterator" class="headerlink" title="iterable/iterator"></a>iterable/iterator</h1><p>difference:<br>iterable -&gt; directly used by for loop<br>iterator -&gt; not only used by for loop but also can be used by next function</p>
<p>how to distinct each other:</p>
<pre><code class="python">from collections import Iterable,Iterator

lt = [i for i in range(10)]

print(isinstance(lt,Iterable))
print(isinstance(lt,Iterator))
</code></pre>
<p>convert iterable to iterator:</p>
<pre><code class="python">from collections import Iterable,Iterator

lt = [i for i in range(10)]

print(isinstance(lt,Iterable))
print(isinstance(lt,Iterator))

clt = iter(lt)
print(isinstance(clt,Iterable))
print(isinstance(clt,Iterator))
</code></pre>
<h1 id="generator"><a href="#generator" class="headerlink" title="generator"></a>generator</h1><p>feature:</p>
<ul>
<li>product data which used by for loop</li>
<li>at the end of generator raise StopIterationError</li>
<li>can be used by next() function</li>
</ul>
<p>why we need generator?<br>all data are calculated step by step when in need, don’t store in memory, use cpu instead of memory. range() is a generator,so we need use it often, it is more useful than list.</p>
<p>how to make a generator</p>
<ul>
<li><code>()</code></li>
<li>yield: yield can stop loop until next iterate</li>
</ul>
<p>use <code>()</code></p>
<pre><code class="python">lt = [i for i in range(10)]
lg = (i for i in range(10))

print(type(lt))
# lg is a generator
print(type(lg))
</code></pre>
<p>use yield</p>
<pre><code class="python"># normal usage
# 1,1,2,3,5,8,13
# def fib(num):
#     a,b,n = 0,1,0
#     while n &lt; num:
#         a,b = b,a+b
#         n += 1
#     return a
# fib(6)


# use yield
def fib(num):
    a,b,n = 0,1,0
    while n &lt; num:
        # yield can stop loop until next iterate
        yield b
        a,b = b,a+b
        n += 1

# generator is iterable
for i in fib(7):
    print(i)
</code></pre>
<h1 id="coroutines"><a href="#coroutines" class="headerlink" title="coroutines"></a>coroutines</h1><p>coroutines is much more useful than multi threads, it’s need less resource, we can regard it as a generator or a function which can be stopd</p>
<p>how to realize it?</p>
<ul>
<li>yield: return result</li>
<li>send: send args to generator</li>
<li>yield from: as a middle hand transfer message</li>
</ul>
<p>yield x: return x<br>x = yield: get x value from send() function</p>
<pre><code class="python">def test_coroutine():
    print(&quot;start&quot;)
    x = yield
    print(&quot;get&quot;,x)
    yield x


co = test_coroutine()
next(co)
co.send(20)
</code></pre>
<p>yield from</p>
<pre><code class="python">def test_coroutine(st):
    for i in range(st):
        yield i

def get_num():
    yield from &quot;1234567&quot;

print(list(get_num()))
</code></pre>
<h2 id="async-wait"><a href="#async-wait" class="headerlink" title="async/wait"></a>async/wait</h2><pre><code class="python">import asyncio

async def get_num(num):
    for i in range(num):
        print(i)
        await asyncio.sleep(1)

loop = asyncio.get_event_loop()
lt = [get_num(10),get_num(20)]
loop.run_until_complete(asyncio.wait(lt))
loop.close()
</code></pre>
<h2 id="concurrent-futures"><a href="#concurrent-futures" class="headerlink" title="concurrent.futures"></a>concurrent.futures</h2><ul>
<li>use subprocess, run several python interpreter. each subprocess can use a core of cpu, all core of cpu can be used 100%</li>
<li>use multithreads, as we know python can only use one thread at one time, so it uses the same time as one process, and each of thread can not pull use cpu</li>
</ul>
<h3 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h3><p>although my cpu only have 4 core 8 thread, but each cpu didn’t be full used, it is because python can only run one thread at one time, threadpool is also thread.</p>
<pre><code class="python">from concurrent.futures import ThreadPoolExecutor

def ts(num):
    sum = 0
    print(threading.current_thread())
    for i in range(num):
        sum += 1
    return sum

pool = ThreadPoolExecutor(max_workers=8)

t1 = pool.submit(ts, 100000000)
t2 = pool.submit(ts, 100000000)
t3 = pool.submit(ts, 100000000)
t4 = pool.submit(ts, 100000000)
t5 = pool.submit(ts, 100000000)
t6 = pool.submit(ts, 100000000)
t7 = pool.submit(ts, 100000000)
t8 = pool.submit(ts, 100000000)

print(t1.result())
print(t2.result())
print(t3.result())
print(t4.result())
print(t5.result())
print(t6.result())
print(t7.result())
print(t8.result())
</code></pre>
<p>use map</p>
<pre><code class="python">from concurrent.futures import ThreadPoolExecutor

def ts(num):
    sum = 0
    print(threading.current_thread())
    for i in range(num):
        sum += 1
    return sum

pool = ThreadPoolExecutor(max_workers=8)


lt = [100000000] * 8
for i in pool.map(ts,lt):
    print(i)
</code></pre>
<h3 id="ProcessPoolExecutor"><a href="#ProcessPoolExecutor" class="headerlink" title="ProcessPoolExecutor"></a>ProcessPoolExecutor</h3><p>all core of cpu can be used 100%</p>
<pre><code class="python">from concurrent.futures import ProcessPoolExecutor

def ts(num):
    sum = 0
    print(threading.current_thread())
    for i in range(num):
        sum += 1
    return sum

pool = ProcessPoolExecutor(max_workers=8)


lt = [100000000] * 8
for i in pool.map(ts,lt):
    print(i)
</code></pre>
<h1 id="regular-expression"><a href="#regular-expression" class="headerlink" title="regular expression"></a>regular expression</h1><ul>
<li><p>there are two methods</p>
<ol>
<li>compile re to a object<br>```python<br>import re</li>
</ol>
<p>  s = “Hello, Join. where did you go? 123,hk123,H89Hk”<br>  p = re.compile(“[0-9]{1,}”)<br>  m = p.findall(s)<br>  print(m)</p>
<pre><code>
2. use re directory
```python
import re

s = &quot;Hello, Join. where did you go? 123,hk123,H89Hk&quot;
m = re.findall(&quot;[0-9]&#123;1,&#125;&quot;,s)
print(m)
</code></pre>
</li>
<li><p>ignore case</p>
</li>
</ul>
<pre><code class="python">import re

s = &quot;Hello, Join. where did you go? 123,hkj123,H89Hjk&quot;
p = re.compile(&quot;h&quot;,re.I)
m = p.findall(s)
print(m)
</code></pre>
<ul>
<li>substitute</li>
</ul>
<pre><code class="python">import re

s = &quot;Hello, Join. where did you go? 123,hkj123,H89Hjk&quot;
p = re.compile(&quot;\d+&quot;)
t = p.sub(&quot;000&quot;,s)
print(s)
print(t)
</code></pre>
<ul>
<li>catch chinese</li>
</ul>
<pre><code class="python">import re

s = &quot;Hello, 世界. 喜欢你where did you go? 123,hkj123,H89Hjk&quot;
p = re.compile(&quot;[\u4c00-\u9fa5]+&quot;)
t = p.findall(s)

print(t)
</code></pre>
<ul>
<li>catch no chinese</li>
</ul>
<pre><code class="python">import re

s = &quot;Hello, 世界. 喜欢你where did you go? 123,hkj123,H89Hjk&quot;
p = re.compile(&quot;[^\u4c00-\u9fa5]+&quot;)
t = p.findall(s)

print(t)
</code></pre>
<h1 id="Xpath"><a href="#Xpath" class="headerlink" title="Xpath"></a>Xpath</h1><p>it is used to find xml file</p>
<p>syntax:</p>
<ul>
<li><code>/</code>: root node</li>
<li><code>//</code>: two node</li>
<li><code>.</code>: current node</li>
<li><code>..</code>: father node</li>
<li><code>@</code>: property</li>
</ul>
<h1 id="net-program"><a href="#net-program" class="headerlink" title="net program"></a>net program</h1><p>network model:</p>
<ul>
<li>7 layers model<ul>
<li>Layer 7 - Application</li>
<li>Layer 6 - Presentation</li>
<li>Layer 5 - Session</li>
<li>Layer 4 - Transport</li>
<li>Layer 3 - Network</li>
<li>Layer 2 - Data Link</li>
<li>Layer 1 - Physical</li>
</ul>
</li>
<li>4 layers model<ul>
<li>Layer 4 - Application</li>
<li>Layer 3 - Transport</li>
<li>Layer 2 - Network</li>
<li>Layer 1 - Link</li>
</ul>
</li>
</ul>
<h1 id="ftp"><a href="#ftp" class="headerlink" title="ftp"></a>ftp</h1><ul>
<li><p>leaning website: <a target="_blank" rel="noopener" href="http://zetcode.com/python/ftp/">link</a></p>
</li>
<li><p>Python ftplib<br>python ftplib is a module that implements the client side of the FTP protocol. It contains an FTP client class and some helper functions. </p>
</li>
<li><p>Python FTP clas<br>The ftplib.FTP() creates a new instance of the FTP class. When host is given, a connection to the host is made with the connect() method. </p>
</li>
</ul>
<p>example:</p>
<p>in my archlinux, i start vsftpd.service first</p>
<pre><code class="shell">sudo systemctl start vsftpd
</code></pre>
<p>and then change the default config <code>/etc/vsftpd.config</code> to enable local user login</p>
<p>at last i write a ftp python file</p>
<pre><code class="python">import ftplib

# a anonymous function print lines
line = lambda x: print(x * 80)

# get ftp login user and passwd
user = input(&quot;ftp login user name: &quot;)
pwd = input(&quot;password: &quot;)

with ftplib.FTP(&quot;localhost&quot;) as ftp:
    try:
        # get connection
        ftp.login(user=user, passwd=pwd)

        # print welcome information
        info = ftp.getwelcome()
        print(&quot;welcome: &quot;,info)
        line(&quot;-&quot;)
        
        # change current directory
        ftp.cwd(dirname=&quot;Desktop&quot;)

        # get current directory
        current_dir = ftp.pwd()
        print(&quot;current_dir: &quot;,current_dir)
        line(&quot;*&quot;)

        # get context list
        files = []
        ftp.dir(files.append)
        for i in files:
            print(i)
        line(&quot;=&quot;)

        # download file, by default the file will be stored at /tmp/
        file_copy = &quot;test.txt&quot;
        with open(file_copy, &quot;w&quot;) as f:
            res = ftp.retrlines(&quot;RETR &quot;+&quot;1.py&quot;, f.write)
            
            if not res.startswith(&#39;226 Transfer complete&#39;):
                print(&#39;Download failed&#39;)
                if os.path.isfile(file_copy):
                    os.remove(file_copy)  
            else:
                print(&quot;down&quot;)
        
    except ftplib.all_errors as e:
        print(e)
</code></pre>
<h1 id="mail"><a href="#mail" class="headerlink" title="mail"></a>mail</h1><p>how it works?<br>process: user mail —-&gt; mail proxy —–&gt; mail server —–&gt; user<br>agent: ————&gt;mua————–&gt;mta—————&gt;mda<br>protocal: —————–&gt;SMTP————-&gt;POP3/IMAP</p>
<p>MUA: MailUserAgent, user send mail to proxy<br>MTA: MailTransferAgent, catch mail from proxy to mail server<br>MDA: MailDeliveryAgent, deliver mail from server to user</p>
<p>how to use it:<br>there are two modules</p>
<ol>
<li>email: used to modify mail</li>
<li>smtplib: used to send mail</li>
</ol>
<p>the following is a simple text mail example.</p>
<pre><code class="python">import smtplib
from email.mime.text import MIMEText


# define some variables
from_addr = &quot;1025096440@qq.com&quot;
# this is a code from web mail
from_pwd = &quot;nrbnnibhjrgrbcdd&quot;
to_addr = &quot;1025096440@qq.com&quot;
smtp_srv = &quot;smtp.qq.com&quot;

# write message
text_msg = MIMEText(&quot;第一封邮件&quot;, &quot;plain&quot;, &quot;utf-8&quot;)

# add header
text_msg[&#39;From&#39;] = from_addr
text_msg[&#39;To&#39;] = to_addr
text_msg[&#39;Subject&#39;] = &quot;测试&quot;


try:
    # server address need encode to byte,so we need encode it
    # port 465 is a security port which server accept
    srv = smtplib.SMTP_SSL(smtp_srv.encode(), 465)

    # login
    srv.login(from_addr,from_pwd)

    # send text mail
    srv.sendmail(from_addr, [to_addr], text_msg.as_string())
    srv.quit()
except Exception as e:
    print(e)
else:
    print(&quot;done&quot;)
</code></pre>
<p>the following is a text format mail with additional file </p>
<pre><code class="python">import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEBase,MIMEMultipart



# some variables
from_addr = &quot;1025096440@qq.com&quot;
# this is a code from web mail
from_pwd = &quot;nrbnnibhjrgrbcdd&quot;
to_addr = &quot;1025096440@qq.com&quot;
smtp_srv = &quot;smtp.qq.com&quot;
files = r&quot;/home/narcissus/Desktop/1.py&quot;

# initial multipart object
mail_mul = MIMEMultipart()
# add header
mail_mul[&#39;From&#39;] = from_addr
mail_mul[&#39;To&#39;] = to_addr
mail_mul[&#39;Subject&#39;] = &quot;use python email and smtplib module send mail&quot;

# write message
text_msg = MIMEText(&quot;the email include text message and file&quot;, &quot;plain&quot;, &quot;utf-8&quot;)

# add text to multipart object
mail_mul.attach(text_msg)

# add file
with open(files, &quot;rb&quot;) as f:
    line = f.read()
    content = MIMEText(line, &quot;base64&quot;, &quot;utf-8&quot;)
    content[&quot;Content-type&quot;] = &quot;application/octet-stream&quot;
    content[&quot;Content-Disposition&quot;] = &quot;attachment; filename=files&quot;
    mail_mul.attach(content)

# send mail
try:
    # server address need encode to byte,so we need encode it
    # port 465 is a security port which server accept
    srv = smtplib.SMTP_SSL(smtp_srv.encode(), 465)

    # login
    srv.login(from_addr,from_pwd)

    # send text mail
    srv.sendmail(from_addr, [to_addr], mail_mul.as_string())
    srv.quit()
except Exception as e:
    print(e)
else:
    print(&quot;done&quot;)
</code></pre>
<p>the following is a html format mail example.</p>
<pre><code class="python">import smtplib
from email.mime.text import MIMEText

# write message
html_msg = &quot;&quot;&quot;
    &lt;!DOCTYPE html&gt;
    &lt;html lang=&quot;en&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;UTF-8&quot;&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
        &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;
        &lt;title&gt;Document&lt;/title&gt;
        &lt;script src=&quot;./vue.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1 style=&quot;background: #7fedbb&quot;&gt;有情人难成属眷&lt;/h1&gt;
    &lt;/body&gt;
    &lt;/html&gt;
    &quot;&quot;&quot;
html_msg = MIMEText(html_msg, &quot;html&quot;, &quot;utf-8&quot;)
# some variables
from_addr = &quot;1025096440@qq.com&quot;
# this is a code from web mail
from_pwd = &quot;nrbnnibhjrgrbcdd&quot;
to_addr = &quot;1025096440@qq.com&quot;
smtp_srv = &quot;smtp.qq.com&quot;

try:
    # server address need encode to byte,so we need encode it
    # port 465 is a security port which server accept
    srv = smtplib.SMTP_SSL(smtp_srv.encode(), 465)

    # login
    srv.login(from_addr,from_pwd)

    # send html mail
    srv.sendmail(from_addr, [to_addr], html_msg.as_string())
    srv.quit()
except Exception as e:
    print(e)
else:
    print(&quot;done&quot;)
</code></pre>
<p>alternative choose html format or text format, because some fo device can not display html format</p>
<pre><code class="python">import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart



# some variables
from_addr = &quot;1025096440@qq.com&quot;
# this is a code from web mail
from_pwd = &quot;nrbnnibhjrgrbcdd&quot;
to_addr = &quot;1025096440@qq.com&quot;
smtp_srv = &quot;smtp.qq.com&quot;

# initial multipart object
mail_mul = MIMEMultipart(&quot;alternative&quot;)
# add header
mail_mul[&#39;From&#39;] = from_addr
mail_mul[&#39;To&#39;] = to_addr
mail_mul[&#39;Subject&#39;] = &quot;use python email and smtplib module send mail&quot;

# write message
text_msg = MIMEText(&quot;alternative choose text or html style&quot;, &quot;plain&quot;, &quot;utf-8&quot;)

# add text to multipart object
mail_mul.attach(text_msg)

# write html
html_msg = &quot;&quot;&quot;
    &lt;!DOCTYPE html&gt;
    &lt;html lang=&quot;en&quot;&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;UTF-8&quot;&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
        &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;
        &lt;title&gt;Document&lt;/title&gt;
        &lt;script src=&quot;./vue.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1 style=&quot;background: #7fedbb&quot;&gt;有情人难成属眷&lt;/h1&gt;
    &lt;/body&gt;
    &lt;/html&gt;
    &quot;&quot;&quot;
html_msg = MIMEText(html_msg, &quot;html&quot;, &quot;utf-8&quot;)
mail_mul.attach(html_msg)

# send mail
try:
    # server address need encode to byte,so we need encode it
    # port 465 is a security port which server accept
    srv = smtplib.SMTP_SSL(smtp_srv.encode(), 465)

    # login
    srv.login(from_addr,from_pwd)

    # send text mail
    srv.sendmail(from_addr, [to_addr], mail_mul.as_string())
    srv.quit()
except Exception as e:
    print(e)
else:
    print(&quot;done&quot;)
</code></pre>
<hr>
<p>the end! I am really happy that i learn all of them. It is really awesome,nice.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://raw.githubusercontent.com/ssfwshutterbug/ssfwshutterbug.github.io/main/2022/04/23/python/" data-id="cl9ktb7vj002ddta81ph40nyp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-podman" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/04/23/podman/" class="article-date">
  <time datetime="2022-04-23T15:08:55.000Z" itemprop="datePublished">2022-04-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/learn/">learn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/23/podman/">podman</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="podman"><a href="#podman" class="headerlink" title="podman"></a>podman</h1><pre><code class="shell"># create a container
podman run -it -d --name ubuntu ubuntu

# find container pid
container_pid=`podman inspect -f &#123;&#123;.State.Pid&#125;&#125; container_name`

# execute host command in container(only used for network command)
# useful for the container have no ip command
sudo nsenter -t $container_pid -n command
</code></pre>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://raw.githubusercontent.com/ssfwshutterbug/ssfwshutterbug.github.io/main/2022/04/23/podman/" data-id="cl9ktb7vd001ydta8ghriegd8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/container/" rel="tag">container</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pandas" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/04/23/pandas/" class="article-date">
  <time datetime="2022-04-23T15:08:20.000Z" itemprop="datePublished">2022-04-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/learn/">learn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/23/pandas/">pandas</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="pandas"><a href="#pandas" class="headerlink" title="pandas"></a>pandas</h1><p>pandas是python中一个数据处理和科学分析的工具，最为强大的就是数据处理。由于它可以很轻松的处理excel数据，所以也是自动化办公的一个神器。</p>
<h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><p>使用pip来安装pandas，pip需要先配置国内源，不然下载速度很慢</p>
<pre><code class="shell">pip install pandas
</code></pre>
<p>处理excel数据，还需要一个插件（openpyxl）来读取/写入excel</p>
<pre><code class="shell"># openpyxl (3.0.3)    - A Python library to read/write Excel 2010 xlsx/xlsm files
pip install openpyxl
</code></pre>
<h2 id="three-data-type"><a href="#three-data-type" class="headerlink" title="three data type"></a>three data type</h2><table>
<thead>
<tr>
<th>数据结构</th>
<th>维度</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>Series</td>
<td>一维</td>
<td>同构（数据类型相同），表示一列column</td>
</tr>
<tr>
<td>DataFrame</td>
<td>二维</td>
<td>异构，表示一个表格table</td>
</tr>
<tr>
<td>Panel</td>
<td>三维</td>
<td>异构，使用的少</td>
</tr>
</tbody></table>
<p>由于具有DataFrame这种二维数据结构，所以可以处理很多类似数据结构的文件，比如：excel，sql，json等</p>
<h2 id="simple-read-write"><a href="#simple-read-write" class="headerlink" title="simple read write"></a>simple read write</h2><p><strong>读取数据的时候可以直接指定index列<code>index_col=</code></strong></p>
<p><strong>数据如果太长显示不了，可以设置显示宽度<code>pandas.options.display.max_columns=num</code></strong></p>
<h3 id="excel"><a href="#excel" class="headerlink" title="excel"></a>excel</h3><pre><code class="python">import pandas as pd

# 写入数据到excel
data = &#123;&quot;name&quot;:[&quot;韩信&quot;,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,22,24], &quot;score&quot;:[80,90,100]&#125;
df = pd.DataFrame(data)
df.to_excel(&#39;/home/narcissus/Desktop/1.xlsx&#39;)

# 从excel读取数据
pe = pd.read_excel(&quot;/home/narcissus/Desktop/1.xlsx&quot;, index_col=&#39;name&#39;)
print(pe)
</code></pre>
<h3 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h3><p>需要安装数据库连接驱动</p>
<pre><code class="shell">pip install pymysql
</code></pre>
<pre><code class="python">import pandas
import pymysql

host = &#39;192.168.0.105&#39;
user = &#39;pi&#39;
password = input(&quot;password for mysql connection: &quot;)
database = &#39;mytestdb&#39;
con = pymysql.connect(host,user,password,database)

# 读取数据
df = pd.read_sql_query(&#39;select * from ssacount limit 0,10&#39;,con)
print(df)

# 可以将数据库中读取到的数据直接写入excel中
df.to_excel(&#39;~/Desktop/1.xlsx&#39;)
</code></pre>
<h3 id="sqlite"><a href="#sqlite" class="headerlink" title="sqlite"></a>sqlite</h3><pre><code class="python">import sqlite3

con = sqlite3.connect(&quot;testdatabase.db&quot;)
df = pd.read_sql_query(&quot;SELECT * FROM ssacount&quot;, con)
print(df)
</code></pre>
<h3 id="json"><a href="#json" class="headerlink" title="json"></a>json</h3><pre><code class="python">df = pd.read_json(&#39;test.json&#39;)
</code></pre>
<h3 id="csv-tsv-txt"><a href="#csv-tsv-txt" class="headerlink" title="csv/tsv/txt"></a>csv/tsv/txt</h3><p>pandas只有一个<code>read_csv()</code>函数，但是却可以读取这三种文件（文本文件都可以），默认读取csv文件，其分隔符为逗号，所以在读取tsv和txt的时候，要手动设置分隔符<code>sep=&#39;&#39;</code></p>
<pre><code class="python">df = pd.read_csv(&#39;1.csv&#39;)
df = pd.read_csv(&#39;1.tsv&#39;, sep=&#39;\t&#39;)
df = pd.read_csv(&#39;1.txt&#39;, sep=&#39;文件中的特殊分隔符号&#39;)
</code></pre>
<h3 id="写入"><a href="#写入" class="headerlink" title="写入"></a>写入</h3><p>值得注意的是在写入文件之前要确保去掉默认的index，需要设置成自己指定的index，否则再读取文件时，会有一个unamed的列（之前的index列）。其实可以用后面学习的<code>skiprows</code>在读取时指定跳过多少行，以及<code>usecols</code>来跳过指定列</p>
<pre><code class="python">import pandas as pd

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,None,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,None,22,24], &quot;score&quot;:[80,80,80,100]&#125;
df = pd.DataFrame(data)
# 写入文件之前需要去掉默认的index
df.set_index(&#39;name&#39;, inplace=True)
df.to_excel(&#39;~/Desktop/1.xlsx&#39;)
# 读取数据时指定index
df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, index_col=&#39;name&#39;)
print(df)
</code></pre>
<pre><code class="python">df.to_excel(&#39;~/Desktop/1.xlsx&#39;)

df.to_json(&#39;~/Desktop/test.json&#39;)

df.to_sql(&#39;ssacount&#39;, con)
</code></pre>
<p><strong>PS:</strong> 按照目前我的理解，pandas可以完美的完成这些数据文件之间的转换。可以将json，数据库中的数据导入到excel中进行可视化操作。</p>
<h1 id="DataFrame"><a href="#DataFrame" class="headerlink" title="DataFrame"></a>DataFrame</h1><p>作为最重要的一个部分，DataFrame包含了几百种方法和操作，可以对数据进行任何的分析与处理。</p>
<h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><p>创建的方式比较多，但通常都是使用<code>dict</code>来创建。</p>
<pre><code class="python">import pandas as pd

data = &#123;
        &quot;name&quot;:[&quot;韩信&quot;,&quot;李白&quot;,&quot;杜甫&quot;], 
        &quot;age&quot;:[21,22,24], 
        &quot;score&quot;:[80,90,100]
       &#125;
df = pd.DataFrame(data)
print(df)
</code></pre>
<p>每一对key-value作为一个Series(column)，key作为表头，value作为数据</p>
<h2 id="自己指定index"><a href="#自己指定index" class="headerlink" title="自己指定index"></a>自己指定index</h2><p>默认会自动创建一个index列，为从0开始的连续数据。可以自己指定某列为索引列</p>
<pre><code class="python"># 使用set_index()方法
df = df.set_index(&quot;name&quot;)

# 或者在DataFrame中指定index
df = pd.DataFrame(data, index=[&#39;一班&#39;,&#39;二班&#39;,&#39;二班&#39;])
</code></pre>
<p>需要注意的是这个index的数据是可以重复的，并不需要唯一性</p>
<h2 id="通过index找出对应数据"><a href="#通过index找出对应数据" class="headerlink" title="通过index找出对应数据"></a>通过index找出对应数据</h2><p>可以通过<code>loc</code>找出来的条件是设置了index，否则无法找到</p>
<pre><code class="python">sear = df.loc[&#39;一班&#39;]
print(sear)

name     韩信
age      21
score    80
Name: 一班, dtype: object
</code></pre>
<p>可以看出index与其对应数据也是一个<code>dict</code>数据类型</p>
<p>即使设置了index，也可以通过默认的index来查找<code>iloc</code></p>
<pre><code class="python">sear = df.iloc[1]
</code></pre>
<h2 id="指定header"><a href="#指定header" class="headerlink" title="指定header"></a>指定header</h2><p>默认header=0,会使用第0行（index为空）/excel中的第一行作为header，即columns</p>
<pre><code class="python">df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, header=1)
</code></pre>
<p>重新自定义header，能够自定义成功的前提是这个文件本身就没有header，否则原来的header会作为一个数据行成为index=0的那一行</p>
<pre><code class="python">df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, header=None)
# 取指定列
df = df[[1,3]]
# 设置header
df.columns = [1,2]
</code></pre>
<h2 id="查看开头和结尾"><a href="#查看开头和结尾" class="headerlink" title="查看开头和结尾"></a>查看开头和结尾</h2><pre><code class="python"># 默认为5行
df.head()
df.tail()

# 可以自己指定显示多少行
df.head(20)
df.tail(20)
</code></pre>
<h2 id="查看数据信息"><a href="#查看数据信息" class="headerlink" title="查看数据信息"></a>查看数据信息</h2><p><code>.info()</code>提供了很重要的一些信息，包括行，列，数据是否为空，数据类型，内存占用等</p>
<pre><code class="python">import pandas as pd

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,22,24], &quot;score&quot;:[80,80,100]&#125;
df = pd.DataFrame(data)
info = df.info()
print(info)

&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 3 entries, 0 to 2
Data columns (total 3 columns):
 #   Column  Non-Null Count  Dtype 
---  ------  --------------  ----- 
 0   name    3 non-null      object
 1   age     3 non-null      int64 
 2   score   3 non-null      int64 
dtypes: int64(2), object(1)
memory usage: 200.0+ bytes
None
</code></pre>
<h2 id="查看行列数"><a href="#查看行列数" class="headerlink" title="查看行列数"></a>查看行列数</h2><p><code>.shape</code>提供了一个简单快速查看总行数，列数的信息(rows,columns)</p>
<pre><code class="python">info = df.shape
print(info)

(3,3)
</code></pre>
<h2 id="添加与去重"><a href="#添加与去重" class="headerlink" title="添加与去重"></a>添加与去重</h2><h3 id="添加DataFrame"><a href="#添加DataFrame" class="headerlink" title="添加DataFrame"></a>添加DataFrame</h3><ul>
<li>df.append()</li>
<li>pandas.concat([])</li>
</ul>
<p><code>.append()</code>可以将已有的DataFrame追加。但是index不会自动变化，要是index自动变化，需要调用<code>reset_index(drop=True)</code></p>
<p>append如果需要将Series追加到行后面，必须加一个参数<code>ignore_index=True</code></p>
<pre><code class="python">import pandas as pd
import pymysql

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,&quot;韩信&quot;,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,21,22,24], &quot;score&quot;:[80,80,80,100]&#125;
df = pd.DataFrame(data)
tmp_df = df.append(df)
print(tmp_df)

    name  age  score
0   韩信   21     80
1   韩信   21     80
2   李白   22     80
3   杜甫   24    100
0   韩信   21     80
1   韩信   21     80
2   李白   22     80
3   杜甫   24    100
</code></pre>
<pre><code class="python">import pandas as pd

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,&quot;韩信&quot;,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,21,22,24], &quot;score&quot;:[80,80,80,100]&#125;
df = pd.DataFrame(data)
tmp_df = df.append(df).reset_index(drop=True)
print(tmp_df)

    name  age  score
0   韩信   21     80
1   韩信   21     80
2   李白   22     80
3   杜甫   24    100
4   韩信   21     80
5   韩信   21     80
6   李白   22     80
7   杜甫   24    100
</code></pre>
<p>使用concat默认y轴添加，使用axis=1则x轴添加</p>
<pre><code class="python">import pandas as pd

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,&quot;韩信&quot;,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,21,22,24], &quot;score&quot;:[80,80,80,100]&#125;
df = pd.DataFrame(data)
tmp_df = pd.concat([df,df], axis=0).reset_index(drop=True)
print(tmp_df)
</code></pre>
<h3 id="添加Series"><a href="#添加Series" class="headerlink" title="添加Series"></a>添加Series</h3><pre><code class="python">import pandas as pd

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,&quot;韩信&quot;,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,21,22,24], &quot;score&quot;:[80,80,80,100]&#125;
df = pd.DataFrame(data)
add = pd.Series(&#123;&#39;name&#39;:&#39;筱倩&#39;, &#39;age&#39;:30, &#39;score&#39;:88&#125;)
df = df.append(add, ignore_index=True)
print(df)

    name  age  score
0   韩信   21     80
1   韩信   21     80
2   李白   22     80
3   杜甫   24    100
4   筱倩   30     88
</code></pre>
<h3 id="添加列"><a href="#添加列" class="headerlink" title="添加列"></a>添加列</h3><pre><code class="python">df[&#39;column_name&#39;] = []
tmp_df[&#39;add&#39;] = [i for i in range(max(tmp_df.index)+1)]
</code></pre>
<h3 id="找到重复数据"><a href="#找到重复数据" class="headerlink" title="找到重复数据"></a>找到重复数据</h3><p><code>df.dumpllicateed(subset=&#39;column_name&#39;)</code>可以找出指定列的重复index，和True/False的Series。那么如何通过index来找到真正的重复数据？可以通过循环，其实更加简单的方式是使用<code>df.iloc[index]</code>定位</p>
<pre><code class="python">import pandas as pd
import pymysql

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,&quot;韩信&quot;,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,21,22,24], &quot;score&quot;:[80,80,80,100]&#125;
df = pd.DataFrame(data)
dum = df.duplicated(subset=&#39;name&#39;)
# 查看是否存在重复数据
print(dum.any())
dum = dum[dum == True] #可以简化为dum = dum[dum]
info = df.iloc[dum.index]
print(info)

True
    name  age  score
1   韩信   21     80
</code></pre>
<h3 id="去重"><a href="#去重" class="headerlink" title="去重"></a>去重</h3><p><code>.drop_duplicates()</code>可以将追加的重复数据清除，需要加上<code>inplace=True</code>这个参数，否则不会生效。</p>
<ul>
<li>默认会对整个表的数据进行去重，如果需要对指定列，那么添加参数<code>subset=&#39;column_name&#39;</code></li>
</ul>
<pre><code class="python">tmp_df.drop_duplicates(subset=&#39;score&#39;, inplace=True)

    name  age  score
0   韩信   21     80
2   李白   22     80
3   杜甫   24    100
</code></pre>
<p><code>.drop_duplicates()</code>的<code>keep</code>参数：</p>
<ul>
<li>first，保留第一次出现的，默认</li>
<li>last，保留最后一次出现的</li>
<li>False，去除所有重复数据</li>
</ul>
<pre><code class="python">tmp_df.drop_duplicates(inplace=True, keep=&#39;first&#39;)

    name  age  score
0   韩信   21     80
2   李白   22     80
3   杜甫   24    100
</code></pre>
<pre><code class="python">tmp_df.drop_duplicates(inplace=True, keep=&#39;last&#39;)

    name  age  score
1   韩信   21     80
2   李白   22     80
3   杜甫   24    100
</code></pre>
<pre><code class="python">tmp_df.drop_duplicates(inplace=True, keep=False)

Empty DataFrame
Columns: [name, age, score]
Index: []
</code></pre>
<h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><p>通过df[‘column_name’]/df.column_name可以获取Series，通过Series[index]可以获取到指定的值</p>
<pre><code class="python">import pandas as pd

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,&quot;韩信&quot;,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,21,22,24], &quot;score&quot;:[80,80,80,100]&#125;
df = pd.DataFrame(data)
df.name[1] = &#39;筱倩&#39;
df.age[1] = 99
print(df)

    name  age  score
0   韩信   21     80
1   筱倩   99     80
2   李白   22     80
3   杜甫   24    100
</code></pre>
<h2 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h2><p>使用到了<code>df.iloc[index]</code>定位，并用Series进行替换</p>
<pre><code class="python">import pandas as pd

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,&quot;韩信&quot;,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,21,22,24], &quot;score&quot;:[80,80,80,100]&#125;
df = pd.DataFrame(data)
alert = pd.Series(&#123;&#39;name&#39;:&#39;筱倩&#39;, &#39;age&#39;:30, &#39;score&#39;:88&#125;)
df.iloc[1] = alert
print(df)
</code></pre>
<h2 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h2><h3 id="行"><a href="#行" class="headerlink" title="行"></a>行</h3><p>使用到了df[]切片以及追加操作。值得注意的是：在python中可以对list进行切片，但是在pandas中还可以对DataFrame这种二维数据进行切片</p>
<pre><code class="python">import pandas as pd

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,&quot;韩信&quot;,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,21,22,24], &quot;score&quot;:[80,80,80,100]&#125;
df = pd.DataFrame(data)
insert = pd.Series(&#123;&#39;name&#39;:&#39;筱倩&#39;, &#39;age&#39;:30, &#39;score&#39;:88&#125;)
part1 = df[:2]
part2 = df[2:]
df = part1.append(insert, ignore_index=True).append(part2).reset_index(drop=True)
print(df)

    name  age  score
0   韩信   21     80
1   韩信   21     80
2   筱倩   30     88
3   李白   22     80
4   杜甫   24    100
</code></pre>
<h3 id="列"><a href="#列" class="headerlink" title="列"></a>列</h3><pre><code class="python"># num为想插入到第几列前面
df.insert(num, column=&#39;column_name&#39;, value=[])
</code></pre>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><h3 id="行-1"><a href="#行-1" class="headerlink" title="行"></a>行</h3><p>两种方法：</p>
<ul>
<li>使用到了<code>df.drop(index=[], inplace=True)</code></li>
<li>可以使用切片，将需要的数据切出来然后append组合</li>
</ul>
<pre><code class="python">import pandas as pd

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,&quot;韩信&quot;,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,21,22,24], &quot;score&quot;:[80,80,80,100]&#125;
df = pd.DataFrame(data)
insert = pd.Series(&#123;&#39;name&#39;:&#39;筱倩&#39;, &#39;age&#39;:30, &#39;score&#39;:88&#125;)
part1 = df[:1]
part2 = df[2:]
# index后面可以跟一个list集合，也可以是一个range()函数
df.drop(index=2, inplace=True)
# 使用切片然后组合
# df = part1.append(part2).reset_index(drop=True)
print(df)
</code></pre>
<h3 id="列-1"><a href="#列-1" class="headerlink" title="列"></a>列</h3><pre><code class="python">df.drop(columns=[],inplace=True)
</code></pre>
<h2 id="columns"><a href="#columns" class="headerlink" title="columns"></a>columns</h2><p><code>.columns</code>可获取所有列名，返回的是一个列表</p>
<pre><code class="python">print(df.columns)

Index([&#39;name&#39;, &#39;age&#39;, &#39;score&#39;], dtype=&#39;object&#39;)
</code></pre>
<p><code>.rename()</code>可修改列名</p>
<pre><code class="python">df.rename(columns=&#123;&#39;name&#39;:&#39;Name&#39;, &#39;age&#39;:&#39;AGE&#39;&#125;, inplace=True)
</code></pre>
<p><code>col.lower()</code>搭配列表生成式可以转换小写</p>
<pre><code class="python">df.columns = [col.lower() for col in df.columns]
</code></pre>
<h2 id="Null数据行清除"><a href="#Null数据行清除" class="headerlink" title="Null数据行清除"></a>Null数据行清除</h2><p><code>.isnull()</code>找出null数据，null数据显示True，非空数据显示False</p>
<pre><code class="python">print(df.isnull())
</code></pre>
<p><code>.sum()</code>计算总的null数据</p>
<pre><code class="python">print(df.isnull().sum())
</code></pre>
<p><code>.dropna()</code>删除有null数据的行，只要有一个null数据就会清除</p>
<pre><code class="python">df.dropna(inplace=True)
</code></pre>
<p>可以看到这种清除数据的缺点，无法对指定列的Null数据进行清除，所以需要使用到过滤</p>
<pre><code class="python">import pandas as pd

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,None,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,21,None,24], &quot;score&quot;:[80,80,80,100]&#125;
# 为了能够找到手动输入的None数据列，对其进行了转换
df = pd.DataFrame(data).fillna(0)

miss = df.loc[df.name == 0 ].index
df.drop(index=miss, inplace=True)
print(df)

    name   age  score
0   韩信  21.0     80
2   李白   0.0     80
3   杜甫  24.0    100
</code></pre>
<h2 id="Null数据列的清除"><a href="#Null数据列的清除" class="headerlink" title="Null数据列的清除"></a>Null数据列的清除</h2><p><code>.dropna(axis=1)</code>使用了一个参数axis</p>
<pre><code class="python">df.dropna(inplace=True, axis=1)
</code></pre>
<p>为什么是1？在我们使用df.shape的时候返回一个tuple，(rows,columns)，可以看出columns的索引为1</p>
<h2 id="使用mean来填充null数据列"><a href="#使用mean来填充null数据列" class="headerlink" title="使用mean来填充null数据列"></a>使用mean来填充null数据列</h2><p><code>.fillna(column_name, inplace=True)</code>如果将有null的数据列都删除的话， 那么数据的缺失会比较大，可以用平均值来填充</p>
<pre><code class="python">import pandas as pd

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,None,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,None,22,24], &quot;score&quot;:[80,80,80,100]&#125;
df = pd.DataFrame(data)

# 取出age列
age = df[&#39;age&#39;]
# 取平均值
age_mean = age.mean()
# 将age列中的null用平均值填充
age.fillna(age_mean, inplace=True)
print(df)
</code></pre>
<h2 id="获取数据描述"><a href="#获取数据描述" class="headerlink" title="获取数据描述"></a>获取数据描述</h2><p>前面用<code>.info()</code>获取了对DataFrame的描述，但是<code>.describe()</code>可以获取关于数据的描述：包括最大值，最小值，平均值，列数，行数等。既可以是整个DataFrame，也可以是某一列。</p>
<pre><code class="python"># 整个表
print(df.describe())
# age列
print(df[&#39;age&#39;].describe())
</code></pre>
<h2 id="查看某列数据相同数据的个数"><a href="#查看某列数据相同数据的个数" class="headerlink" title="查看某列数据相同数据的个数"></a>查看某列数据相同数据的个数</h2><p><code>.value_counts()</code>指定列的数据出现个数</p>
<pre><code class="python">print(df[&#39;score&#39;].value_counts())
</code></pre>
<h2 id="重组DataFrame"><a href="#重组DataFrame" class="headerlink" title="重组DataFrame"></a>重组DataFrame</h2><p><code>type(df[&#39;age&#39;])</code>的类型是一个serise，而<code>type(df[[&#39;age&#39;]])</code>的类型是一个DataFrame，所以可以使用这种方式来重新选取需要的列构成新的DataFrame</p>
<pre><code class="python">new_df = df[[&#39;name&#39;, &#39;age&#39;]]
print(new_df)
</code></pre>
<h2 id="数据的过滤"><a href="#数据的过滤" class="headerlink" title="数据的过滤"></a>数据的过滤</h2><h3 id="在Series的基础上过滤"><a href="#在Series的基础上过滤" class="headerlink" title="在Series的基础上过滤"></a>在Series的基础上过滤</h3><p>用条件判断来过滤数据：<code>&gt; &lt; == !=</code>等</p>
<pre><code class="python">info = (df[&#39;score&#39;] == 80)
print(info)

# 可以得到true of false的返回值
0     True
1     True
2     True
3    False
</code></pre>
<p>如果想要直接得到过滤后的数据</p>
<pre><code class="python">info = df[df[&#39;score&#39;] == 80]
print(info)

   name   age  score
0    韩信  21.0     80
1   None   NaN     80
2    李白  22.0     80
</code></pre>
<p>还可以使用逻辑判断</p>
<pre><code class="python">info = df[(df[&#39;score&#39;] &gt; 80) | (df[&#39;age&#39;] == 22)]
</code></pre>
<p>使用<code>isin()</code>更加简洁</p>
<pre><code class="python">info = df[df[&#39;age&#39;].isin([21,22])]
</code></pre>
<p><em><strong>上面的所有方法都很简洁，但是数据量比较大的时候，效率就比较低</strong></em></p>
<p>所以我们需要使用函数来进行过滤，使用<code>.apply()</code>将column传递给函数</p>
<pre><code class="python">def filter_score(x):
    if x == 100:
        return True
    else:
        return False
info = df.loc[df[&#39;score&#39;].apply(filter_score)]
# 简化
info = df[df[&#39;score&#39;].apply(filter_score)]
# 简化，其实我不理解为什么可以这么写
info = df[df.score.apply(filter_score)]
</code></pre>
<p>可以使用匿名函数简化</p>
<pre><code class="python">info = df[df[&#39;score&#39;].apply(lambda x : x == 100)]
# 再简化
info = df[df.score.apply(lambda x : x == 100)]
</code></pre>
<h3 id="在DataFrame基础上过滤"><a href="#在DataFrame基础上过滤" class="headerlink" title="在DataFrame基础上过滤"></a>在DataFrame基础上过滤</h3><p><code>axis=1</code>表示每一行（x轴），<code>axis=0</code>表示每一列（y轴）</p>
<pre><code class="python">def filter_score(x):
    if x.score == 100:
        return True
    else:
        return False

info = df.apply(filter_score， axis=1)
print(info)
</code></pre>
<h2 id="从指定行或列开始读取"><a href="#从指定行或列开始读取" class="headerlink" title="从指定行或列开始读取"></a>从指定行或列开始读取</h2><p>可能表格并不是从第一行第一列开始写的，所以需要指定从哪里开始读取，否则会出现许多的unamed row和Nan值</p>
<pre><code class="python">import pandas as pd 

df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;)
print(df)

# 这里包含了一个空行，和一个index列，读取的时候会出现这些问题
Unnamed: 0 Unnamed: 1 Unnamed: 2 Unnamed: 3
0         NaN       name        age      score
1         0.0         韩信         21         80
2         1.0         韩信         22         80
3         2.0         李白         22         80
4         3.0         杜甫         24        100
</code></pre>
<p>使用<code>skiprows(num)</code>和<code>usecols=[]</code>来选取需要的数据</p>
<pre><code class="python">import pandas as pd 

df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, skiprows=1, usecols=[1,2,3])
# 或者使用列名指定
df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, skiprows=1, usecols=[&#39;name&#39;,&#39;age&#39;,&#39;score&#39;])
print(df)

# 这样就能读取需要的数据了
    name  age  score
0   韩信   21     80
1   韩信   22     80
2   李白   22     80
3   杜甫   24    100
</code></pre>
<h2 id="自动填充功能"><a href="#自动填充功能" class="headerlink" title="自动填充功能"></a>自动填充功能</h2><p>用python来实现excel中拖拽自动填充的功能，生成序列数据进行填充，比较复杂的是日期的处理</p>
<ul>
<li>连续数据：list赋值</li>
<li>交叉数据：三目运算</li>
<li>日期数据：自定义函数</li>
</ul>
<pre><code class="python">import pandas as pd
from datetime import date,timedelta

data = &#123;&#39;name&#39;:[&#39;李白&#39;,&#39;杜甫&#39;,&#39;白居易&#39;,&#39;王维&#39;], &#39;age&#39;:[None,None,None,None], &#39;birthday&#39;:[None,None,None,None], &#39;drink&#39;:[None,None,None,None]&#125;
df = pd.DataFrame(data)
print(df)

=======================================================================================
    name   age birthday drink
0   李白  None     None  None
1   杜甫  None     None  None
2  白居易  None     None  None
3   王维  None     None  None
=======================================================================================

# 初始化日期
start = date(1600,1,31)
# 定义日期处理函数，传一个开始日期以及添加的月份
def add_month(start_date, add_month):
    tmonth = start_date.month + add_month
    cyear = start_date.year + tmonth // 12 
    cmonth = 12 if tmonth % 12  == 0 else tmonth % 12
    cday = start_date.day
    # 由于不同月份的天数不同，所以需要考虑
    if cday &gt; 28:
        if cmonth == 2:
            cday = 29 if cyear % 4 == 0 and cyear % 100 != 0 or cyear % 400 == 0 else 28
        elif cday == 31 and cmonth in [1,3,5,7,8,10,12]:
            cday = 31
        elif cday == 31 and cmonth in [2,4,6,9,11]:
            cday = 30
    return date(cyear,cmonth,cday)

# 对age进行填充，使用到了list的赋值
df[&#39;age&#39;] = [i+20 for i in range(df.shape[1])]
# 使用循环index，来对每一项进行赋值
for i in df.index:
    # 用到了三目运算，实现交叉数据填充
    df[&#39;drink&#39;][i] = &#39;like&#39; if i % 2 == 0 else &#39;hate&#39;
    
    # day递增的情况：day的相加有对应的函数
    df[&#39;birthday&#39;][i] = start + timedelta(days=i)
    # year递增的情况：year的相加可以在year上直接添加
    df[&#39;birthday&#39;][i] = date(start.year+i, start.month, start.day)
    # month递增的情况：比较复杂，涉及到year与month进位的问题，调用自定义函数实现
    df[&#39;birthday&#39;][i] = add_month(start,i+10)

print(df)

=======================================================================================
    name  age    birthday drink
0   李白   20  1600-11-30  like
1   杜甫   21  1601-12-31  hate
2  白居易   22  1601-01-31  like
3   王维   23  1601-02-28  hate
=======================================================================================
</code></pre>
<h2 id="计算功能"><a href="#计算功能" class="headerlink" title="计算功能"></a>计算功能</h2><h3 id="x轴向乘法"><a href="#x轴向乘法" class="headerlink" title="x轴向乘法"></a>x轴向乘法</h3><p>使用到了pandas特有的list相乘，以及list展开相乘（这在python语法中是没有的，乘也是list的复制）</p>
<pre><code class="python">sr1 = pd.Series([21,18,22,24])
sr2 = pd.Series([80,80,80,100])
df = pd.DataFrame(&#123;&#39;A&#39;:sr1, &#39;B&#39;:sr2&#125;)
print(df)

# pandas的list乘
df[&#39;C&#39;] = df[&#39;A&#39;] * df[&#39;B&#39;]
df[&#39;D&#39;] = df[&#39;C&#39;] * 100
# 可以使用apply()
df[&#39;E&#39;] = df[&#39;B&#39;].apply(lambda x:x+2)

print(df)

A    B
0  21   80
1  18   80
2  22   80
3  24  100
    A    B     C       D    E
0  21   80  1680  168000   82
1  18   80  1440  144000   82
2  22   80  1760  176000   82
3  24  100  2400  240000  102
</code></pre>
<h3 id="x轴向求和-平均"><a href="#x轴向求和-平均" class="headerlink" title="x轴向求和/平均"></a>x轴向求和/平均</h3><p>前面都是使用的Series来进行计算的，如果需要的不止一列的数据呢？比如说需要每一行的和和平均值，当然也可以将所有列写出来计算，但是有点麻烦，其实可以指定轴。它会自动过滤掉文字列，只计算数字列。(索引不会计算)</p>
<p><code>axis=1</code>指定x轴，按行计算，从上到下</p>
<pre><code class="python">import pandas as pd
df1 = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, sheet_name=&#39;Sheet1&#39;)
df2 = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, sheet_name=&#39;Sheet2&#39;)

table = df1.join(df2, how=&#39;left&#39;).fillna(0)
table[&#39;qq&#39;] = table[&#39;qq&#39;].astype(int)

table[&#39;sum&#39;] = table.sum(axis=1)
table[&#39;mean&#39;] = table.mean(axis=1).astype(int)
print(table)

    name  age  score student          qq         sum        mean
0   韩信   21     80      韩信   124242423   124242524    62121262
1   赵云   22     10      赵云    12342356    12342388     6171194
2   李白   22     30      李白   574534563   574534615   287267307
3   杜甫   24    100      杜甫     6785842     6785966     3392983
4   曹操   18     75      曹操    34563342    34563435    17281717
5   姜尚   45     75      姜尚    57845262    57845382    28922691
6   阿狗   23     11      阿狗    45645834    45645868    22822934
7   筱倩    3     99      筱倩    58364743    58364845    29182422
8   夫子  123    107      夫子  4824854834  4824855064  2412427532
9   葛聂   33     90       0           0         123          61
</code></pre>
<h3 id="y轴向求和-平均并添加到DataFrame"><a href="#y轴向求和-平均并添加到DataFrame" class="headerlink" title="y轴向求和/平均并添加到DataFrame"></a>y轴向求和/平均并添加到DataFrame</h3><ul>
<li>必须设置<code>ignore_index=True</code>，否则无法添加</li>
</ul>
<pre><code class="python">import pandas as pd
df1 = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, sheet_name=&#39;Sheet1&#39;)
df2 = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, sheet_name=&#39;Sheet2&#39;)

table = df1.join(df2, how=&#39;left&#39;).fillna(0)
table[&#39;qq&#39;] = table[&#39;qq&#39;].astype(int)

# 这里省略了axis=0,因为这是默认值
total = table.mean()
sum = table.sum()
# total为一个Series，可以设置name值
total[&#39;name&#39;] = &#39;平均值&#39;
sum[&#39;name&#39;] = &#39;总和&#39;
# 将Nan转为空
table = table.append([total,sum], ignore_index=True).fillna(&#39;&#39;)
print(table)

name    age  score student            qq
0    韩信   21.0   80.0      韩信  1.242424e+08
1    赵云   22.0   10.0      赵云  1.234236e+07
2    李白   22.0   30.0      李白  5.745346e+08
3    杜甫   24.0  100.0      杜甫  6.785842e+06
4    曹操   18.0   75.0      曹操  3.456334e+07
5    姜尚   45.0   75.0      姜尚  5.784526e+07
6    阿狗   23.0   11.0      阿狗  4.564583e+07
7    筱倩    3.0   99.0      筱倩  5.836474e+07
8    夫子  123.0  107.0      夫子  4.824855e+09
9    葛聂   33.0   90.0       0  0.000000e+00
10  平均值   33.4   67.7          5.739179e+08
11   总和  334.0  677.0          5.739179e+09
</code></pre>
<h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><p><code>.sort_values(by=[],inplace=True,ascending=[False])</code></p>
<p>默认生成一个新的DataFrame，使用inplace=True在原DataFrame上修改</p>
<p>默认使用升序排列，用ascending=False来降序排列</p>
<ol>
<li>对一列数据进行排序</li>
</ol>
<pre><code class="python">import pandas as pd

sr2 = pd.Series([21,18,22,22,24])
sr3 = pd.Series([80,80,60,80,100])
df = pd.DataFrame(&#123;&#39;A&#39;:sr2, &#39;B&#39;:sr3&#125;)
df.set_index(&#39;A&#39;, inplace=True)
df.sort_values(by=&#39;A&#39;, inplace=True, ascending=False)
print(df)
</code></pre>
<ol start="2">
<li>对多列数据进行排序，而且第一列倒序，第二列升序</li>
</ol>
<pre><code class="python">import pandas as pd

sr2 = pd.Series([21,18,22,22,24])
sr3 = pd.Series([80,80,60,80,100])
df = pd.DataFrame(&#123;&#39;A&#39;:sr2, &#39;B&#39;:sr3&#125;)
df.set_index(&#39;A&#39;, inplace=True)
df.sort_values(by=[&#39;A&#39;,&#39;B&#39;], inplace=True, ascending=[False,True])
print(df)
</code></pre>
<h2 id="数据相关性"><a href="#数据相关性" class="headerlink" title="数据相关性"></a>数据相关性</h2><p>之前在一篇文章中看到<code>df.corr()</code>时，没看懂它到底什么意思，有什么作用。今天看了老师讲的视频，才发现这个东西超级无敌厉害。它就是分析一个表中每两列数据之间的相关性的。</p>
<ul>
<li>1.0代表完全相关</li>
<li>比例越大，相关性越大</li>
</ul>
<pre><code class="python">import pandas as pd

sr2 = pd.Series([21,18,22,22,24])
sr3 = pd.Series([80,80,60,80,100])
df = pd.DataFrame(&#123;&#39;age&#39;:sr2, &#39;score&#39;:sr3&#125;)
df.corr()


# 可以看出score与age之间的相关性比较小，仅有0.3
            age    score
age        1.000000    0.322749
score    0.322749    1.000000
</code></pre>
<h2 id="从不同sheet页读取"><a href="#从不同sheet页读取" class="headerlink" title="从不同sheet页读取"></a>从不同sheet页读取</h2><pre><code class="python">import pandas as pd
df1 = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, sheet_name=&#39;Sheet1&#39;)
df2 = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, sheet_name=&#39;Sheet2&#39;)

print(df1)
print(df2)
# table = df1.merge(df2, on=&#39;name&#39;)
# print(table)
    name  age  score
0   韩信   21     80
1   赵云   22     10
2   李白   22     30
3   杜甫   24    100
4   曹操   18     75
5   姜尚   45     75
6   阿狗   23     11
7   筱倩    3     99
8   夫子  123    107
9   葛聂   33     90
  name          qq
0   韩信   124242423
1   赵云    12342356
2   李白   574534563
3   杜甫     6785842
4   曹操    34563342
5   姜尚    57845262
6   阿狗    45645834
7   筱倩    58364743
8   夫子  4824854834
</code></pre>
<h2 id="多表联合查询"><a href="#多表联合查询" class="headerlink" title="多表联合查询"></a>多表联合查询</h2><p>用到了与数据库类似的操作，merge两个DataFrame，默认为inner join,可以设置left/right join</p>
<ul>
<li><code>df.merge()</code>需要指定关联的列，具有内连接，左/右连接</li>
<li><code>df.join()</code>默认使用index作为关联的列，不具有内连接，左/右连接</li>
<li><code>pandas.concat([],axis=num)</code></li>
</ul>
<pre><code class="python">import pandas as pd
df1 = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, sheet_name=&#39;Sheet1&#39;)
df2 = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, sheet_name=&#39;Sheet2&#39;)

table = df1.merge(df2, on=&#39;name&#39;)
print(table)

    name  age  score          qq
0   韩信   21     80   124242423
1   赵云   22     10    12342356
2   李白   22     30   574534563
3   杜甫   24    100     6785842
4   曹操   18     75    34563342
5   姜尚   45     75    57845262
6   阿狗   23     11    45645834
7   筱倩    3     99    58364743
8   夫子  123    107  4824854834
</code></pre>
<p>可以发现默认是使用的inner join，要df1的数据全部显示出来，使用left join方式</p>
<pre><code class="python">table = df1.merge(df2, how=&#39;left&#39;, on=&#39;name&#39;)
</code></pre>
<p>如果要关联的两张表的columns名字不同，那么不能使用<code>on</code>，而需要使用<code>left_on=&#39;&#39;,right_on=&#39;&#39;</code>来连接</p>
<pre><code class="python">    name  age  score
0   韩信   21     80
1   赵云   22     10
2   李白   22     30
3   杜甫   24    100
4   曹操   18     75
5   姜尚   45     75
6   阿狗   23     11
7   筱倩    3     99
8   夫子  123    107
9   葛聂   33     90

  student          qq
0      韩信   124242423
1      赵云    12342356
2      李白   574534563
3      杜甫     6785842
4      曹操    34563342
5      姜尚    57845262
6      阿狗    45645834
7      筱倩    58364743
8      夫子  4824854834
</code></pre>
<p>关联之后数据会出现Nan值，使用<code>fillna()</code>函数来填充null</p>
<p>如果显示的是小数或者科学计数，可以使用<code>astype()</code>设置为数据类型</p>
<pre><code class="python">import pandas as pd

df1 = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, sheet_name=&#39;Sheet1&#39;)
df2 = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, sheet_name=&#39;Sheet2&#39;)

table = df1.merge(df2, how=&#39;left&#39;, left_on=&#39;name&#39;, right_on=&#39;student&#39;).fillna(0)
table[&#39;qq&#39;] = table[&#39;qq&#39;].astype(int)
print(table)

    name  age  score student          qq
0   韩信   21     80      韩信   124242423
1   赵云   22     10      赵云    12342356
2   李白   22     30      李白   574534563
3   杜甫   24    100      杜甫     6785842
4   曹操   18     75      曹操    34563342
5   姜尚   45     75      姜尚    57845262
6   阿狗   23     11      阿狗    45645834
7   筱倩    3     99      筱倩    58364743
8   夫子  123    107      夫子  4824854834
9   葛聂   33     90       0           0
</code></pre>
<p>使用<code>join()</code>函数</p>
<pre><code class="python">import pandas as pd
df1 = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, sheet_name=&#39;Sheet1&#39;)
df2 = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, sheet_name=&#39;Sheet2&#39;)

table = df1.join(df2, how=&#39;left&#39;).fillna(0)
table[&#39;qq&#39;] = table[&#39;qq&#39;].astype(int)
print(table)

    name  age  score student          qq
0   韩信   21     80      韩信   124242423
1   赵云   22     10      赵云    12342356
2   李白   22     30      李白   574534563
3   杜甫   24    100      杜甫     6785842
4   曹操   18     75      曹操    34563342
5   姜尚   45     75      姜尚    57845262
6   阿狗   23     11      阿狗    45645834
7   筱倩    3     99      筱倩    58364743
8   夫子  123    107      夫子  4824854834
9   葛聂   33     90       0           0
</code></pre>
<h2 id="数据列分割"><a href="#数据列分割" class="headerlink" title="数据列分割"></a>数据列分割</h2><p>使用到了<code>Series.str.split()</code>方法，另外<code>Series.str</code>有很多方法可以用，可以对字符串进行各种操作。</p>
<pre><code class="python">import pandas as pd 

data = &#123;&#39;A&#39;:[&quot;hello joyce&quot; for i in range(1,8)]&#125;
df = pd.DataFrame(data)
# 不使用expand，那么数据会作为一个list
info = df.A.str.split(expand=True)
df[&#39;first&#39;] = info[0]
df[&#39;last&#39;] = info[1]
print(df)
</code></pre>
<h2 id="行列转换"><a href="#行列转换" class="headerlink" title="行列转换"></a>行列转换</h2><p><code>df.transpose()</code>即可，为了避免旋转后第一行为index，所以在读取的时候需要指定index</p>
<pre><code class="python">import pandas as pd

df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, index_col=&#39;name&#39;)
df = df.transpose()
print(df)
</code></pre>
<h2 id="提取日期"><a href="#提取日期" class="headerlink" title="提取日期"></a>提取日期</h2><pre><code class="python">pandas.DatetimeIndex(df[&#39;column_name&#39;]).year
pandas.DatetimeIndex(df[&#39;column_name&#39;]).month
pandas.DatetimeIndex(df[&#39;column_name&#39;]).day
</code></pre>
<h2 id="分组，聚合"><a href="#分组，聚合" class="headerlink" title="分组，聚合"></a>分组，聚合</h2><p>模拟透视表功能</p>
<pre><code class="python">import pandas as pd
import numpy as np

df.pivot_table(index=&#39;column_name&#39;, columns=&#39;column_name&#39;, value=&#39;column_name&#39;, aggfunc=np.sum)
</code></pre>
<p>分组</p>
<pre><code class="python">groups = df.groupby(&#39;column_name&#39;)
</code></pre>
<p>聚合</p>
<pre><code class="python">S = groups[&#39;column_name&#39;].sum()
</code></pre>
<h2 id="条件颜色"><a href="#条件颜色" class="headerlink" title="条件颜色"></a>条件颜色</h2><pre><code class="python">import pandas as pd 

def colorlize(x):
    colors = &#39;orange&#39; if x &lt; 60 else &#39;lime&#39;
    # 这里返回的格式必须要是这样
    return f&#39;color:&#123;colors&#125;&#39;

def another(x):
    # 这里需要返回一个list
    return [&#39;color:red&#39; if v &gt; 90 else &#39;background-color:black&#39; for v in x] 
    
df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;)

# 可直接添加在后面
# df.style.apply(another, subset=[&#39;age&#39;,&#39;score&#39;])
df.style.applymap(colorlize, subset=[&#39;age&#39;,&#39;score&#39;]).apply(another, subset=[&#39;age&#39;,&#39;score&#39;])
</code></pre>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200418202939418.png" alt="image-20200418202939418"></p>
<p>需要注意的：</p>
<ul>
<li><code>df.style.applymap()</code>获取到的是每一个值</li>
<li><code>df.style.apply()</code>获取到的是一个Series，但是需要用for循环读取每一个值，这和之前用的<code>df.apply()</code>自动循环每一个值不同</li>
</ul>
<h2 id="颜色条"><a href="#颜色条" class="headerlink" title="颜色条"></a>颜色条</h2><pre><code class="python">import pandas as pd 

df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;)
df.style.bar(color=&#39;pink&#39;, subset=[&#39;age&#39;,&#39;score&#39;])
</code></pre>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200418204331053.png" alt="image-20200418204331053"></p>
<h2 id="渐变颜色"><a href="#渐变颜色" class="headerlink" title="渐变颜色"></a>渐变颜色</h2><p>需要下载seaborn模块</p>
<pre><code class="python">pip install seaborn
</code></pre>
<pre><code class="python">import pandas as pd 
import seaborn as sn

df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;)
color_map = sn.light_palette(&#39;pink&#39;, as_cmap=True)

df.style.background_gradient(color_map, subset=[&#39;age&#39;, &#39;score&#39;])
</code></pre>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200418204439512.png" alt="image-20200418204439512"></p>
<hr>
<h1 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h1><h2 id="Series序列"><a href="#Series序列" class="headerlink" title="Series序列"></a>Series序列</h2><p>用来生成一维数据。类似list数据类型</p>
<pre><code class="python">import pandas as pd

data = &#123;&quot;name&quot;:[&quot;韩信&quot;,&quot;貂蝉&quot;,&quot;李白&quot;,&quot;杜甫&quot;], &quot;age&quot;:[21,18,22,24], &quot;score&quot;:[80,80,80,100]&#125;
sr = pd.Series(data)
print(sr)

name      [韩信, 貂蝉, 李白, 杜甫]
age       [21, 18, 22, 24]
score    [80, 80, 80, 100]
</code></pre>
<h2 id="Series组装DataFrame"><a href="#Series组装DataFrame" class="headerlink" title="Series组装DataFrame"></a>Series组装DataFrame</h2><ol>
<li>使用<code>dict</code>组装。不指定index时，使用默认的index</li>
</ol>
<pre><code class="python">import pandas as pd

sr1 = pd.Series([&quot;韩信&quot;,&quot;貂蝉&quot;,&quot;李白&quot;,&quot;杜甫&quot;])
sr2 = pd.Series([21,18,22,24])
sr3 = pd.Series([80,80,80,100])
df = pd.DataFrame(&#123;&#39;name&#39;:sr1, &#39;age&#39;:sr2, &#39;score&#39;:sr3&#125;)
print(df)

  name  age  score
0   韩信   21     80
1   貂蝉   18     80
2   李白   22     80
3   杜甫   24    100
</code></pre>
<ol start="2">
<li>还可以手动指定index</li>
</ol>
<pre><code class="python">import pandas as pd

sr1 = pd.Series([&quot;韩信&quot;,&quot;貂蝉&quot;,&quot;李白&quot;,&quot;杜甫&quot;], index=(1,2,3,4), name=&#39;name&#39;)
sr2 = pd.Series([21,18,22,24], index=(1,2,3,4), name=&#39;age&#39;)
sr3 = pd.Series([80,80,80,100], index=(1,2,3,4))
df = pd.DataFrame(&#123;sr1.name:sr1, sr2.name:sr2, sr3.name:sr3&#125;)
print(df)

  name  age  NaN
1   韩信   21   80
2   貂蝉   18   80
3   李白   22   80
4   杜甫   24  100
</code></pre>
<ol start="3">
<li>使用<code>list</code>组装。如果不指定index和name，那么会用默认的index来填充columns和index</li>
</ol>
<pre><code class="python">import pandas as pd

sr1 = pd.Series([&quot;韩信&quot;,&quot;貂蝉&quot;,&quot;李白&quot;,&quot;杜甫&quot;],  index=(1,2,3,4), name=&#39;name&#39;)
sr2 = pd.Series([21,18,22,24], index=(1,2,3,4), name=&#39;age&#39;)
sr3 = pd.Series([80,80,80,100], index=(1,2,3,4), name=&#39;score&#39;)
df = pd.DataFrame([sr1, sr2, sr3])
print(df)

        1   2   3    4
name   韩信  貂蝉  李白   杜甫
age    21  18  22   24
score  80  80  80  100
</code></pre>
<p><em>可以发现，使用list来组装DataFrame时，会将Series以行的形式展示。如果用dict来组装，那么会将Series以列的形式组装。</em></p>
<h2 id="DataFrame取出Series"><a href="#DataFrame取出Series" class="headerlink" title="DataFrame取出Series"></a>DataFrame取出Series</h2><p>两种方式：</p>
<ul>
<li>这种就是python自身的语法，DataFrame由字典组成，所以使用<code>df[&#39;column_name&#39;]</code>即可</li>
<li>使用pandas DataFrame数据结构的语法，<code>df.column_name</code>也可以</li>
</ul>
<hr>
<h1 id="制图"><a href="#制图" class="headerlink" title="制图"></a>制图</h1><p>pandas是构建于matplotlib之上，所以需要先下载</p>
<pre><code class="python"># matplotlib (3.2.1)                 - Python plotting package
pip install matplotlib
</code></pre>
<p>使用到的数据：</p>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200417203430726.png" alt="1.xlsx"></p>
<h2 id="柱状图"><a href="#柱状图" class="headerlink" title="柱状图"></a>柱状图</h2><p>第一个例子：</p>
<pre><code class="python">import pandas as pd 
import matplotlib.pyplot as plt


df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, skiprows=1, usecols=[1,2,3,4])
# 先排score，再排age，从大到小
df.sort_values(by=[&#39;score&#39;,&#39;age&#39;], inplace=True, ascending=False)
# pandas支持制图
df.plot.bar(x=&#39;name&#39;, y=[&#39;score&#39;,&#39;age&#39;], color=[&#39;lightblue&#39;,&#39;orange&#39;])
# 紧凑显示
plt.tight_layout()
# 使用matplotlib来渲染
plt.show()
</code></pre>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200417192602580.png" alt="image-20200417192602580"></p>
<h2 id="中文支持"><a href="#中文支持" class="headerlink" title="中文支持"></a>中文支持</h2><p>默认matplotlib无法显示中文，需要从matplotlib导入font_manager</p>
<pre><code class="python">from matplotlib import font_manager
</code></pre>
<p>查看有那些中文字体</p>
<pre><code class="shell">fc-list :lang=zh

/usr/share/fonts/wenquanyi/wqy-microhei/wqy-microhei.ttc: WenQuanYi Micro Hei,文泉驛微米黑,文泉驿微米黑:style=Regular
/usr/share/fonts/wenquanyi/wqy-microhei/wqy-microhei.ttc: WenQuanYi Micro Hei Mono,文泉驛等寬微米黑,文泉驿等宽微米黑:style=Regular
</code></pre>
<p>设置font变量</p>
<pre><code class="python">font = font_manager.FontProperties(fname=&quot;/usr/share/fonts/wenquanyi/wqy-microhei/wqy-microhei.ttc&quot;)
</code></pre>
<p>在需要显示中文的地方加上fontproperties属性。需要注意只有matplotlib才能加这个属性，所以在需要加这个属性的时候，要用matplotlib来设置</p>
<pre><code class="python">plt.xticks(rotation=40, fontproperties=font)
</code></pre>
<h2 id="使用matplotlib修饰"><a href="#使用matplotlib修饰" class="headerlink" title="使用matplotlib修饰"></a>使用matplotlib修饰</h2><p>matpllotlib比pandas自带的制图功能要多，可定制性更强。导入matplotlib的作用呢就是来补充pandas自身制图功能的一些不足，以及渲染图片。</p>
<p>由于pandas基于matplotlib，所以这两个可完美的搭配使用。在pandas搞不定的地方就用matplotlib来补充</p>
<h2 id="分组柱状图"><a href="#分组柱状图" class="headerlink" title="分组柱状图"></a>分组柱状图</h2><pre><code class="python">import pandas as pd 
import matplotlib.pyplot as plt
from matplotlib import font_manager

font = font_manager.FontProperties(fname=&quot;/usr/share/fonts/wenquanyi/wqy-microhei/wqy-microhei.ttc&quot;)

# 读取
df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, skiprows=1, usecols=[1,2,3,4])
# 排序
df.sort_values(by=[&#39;score&#39;,&#39;age&#39;], inplace=True, ascending=False)
# 用pandas自身绘制分组柱状图
df.plot.bar(x=&#39;name&#39;, y=[&#39;score&#39;,&#39;age&#39;], color=[&#39;lightblue&#39;,&#39;orange&#39;])
# pandas自身绘图的标签不支持中文，那么用matplotlib来让标签显示中文，以及设置一定旋转角度
# plt.xticks(rotation=20, fontproperties=font, fontsize=14)
# 上面这个无法设置旋转中心，所以使用下面的
# gca获取x轴，ha=&#39;right&#39;设置右端对齐
px = plt.gca()
px.set_xticklabels(df[&#39;name&#39;], rotation=20, ha=&#39;right&#39;, fontproperties=font, fontsize=14)
# gcf获取图形的布局
pf = plt.gcf()
pf.subplots_adjust(left=0.1)
# 用matplotlib来设置x轴名称
plt.xlabel(&#39;name&#39;, fontsize=20)
# 用matplotlib来设置y轴名称
plt.ylabel(&#39;score&#39;, fontsize=20)
# 用matplotlib来设置title
plt.title(&#39;学习情况统计表&#39;, fontproperties=font, fontsize=24, color=&#39;lightpink&#39;)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="/home/narcissus/Desktop/Figure_1.png"></p>
<h2 id="叠加柱状图"><a href="#叠加柱状图" class="headerlink" title="叠加柱状图"></a>叠加柱状图</h2><ul>
<li>需要自己新计算一个新的列，这个列的值为需要叠加的数据之和</li>
<li>使用这个新的列作为排序的标准</li>
<li>y轴仍然为之前的列</li>
<li>只不过在df.plot.bar显示的时候加了一个参数<code>stacked=True</code>，声明使用叠加的方式</li>
</ul>
<pre><code class="python">import pandas as pd 
import matplotlib.pyplot  as plt 
from matplotlib import font_manager

font = font_manager.FontProperties(fname=&quot;/usr/share/fonts/wenquanyi/wqy-microhei/wqy-microhei.ttc&quot;)

df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, usecols=[1,2,3,4,5], skiprows=1)
df[&#39;total&#39;] = df[&#39;age&#39;] + df[&#39;score&#39;]
df.sort_values(by=&#39;total&#39;, inplace=True, ascending=False)
df.plot.bar(x=&#39;name&#39;, y=[&#39;score&#39;, &#39;age&#39;], color=[&#39;brown&#39;,&#39;pink&#39;], stacked=True)
px = plt.gca()
px.set_xticklabels(df[&#39;name&#39;], rotation=10, ha=&#39;right&#39;, fontproperties=font)
plt.xlabel(&#39;name&#39;)
plt.ylabel(&#39;count&#39;)
plt.title(&#39;学习情况统计&#39;, fontproperties=font, fontsize=22, fontweight=&#39;bold&#39;)
plt.show()
</code></pre>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200417202420437.png" alt="image-20200417202420437"></p>
<h2 id="水平叠加柱状图"><a href="#水平叠加柱状图" class="headerlink" title="水平叠加柱状图"></a>水平叠加柱状图</h2><p>其实只需要改一个参数就可以了，将<code>df.plot.bar</code>改为<code>df.plot.barh</code>就代表水平展示了。</p>
<ul>
<li>这个时候的排序可能需要调整一下</li>
<li>如果自定义了x轴，y轴的话，需要交换一下</li>
</ul>
<pre><code class="python">import pandas as pd 
import matplotlib.pyplot  as plt 
from matplotlib import font_manager

font = font_manager.FontProperties(fname=&quot;/usr/share/fonts/wenquanyi/wqy-microhei/wqy-microhei.ttc&quot;)

df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, usecols=[1,2,3,4,5], skiprows=1)
df[&#39;total&#39;] = df[&#39;age&#39;] + df[&#39;score&#39;]
df.sort_values(by=&#39;total&#39;, inplace=True)
df.plot.barh(x=&#39;name&#39;, y=[&#39;score&#39;, &#39;age&#39;], color=[&#39;brown&#39;,&#39;pink&#39;], stacked=True)
px = plt.gca()
px.set_yticklabels(df[&#39;name&#39;], rotation=10, ha=&#39;right&#39;, fontproperties=font)
plt.xlabel(&#39;count&#39;)
plt.ylabel(&#39;name&#39;)
plt.title(&#39;学习情况统计&#39;, fontproperties=font, fontsize=22, fontweight=&#39;bold&#39;)
plt.show()
</code></pre>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200417202957849.png" alt="image-20200417202957849"></p>
<h2 id="饼图"><a href="#饼图" class="headerlink" title="饼图"></a>饼图</h2><p>绘制饼图的优点是可以清晰的看出各部分所占的比例</p>
<p>与柱状图不同，饼图需要的数据为一个Series，同时在读取数据的时候指定的index会成为饼图显示的信息</p>
<ul>
<li>饼图注意点还挺多的，最为重要的就是使用pandas来绘制，无法显示中文，所以采用了plt来绘制</li>
<li>采用matplotlib时，也无法直接设置字体，需要用循环给具体的对象赋值</li>
<li>对序列排序，并通过绘制时的顺时针来设置旋转方向</li>
<li>通过startangle来设置最大值从12点方向开始</li>
</ul>
<pre><code class="python">import pandas as pd 
from matplotlib import font_manager as fm 
from matplotlib import pyplot as plt 

font = fm.FontProperties(fname=&quot;/usr/share/fonts/wenquanyi/wqy-microhei/wqy-microhei.ttc&quot;)
df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, skiprows=1, usecols=[1,2,3,4])
# 为了顺序显示，进行排序。这里没有从大到小排是因为后面绘制的时候可以使用counterclock来设置顺时针排序
df.sort_values(by=&#39;score&#39;, inplace=True)
# 使用pandas自身的绘图，无法显示中文，所以不采用
# df[&#39;score&#39;].plot.pie(labels=df[&#39;name&#39;])
# 使用matplotlib来绘制图形，label为标签名
paint = plt.pie(df[&#39;score&#39;], labels=df[&#39;name&#39;], counterclock=True, startangle=-270)
# 即便是通过matplotlib来绘制，中文也不好显示，只能通过返回值来找到text所在位置，并循环设置中文字体
for i in df.index:
    paint[1][i].set_fontproperties(font)
plt.title(&#39;学习情况统计&#39;, fontproperties=font, fontsize=22, fontweight=&#39;bold&#39;)
# ylabel来设置左边显示文字
plt.ylabel(&#39;score&#39;, fontsize=16)
plt.show()
</code></pre>
<p>对数据进行排序之后会出现，比例较小的部分字重叠，这也是一个问题。</p>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200417220253777.png" alt="排序"></p>
<p>所以不对其进行排序显示的效果可能会更好。</p>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200417220601412.png" alt="未排序"></p>
<h2 id="折线图"><a href="#折线图" class="headerlink" title="折线图"></a>折线图</h2><ul>
<li>折线图在绘制的时候，只要直接使用<code>.plot</code>就可以了。需要指定y轴的数据</li>
<li>x轴的数据可以通过指定index来设置</li>
</ul>
<pre><code class="python">import pandas as pd 
from matplotlib import pyplot as plt 
from matplotlib import font_manager as fm 

font = fm.FontProperties(fname=&#39;/usr/share/fonts/wenquanyi/wqy-microhei/wqy-microhei.ttc&#39;)
data = &#123;&#39;score&#39;:[45,76,56,100,93], &#39;age&#39;:[16,18,24,29,35]&#125;
df = pd.DataFrame(data)
df.plot(y=[&#39;score&#39;,&#39;age&#39;])

plt.title(&#39;年龄与分数走势图&#39;,fontproperties=font, fontsize=22)
plt.xlabel(&#39;time&#39;)
plt.xticks(df.index)
plt.ylabel(&#39;count&#39;)
plt.show()
</code></pre>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200417223035065.png" alt="image-20200417223035065"></p>
<h2 id="叠加区域图"><a href="#叠加区域图" class="headerlink" title="叠加区域图"></a>叠加区域图</h2><p>只需要在折线图的基础上将<code>.plot</code>改为<code>.plot.area</code>即可</p>
<pre><code class="python">df.plot.area(y=[&#39;score&#39;,&#39;age&#39;])
</code></pre>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200417223407312.png" alt="image-20200417223407312"></p>
<h2 id="散点图"><a href="#散点图" class="headerlink" title="散点图"></a>散点图</h2><p>散点图就可以看出pandas的处理速度完胜excel，同时交换x，y轴数据，pandas可以轻松搞定，而excel在数据量多的时候无法操作。</p>
<ul>
<li>使用到了<code>df.plot.scatter()</code>来画散点图</li>
</ul>
<pre><code class="python">import pandas as pd
from matplotlib import pyplot as plt
from matplotlib import font_manager as fm 

font = fm.FontProperties(fname=&quot;/usr/share/fonts/wenquanyi/wqy-microhei/wqy-microhei.ttc&quot;)

df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, skiprows=1, usecols=[1,2,3,4])
df.plot.scatter(x=&#39;score&#39;, y=&#39;age&#39;, color=&#39;brown&#39;)
plt.title(&#39;学习与年龄散点图&#39;, fontproperties=font, fontsize=22)
plt.show()
</code></pre>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200418095053048.png" alt="image-20200418095053048"></p>
<h2 id="分布图"><a href="#分布图" class="headerlink" title="分布图"></a>分布图</h2><p>可以清晰的看出指定数据的分布情况。分布图只需要Series就可以</p>
<ul>
<li>使用了<code>Series.plot.hist(bins=num)</code></li>
<li>参数bins设置划分区间，越多图越精细</li>
<li><code>plt.xticks()</code>设置x轴的分段，默认Series分段少，使用range()函数，来设置步长</li>
</ul>
<pre><code class="python">import pandas as pd
from matplotlib import pyplot as plt
from matplotlib import font_manager as fm 

font = fm.FontProperties(fname=&quot;/usr/share/fonts/wenquanyi/wqy-microhei/wqy-microhei.ttc&quot;)

df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, skiprows=1, usecols=[1,2,3,4])
df[&#39;score&#39;].plot.hist(bins=10)
plt.xticks(range(0,max(df[&#39;score&#39;]),4), rotation=90)
plt.xlabel(&#39;score&#39;)
plt.title(&#39;分数分布图&#39;, fontproperties=font, fontsize=20)
plt.show()
</code></pre>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200418103216628.png" alt="image-20200418103216628"></p>
<h2 id="密度图"><a href="#密度图" class="headerlink" title="密度图"></a>密度图</h2><p>直接使用会报错，提示缺少一个scipy的科学库</p>
<pre><code class="python"># scipy (1.4.1)                   - SciPy: Scientific Library for Python
pip install scipy
</code></pre>
<p>密度图同样使用Series</p>
<ul>
<li>使用<code>Series.plot.kde()</code>,其它与分布图类似</li>
</ul>
<pre><code class="python">import pandas as pd
from matplotlib import pyplot as plt
from matplotlib import font_manager as fm 

font = fm.FontProperties(fname=&quot;/usr/share/fonts/wenquanyi/wqy-microhei/wqy-microhei.ttc&quot;)

df = pd.read_excel(&#39;~/Desktop/1.xlsx&#39;, skiprows=1, usecols=[1,2,3,4])
df[&#39;score&#39;].plot.kde()
plt.xlabel(&#39;score&#39;)
plt.title(&#39;密度分布图&#39;, fontproperties=font, fontsize=20)
plt.show()
</code></pre>
<p><img src="/home/narcissus/.config/Typora/typora-user-images/image-20200418104716779.png" alt="image-20200418104716779"></p>
<hr>
<p>终于一口气学完了这个模块，感觉功能确实很多，而且没学到的功能还有很多。但是就目前掌握的这些来说，写个自动化办公的脚本来说已经够了。数据的读取，增删查改，制图等等功能都很好用。虽然是一边看视频，一边敲代码，但是熟悉程度还不够，还的在日常的生活中多用才会熟练。学完一个东西觉得很开心，但是又觉得有点失落，因为我接下来要学什么呢？是个很大的问题。要不学学powershell吧！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://raw.githubusercontent.com/ssfwshutterbug/ssfwshutterbug.github.io/main/2022/04/23/pandas/" data-id="cl9ktb7vc001wdta8aod0c6ee" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-openssh" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/04/23/openssh/" class="article-date">
  <time datetime="2022-04-23T15:07:42.000Z" itemprop="datePublished">2022-04-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/learn/">learn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/23/openssh/">openssh</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="openssh"><a href="#openssh" class="headerlink" title="openssh"></a>openssh</h1><h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><p>in archlinux, openssh is a ssh toolkit, includes client <code>ssh</code> and server <code>sshd</code>. </p>
<pre><code class="shell">pacman -S openssh
</code></pre>
<h2 id="client"><a href="#client" class="headerlink" title="client"></a>client</h2><p>usage examples.</p>
<h3 id="remote-connect"><a href="#remote-connect" class="headerlink" title="remote connect"></a>remote connect</h3><p>connect to remote pc with default port 22.</p>
<pre><code class="shell">ssh user@ip
</code></pre>
<p>connect to remote pc with specified port.</p>
<pre><code class="shell">ssh -p port user@ip
</code></pre>
<h3 id="file-copy"><a href="#file-copy" class="headerlink" title="file copy"></a>file copy</h3><p>we can download file from server and upload file to server in client.</p>
<blockquote>
<p>Note:</p>
<p>whatever we download or upload, we only need a ssh client tool called <code>scp</code>  in local machine, needless server in local. and server runs in remote machine</p>
</blockquote>
<p>download file from server</p>
<pre><code class="shell">scp server_user@server_ip:/file/directory /local/file/directory
</code></pre>
<p>upload file to server</p>
<pre><code class="shell">scp /local/file/directory server_user@server_ip:/file/directory
</code></pre>
<h3 id="root-login"><a href="#root-login" class="headerlink" title="root login"></a>root login</h3><p>add following to allow root user login</p>
<pre><code class="shell">PermitRootLogin yes
</code></pre>
<h3 id="change-default-port"><a href="#change-default-port" class="headerlink" title="change default port"></a>change default port</h3><p>change default port 22 to other ports</p>
<pre><code class="shell">nvim /etc/ssh/sshd_config

Port 40000
</code></pre>
<p>now, connect to the machine need specify port</p>
<pre><code class="shell">ssh -p 40000 user@ip
</code></pre>
<h3 id="login-without-password"><a href="#login-without-password" class="headerlink" title="login without password"></a>login without password</h3><ul>
<li><p><em>machine A: who want to connect to B</em></p>
</li>
<li><p><em>machine B: with ssh service running</em></p>
</li>
</ul>
<p>if we use ssh command often, we can configure it without password to login(A=&gt;B). there are two things we need to do:</p>
<ol>
<li><p>in machine A: need to product a public key</p>
<pre><code class="shell">ssh-keygen
# or Specifies the type of key to create.  The possible values are “dsa”, “ecdsa”, “ecdsa-sk”, “ed25519”, “ed25519-sk”, or “rsa”.
ssh-keygen -t rsa

# this step will create a public key (id_rsa.pub) in ~/.ssh
ls ~/.ssh
  id_rsa       id_rsa.pub       known_hosts
</code></pre>
</li>
<li><p>in machine A: copy public key <code>id_rsa.pub</code>  to B’s <code>~/.ssh/authorized_keys</code></p>
<pre><code class="shell"># in machine A we can use a command to do it, this will copy content to B automaticly
ssh-copy-id user_B@ip_B

# or we can login machine B, and copy content of id_rsa.pub to ~/.ssh/authorized_keys
scp .ssh/id_rsa.pub user_B@ip_B:/tmp
ssh user_B@ip_B
mkdir ~/.ssh
touch ~/.ssh/authorized_keys
cat /tmp/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys
</code></pre>
</li>
</ol>
<p>after the two steps, A can connect to B without password.</p>
<h2 id="issues"><a href="#issues" class="headerlink" title="issues"></a>issues</h2><h3 id="connect-to-an-old-version-ssh-server"><a href="#connect-to-an-old-version-ssh-server" class="headerlink" title="connect to an old version ssh server"></a>connect to an old version ssh server</h3><p><code>Unable to negotiate with x.x.x.x port 22: no matching host key type found. Their offer: ssh-rsa fatal: Could not read from remote repository.</code></p>
<p>this problem comes when the remote ssh encryption method is too old/weak such as isa1. since isa1 method  will be regarded unsafe.</p>
<p>in order to resolve this problem, there comes two methods:</p>
<ol>
<li><p>upgrade remote ssh version and then use the new encryption method such as isa2</p>
</li>
<li><p>write a config in <code>~/.ssh/config</code>, allow the connection specified</p>
</li>
</ol>
<pre><code class="shell">Host 192.168.1.80
    User root
    PubkeyAcceptedAlgorithms +ssh-rsa
    HostkeyAlgorithms +ssh-rsa
</code></pre>
<h2 id="ssh-tunnel"><a href="#ssh-tunnel" class="headerlink" title="ssh tunnel"></a>ssh tunnel</h2><p>there are two parts.</p>
<ul>
<li>local port forwarding</li>
<li>remote port forwarding</li>
</ul>
<img src=".images/image-20210303233558102-1627524858296.png" alt="ssh tunnel" style="zoom: 50%;" />

<h4 id="local-port-forwarding"><a href="#local-port-forwarding" class="headerlink" title="local port forwarding"></a>local port forwarding</h4><img src=".images/image-20210303234044887-1627524858297.png" alt="image-20210303234044887" style="zoom:50%;" />

<p>access local ip with port 8888 with redirect to remote server 192.168.1.3 with port 8080 though ssh server 44.11.22.33</p>
<pre><code class="shell">ssh -L local_port:remote_ip:remote_port ssh_user@ssh_ip
</code></pre>
<p>eg:</p>
<pre><code class="shell">ssh -L 10000:192.168.31.84:8080 root@192.168.31.116
</code></pre>
<p>above means i can visit <code>http://localhost:10000</code> in my pc to visit remote <code>http://192.168.31.84:8080</code> though ssh server <code>192.168.31.116</code>. it builds a ssh tunnel between local and ssh server.</p>
<h4 id="remote-port-forwarding"><a href="#remote-port-forwarding" class="headerlink" title="remote port forwarding"></a>remote port forwarding</h4><p><img src=".images/image-20210303234221412-1627524858297.png" alt="image-20210303234221412"></p>
<p>if any outside machine wanna to access local network service, we can create a ssh tunnel between local network machine with a outside ssh server, then any request to ssh server will redirect to local network service.</p>
<p>any request to ssh server 44.11.22.33 with port 8888 will redirect to 10.0.0.3 with port 8080.</p>
<pre><code class="shell">ssh -R remote_port:local_ip:local_port user@remote_ssh_ip
</code></pre>
<p><strong>much more important for remote port forwarding</strong></p>
<pre><code class="shell"># 192.168.31.214 has a website
# my machine and 192.168.31.214 are the same network, my machine and 192.168.31.221 are the other same network
# execute this command in my machine will create a ssh tunnel between my machine and 221
# then we can visit the website though https://192.168.31.221:4444

ssh -R 4444:192.168.31.214:443 healer@192.168.31.221 -N -f
# -N : don&#39;t allow to execute command in remote machine
# -f : run in background
</code></pre>
<blockquote>
<p>Note:</p>
<p>when the ssh tunnel created successfully, we can only access  website in 214 with localhost(described in <a target="_blank" rel="noopener" href="https://serverfault.com/questions/478171/reverse-ssh-tunnel-connexion-refused">this article</a>), becase ssh disabled gatewayport by default and it only listen on <code>127.0.0.1:port</code> <code>[::1]:port</code>. such as:</p>
</blockquote>
<p><img src=".images/image-20210726105921414.png" alt="image-20210726105921414"></p>
<p><strong>in order to access remote machine with ip address, we need enable gatewayport</strong></p>
<pre><code class="shell">vim /etc/ssh/sshd_config

GatewayPorts yes
</code></pre>
<p>then recreate ssh tunnel in my machine and  restart sshd of 214</p>
<p><img src=".images/image-20210726110546994.png" alt="image-20210726110546994"></p>
<p>then all will be okay</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://raw.githubusercontent.com/ssfwshutterbug/ssfwshutterbug.github.io/main/2022/04/23/openssh/" data-id="cl9ktb7va001ndta8fhhxg4qr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssh/" rel="tag">ssh</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-noResponseGrub" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/04/23/noResponseGrub/" class="article-date">
  <time datetime="2022-04-23T15:07:11.000Z" itemprop="datePublished">2022-04-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/learn/">learn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/23/noResponseGrub/">noResponseGrub</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="issue"><a href="#issue" class="headerlink" title="issue"></a>issue</h2><p>在grub双启动界面无法用键盘进行上下移动选择需要的启动项，并且也无法用del键进入bios</p>
<h2 id="analysize"><a href="#analysize" class="headerlink" title="analysize"></a>analysize</h2><p>无论是方向键还是del键都不起作用，推测是grub启动的时候未识别到键盘，或者配置了什么参数导致grub freeze。google搜索了一下，发现有人遇到过这个问题，是因为在bios中设置了快速启动，所以我需要进bios中将快速启动关掉试试。然而现在的问题是无法进入bios</p>
<h2 id="resolve"><a href="#resolve" class="headerlink" title="resolve"></a>resolve</h2><p>那么现在需要解决如何进入bios的问题，键盘没有反应肯定是不行了。之前设置过usb始终作为第一个启动项，所以将usb插上后可能就会进入usb的启动界面，或许键盘可以用。然而usb似乎是没有识别出来，所以还是只能在之前的grub上面进行修改。幸好grub是可以自定义启动顺序的，所以将进入bios的启动项配置为第一个就可以了。</p>
<pre><code class="shell">if [ $&#123;grub_platform&#125; == &quot;efi&quot; ]; then
        menuentry &quot;Firmware setup&quot; &#123;
                fwsetup
        &#125;
fi
</code></pre>
<p>将以上代码写入<code>/boot/grub/grub.cfg</code>中，放到第一个启动位置。然后重启，顺利进入bios。最终找到了问题所在</p>
<p><img src=".images/MSI_SnapShot.bmp"></p>
<p>MSI的fast boot会导致在bios加载过程中不进行usb，硬盘识别，由于键盘/启动盘是用usb连接的，所以识别不到。将MSI快速关机禁止掉之后就解决了问题。</p>
<p>所以如果是台式机，这个选项一定不能开启，否则bios都进入不了。笔记本电脑才能开启这个选项。不管怎么说，这个功能确实很不错，开启这个选项后进入系统的时间确实会减少很多。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://raw.githubusercontent.com/ssfwshutterbug/ssfwshutterbug.github.io/main/2022/04/23/noResponseGrub/" data-id="cl9ktb7v8001kdta8a1fh0r09" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/grub/" rel="tag">grub</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-kubernetes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/04/23/kubernetes/" class="article-date">
  <time datetime="2022-04-23T15:06:20.000Z" itemprop="datePublished">2022-04-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/learn/">learn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/23/kubernetes/">kubernetes</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="kubernetes"><a href="#kubernetes" class="headerlink" title="kubernetes"></a>kubernetes</h1><h2 id="feature"><a href="#feature" class="headerlink" title="feature"></a>feature</h2><ul>
<li>high availablity or no downtime</li>
<li>scalability or high performance</li>
<li>disaster recovery (backup and restore)</li>
</ul>
<h2 id="process-of-worker-nodes"><a href="#process-of-worker-nodes" class="headerlink" title="process of worker nodes"></a>process of worker nodes</h2><p>there are three processes in worker loads</p>
<ul>
<li><strong>kubectl</strong>: operate on pods, with the ability of resource devision</li>
<li><strong>kube proxy</strong>: communicate with nodes, with the ability of load balance</li>
<li><strong>container runtime</strong>: run container</li>
</ul>
<h2 id="process-of-main-nodes"><a href="#process-of-main-nodes" class="headerlink" title="process of main nodes"></a>process of main nodes</h2><p>there are four processes in master nodes</p>
<ul>
<li><strong>api server</strong>: access all web ui or ctl operation commands</li>
<li><strong>scheduler</strong>: calculate worker nodes resource and decide which worker node the pod will start up</li>
<li><strong>controller manager</strong>: monitor pods’s availability and restart/rebuild the broken pods</li>
<li><strong>etcd</strong>: the database of master nodes, stores all collected information from worker  nodes</li>
</ul>
<h2 id="main-kubernetes-components"><a href="#main-kubernetes-components" class="headerlink" title="main kubernetes components"></a>main kubernetes components</h2><table>
<thead>
<tr>
<th>components</th>
<th>feature</th>
</tr>
</thead>
<tbody><tr>
<td>pod</td>
<td>the smallest unit in k8s</td>
</tr>
<tr>
<td>service</td>
<td>add permanent ip address for deployment</td>
</tr>
<tr>
<td>ingress</td>
<td>map url with service</td>
</tr>
<tr>
<td>configmap</td>
<td></td>
</tr>
<tr>
<td>secret</td>
<td>store secret user name/password (encoded with base64)</td>
</tr>
<tr>
<td>volume</td>
<td>add persistence data storage</td>
</tr>
<tr>
<td>deployment</td>
<td>the method(blueprint) deploy pod</td>
</tr>
<tr>
<td>statefulset</td>
<td>the method(blueprint) deploy pod, with the ability of data sync</td>
</tr>
</tbody></table>
<h2 id="install-minikube"><a href="#install-minikube" class="headerlink" title="install minikube"></a>install minikube</h2><p><a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/start/">minikube</a> has kubernetes’s all availability but tool installed in one machine.</p>
<pre><code class="shell"># install in centos with new docker version
# don&#39;t install docker with yum default repo, for the version is too old
# follow this link :https://docs.docker.com/engine/install/centos/
sudo yum install -y yum-utils

sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
    
sudo yum install docker-ce docker-ce-cli containerd.io -y
sudo systemctl enable --now docker
  


# install minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-latest.x86_64.rpm
sudo rpm -Uvh minikube-latest.x86_64.rpm


# start minikube with none root priviledge user
useradd -G docker kube &amp;&amp; newgrp docker &amp;&amp; su - kube
minikube start
</code></pre>
<h2 id="create-pods"><a href="#create-pods" class="headerlink" title="create pods"></a>create pods</h2><p>there are two ways to create pods:</p>
<ul>
<li><strong>command line</strong>: simple usage  </li>
<li><strong>configure file</strong>: full feature</li>
</ul>
<h3 id="via-command-line"><a href="#via-command-line" class="headerlink" title="via command line"></a>via command line</h3><p><strong>get information</strong> of default configuration</p>
<pre><code class="shell">alias kubectl=&quot;minikube kubectl --&quot;
kubectl get nodes/deployment/pods/configmap/services/replicaset/all [-o wide] [--watch]
</code></pre>
<p><strong>create</strong> new pod</p>
<pre><code class="shell">kubectl create deployment nginx --image=nginx
</code></pre>
<blockquote>
<p>Note:</p>
<p>kubernetes doesn’t create pod directly, but the layer: deployment</p>
</blockquote>
<p>the command above creates a <strong>blueprint</strong> of nginx automatically, we can edit it</p>
<pre><code class="shell">kubectl edit deployment nginx
</code></pre>
<p>check pod’s <strong>detail</strong> information</p>
<pre><code class="shell"># deploy info
kubectl describe pod [pod-name]
# running log
kubectl logs [pod-name]
</code></pre>
<p><strong>login</strong> container</p>
<pre><code class="shell">kubectl exec -it [pod-name] -- /bin/bash
</code></pre>
<p><strong>delete</strong> deployment</p>
<pre><code class="shell">kubectl get deployment
kubectl delete [deployment-name]
</code></pre>
<blockquote>
<p>Note:</p>
<p>we can only delete pod at the deployment layer, for deployment will restart new pod if we delete the pod with <code>kubectl delete pod [pod-name]</code></p>
</blockquote>
<h3 id="via-configure-file"><a href="#via-configure-file" class="headerlink" title="via configure file"></a>via configure file</h3><p>configure file include three parts</p>
<ul>
<li><strong>metadata</strong></li>
<li><strong>specification</strong></li>
<li><strong>status</strong>(kubernetes auto generate)</li>
</ul>
<p>if we create pod via command line deployment, we can export the configuration file created by kubernetes.</p>
<pre><code class="shell">kubectl get deployment [deploy-name] -o yaml &gt; [deploy-name].yaml
</code></pre>
<p>create or delete deployment</p>
<pre><code class="shell">kubectl create -f [deploy-name].yaml
kubectl delete -f [deploy-name].yaml
</code></pre>
<p>mongodb.yaml</p>
<pre><code class="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb-deployment
  labels:
    app: mongodb
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
      - name: mongodb
        image: mongo
        ports:
          - containerPort: 27017
        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          valueFrom:
            secretKeyRef:
              name: mongodb-secret
              key: root-username
        - name: MONGO_INITDB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-secret
              key: root-password

---
apiVersion: v1
kind: Service
metadata:
  name: mongodb-service
spec:
  selector:
    app: mongodb
  ports:
    - protocol: TCP
      port: 3306
      targetPort: 27017
</code></pre>
<p>mongo-express.yaml</p>
<pre><code class="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo-express
  labels:
    app: mongo-express
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongo-express
  template:
    metadata:
      labels:
        app: mongo-express
    spec:
      containers:
      - name: mongo-express
        image: mongo-express
        ports:
          - containerPort: 8081
        env:
          - name: ME_CONFIG_MONGODB_ADMINUSERNAME
            valueFrom:
              secretKeyRef: 
                name: mongodb-secret
                key: root-username
          - name: ME_CONFIG_MONGODB_ADMINPASSWORD
            valueFrom:
              secretKeyRef: 
                name: mongodb-secret
                key: root-username
          - name: ME_CONFIG_MONGODB_SERVER  
            valueFrom:
              configMapKeyRef:
                name: mongodb-configmap
                key: database_url

---
apiVersion: v1
kind: Service
metadata:
  name: mongo-express-service
spec:
  selector:
    app: mongo-express
  type: LoadBalancer
  ports:
    - protocol: TCP
      port: 8081
      targetPort: 8081
      nodePort: 30000
</code></pre>
<p>mongodb-configmap.yaml</p>
<pre><code class="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-configmap
data:
  database_url: mongodb-service
</code></pre>
<p>mongodb-secret.yaml</p>
<pre><code class="shell">apiVersion: v1
kind: Secret
metadata:
  name: mongodb-secret
type: Opaque
data:
  root-username: bW9uZ28=
  root-password: bW9uZ28=
</code></pre>
<h2 id="network-realization"><a href="#network-realization" class="headerlink" title="network realization"></a>network realization</h2><p><strong>resource link:</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kristenjacobs/container-networking">https://github.com/kristenjacobs/container-networking</a></p>
<p><a target="_blank" rel="noopener" href="https://static.sched.com/hosted_files/kccna18/c1/slides.pdf">https://static.sched.com/hosted_files/kccna18/c1/slides.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=6v_BDHIgOY8">https://www.youtube.com/watch?v=6v_BDHIgOY8</a></p>
<h3 id="communication-between-network-namespaces"><a href="#communication-between-network-namespaces" class="headerlink" title="communication between network namespaces"></a>communication between network namespaces</h3><p><em><strong>each network namespace has its own network stack, they cannot communicate with each other directly</strong></em></p>
<hr>
<p><em><strong>pod is the group of containers, all the containers in a pod share the same network  stack, owns one ip and localhost address</strong></em></p>
<p>so, how can we resolve the problem that host machine(root  namespace) communicates with container /pod (another new created namespace)?</p>
<p>and the answer is <strong>veth pair</strong>(virtual network device), with veth pair two network namespaces can be connected together. packet can flow between the two ethernet interfaces. </p>
<p>in this example, i will use one network namespace instaead of a pod’s or containers’ network stack.</p>
<blockquote>
<p>Note:</p>
<ul>
<li><p>via virtual network technology, eth1-1 is the same as veth1</p>
</li>
<li><p>host(eth0) can ping each container network, but reverse cannot. because all namespace transparency to host </p>
</li>
</ul>
</blockquote>
<p><img src=".images/kubernetes-single-netns.png"></p>
<pre><code class="shell">pod_namespace=cont1
pod_interface=eth1-1
pod_ip=10.10.0.11
vpair=veth1

# create network namespace
sudo ip netns add $&#123;pod_namespace&#125;

# create veth pairs in host root namespace
sudo ip link add $&#123;vpair&#125; type veth peer name $&#123;pod_interface&#125;

# add interface to new network namespace
sudo ip link set $&#123;pod_interface&#125; netns $&#123;pod_namespace&#125;

# add ip address for new interface
sudo ip netns exec $&#123;pod_namespace&#125; ip addr add $&#123;pod_ip&#125;/24 dev $&#123;pod_interface&#125;

# start new namespace loopback up
sudo ip netns exec $&#123;pod_namespace&#125; ip link set lo up

# start new namespace ethernet up
sudo ip netns exec $&#123;pod_namespace&#125; ip link set dev $&#123;pod_interface&#125; up

# start root namespace vpair interface up
sudo ip link set dev $&#123;vpair&#125; up

# add default route for new namespace via ethernet interface
sudo ip netns exec $&#123;pod_namespace&#125; ip route add default via $&#123;pod_ip&#125; dev $&#123;pod_interface&#125;

# add route for root namespace vpair interface
sudo ip route add $&#123;pod_ip&#125; dev $&#123;vpair&#125;

# ping new namespace ethernet ip address in host
ping -c 2 $&#123;pod_ip&#125;
</code></pre>
<h3 id="communication-between-pods"><a href="#communication-between-pods" class="headerlink" title="communication between pods"></a>communication between pods</h3><p>above veth pair can resolve the problem of two network namespaces communication, but not two pods, for there are lots of pods in kubernetes node, we cannot establish veth pairs for each two pods. </p>
<p>and the bridge network device can resolve this problem, a bridge has its own ip address and route table, so pod can communication with each other once they connect to the bridge, it acts just like a router(switch). another benefit of bridge is that bridge device and the host net device are in the same root namespace, both have ip address, so they can communicate directly.</p>
<blockquote>
<p>Note:</p>
<ul>
<li>via bridge network technology, eth1-1 and eth2-2 can ping each other</li>
<li>eth1-1 can ping host eth0, because br0 and eth0 both in the same root namespace</li>
</ul>
</blockquote>
<p><img src=".images/kubernetes-bridge-net.png"></p>
<pre><code class="shell">pod1_namespace=cont1
pod1_interface=eth1-1
pod1_ip=10.10.0.11
vpair1=veth1

bridge_interface=br0
bridge_ip=10.10.0.1

pod2_namespace=cont2
pod2_interface=eth2-2
pod2_ip=10.10.0.22
vpair2=veth2


# create network namespace
sudo ip netns add $&#123;pod1_namespace&#125;
sudo ip netns add $&#123;pod2_namespace&#125;

# create veth pairs in host root namespace
sudo ip link add $&#123;vpair1&#125; type veth peer name $&#123;pod1_interface&#125;
sudo ip link add $&#123;vpair2&#125; type veth peer name $&#123;pod2_interface&#125;

# add interface to new network namespace
sudo ip link set $&#123;pod1_interface&#125; netns $&#123;pod1_namespace&#125;
sudo ip link set $&#123;pod2_interface&#125; netns $&#123;pod2_namespace&#125;

# add ip address for new interface
sudo ip netns exec $&#123;pod1_namespace&#125; ip addr add $&#123;pod1_ip&#125;/24 dev $&#123;pod1_interface&#125;
sudo ip netns exec $&#123;pod2_namespace&#125; ip addr add $&#123;pod2_ip&#125;/24 dev $&#123;pod2_interface&#125;

# start new namespace loopback up
sudo ip netns exec $&#123;pod1_namespace&#125; ip link set lo up
sudo ip netns exec $&#123;pod2_namespace&#125; ip link set lo up

# start new namespace ethernet up
sudo ip netns exec $&#123;pod1_namespace&#125; ip link set dev $&#123;pod1_interface&#125; up
sudo ip netns exec $&#123;pod2_namespace&#125; ip link set dev $&#123;pod2_interface&#125; up

# start root namespace vpair interface up
sudo ip link set dev $&#123;vpair1&#125; up
sudo ip link set dev $&#123;vpair2&#125; up

# create a bridge
sudo ip link add name $&#123;bridge_interface&#125; type bridge

# assign a IP address to the bridge
sudo ip addr add $&#123;bridge_ip&#125;/24 dev $&#123;bridge_interface&#125;

# add two veth pair interface to bridge
sudo ip link set dev $&#123;vpair1&#125; master $&#123;bridge_interface&#125;
sudo ip link set dev $&#123;vpair2&#125; master $&#123;bridge_interface&#125;

# start the bridge up
sudo ip link set dev $&#123;bridge_interface&#125; up

# add the default route in two network namespaces
sudo ip netns exec $&#123;pod1_namespace&#125; ip route add default via $&#123;bridge_ip&#125; dev $&#123;pod1_interface&#125;
sudo ip netns exec $&#123;pod2_namespace&#125; ip route add default via $&#123;bridge_ip&#125; dev $&#123;pod2_interface&#125;

# two containers ping each other
ip netns exec $&#123;pod1_namespace&#125; ping -c 3 $&#123;pod2_ip&#125;
ip netns exec $&#123;pod2_namespace&#125; ping -c 3 $&#123;pod1_ip&#125;
</code></pre>
<h3 id="communication-between-nodes-with-different-subnet"><a href="#communication-between-nodes-with-different-subnet" class="headerlink" title="communication between nodes with different subnet"></a>communication between nodes with different subnet</h3><p>with veth pair and bridge network technology, the container can reach host network and other pod’s network in one node. so communication in two nodes, the only thing we need to do is assigning a route table.</p>
<p>run script in one node. node ip is <code>192.168.31.100/24</code> and ether interface is <code>eth0</code></p>
<blockquote>
<p>Note:</p>
<ul>
<li>container network can reach the host point already, we only need to specify each node to other node’s route table</li>
</ul>
</blockquote>
<p><img src=".images/kubernetes-multi-nodes.png"></p>
<pre><code class="shell">pod1_namespace=cont1
pod1_interface=eth1-1
pod1_ip=10.10.0.11
vpair1=veth1

bridge_interface=br0
bridge_ip=10.10.0.1

pod2_namespace=cont2
pod2_interface=eth2-2
pod2_ip=10.10.0.22
vpair2=veth2


# create network namespace
sudo ip netns add $&#123;pod1_namespace&#125;
sudo ip netns add $&#123;pod2_namespace&#125;

# create veth pairs in host root namespace
sudo ip link add $&#123;vpair1&#125; type veth peer name $&#123;pod1_interface&#125;
sudo ip link add $&#123;vpair2&#125; type veth peer name $&#123;pod2_interface&#125;

# add interface to new network namespace
sudo ip link set $&#123;pod1_interface&#125; netns $&#123;pod1_namespace&#125;
sudo ip link set $&#123;pod2_interface&#125; netns $&#123;pod2_namespace&#125;

# add ip address for new interface
sudo ip netns exec $&#123;pod1_namespace&#125; ip addr add $&#123;pod1_ip&#125;/24 dev $&#123;pod1_interface&#125;
sudo ip netns exec $&#123;pod2_namespace&#125; ip addr add $&#123;pod2_ip&#125;/24 dev $&#123;pod2_interface&#125;

# start new namespace loopback up
sudo ip netns exec $&#123;pod1_namespace&#125; ip link set lo up
sudo ip netns exec $&#123;pod2_namespace&#125; ip link set lo up

# start new namespace ethernet up
sudo ip netns exec $&#123;pod1_namespace&#125; ip link set dev $&#123;pod1_interface&#125; up
sudo ip netns exec $&#123;pod2_namespace&#125; ip link set dev $&#123;pod2_interface&#125; up

# start root namespace vpair interface up
sudo ip link set dev $&#123;vpair1&#125; up
sudo ip link set dev $&#123;vpair2&#125; up

# create a bridge
sudo ip link add name $&#123;bridge_interface&#125; type bridge

# assign a IP address to the bridge
sudo ip addr add $&#123;bridge_ip&#125;/24 dev $&#123;bridge_interface&#125;

# add two veth pair interface to bridge
sudo ip link set dev $&#123;vpair1&#125; master $&#123;bridge_interface&#125;
sudo ip link set dev $&#123;vpair2&#125; master $&#123;bridge_interface&#125;

# start the bridge up
sudo ip link set dev $&#123;bridge_interface&#125; up

# add the default route in two network namespaces
sudo ip netns exec $&#123;pod1_namespace&#125; ip route add default via $&#123;bridge_ip&#125; dev $&#123;pod1_interface&#125;
sudo ip netns exec $&#123;pod2_namespace&#125; ip route add default via $&#123;bridge_ip&#125; dev $&#123;pod2_interface&#125;

# two containers ping each other
ip netns exec $&#123;pod1_namespace&#125; ping -c 3 $&#123;pod2_ip&#125;
ip netns exec $&#123;pod2_namespace&#125; ping -c 3 $&#123;pod1_ip&#125;

######################################## above almost the same ############################################################
# add route to another node&#39;s bridge
sudo ip route add 10.10.1.0/24 via 192.168.31.200 dev eth0
sudo sysctl -w net.ipv4.ip_forward=1

# test 
ip netns exec $&#123;pod1_namespace&#125; ping -c 3 10.10.1.11
</code></pre>
<p>run script in another node, node ip is <code>192.168.31.200/24</code> and ether interface is <code>eth0</code></p>
<pre><code class="shell">pod1_namespace=cont1
pod1_interface=eth1-1
pod1_ip=10.10.1.11
vpair1=veth1

bridge_interface=br0
bridge_ip=10.10.1.1

pod2_namespace=cont2
pod2_interface=eth2-2
pod2_ip=10.10.1.22
vpair2=veth2


# create network namespace
sudo ip netns add $&#123;pod1_namespace&#125;
sudo ip netns add $&#123;pod2_namespace&#125;

# create veth pairs in host root namespace
sudo ip link add $&#123;vpair1&#125; type veth peer name $&#123;pod1_interface&#125;
sudo ip link add $&#123;vpair2&#125; type veth peer name $&#123;pod2_interface&#125;

# add interface to new network namespace
sudo ip link set $&#123;pod1_interface&#125; netns $&#123;pod1_namespace&#125;
sudo ip link set $&#123;pod2_interface&#125; netns $&#123;pod2_namespace&#125;

# add ip address for new interface
sudo ip netns exec $&#123;pod1_namespace&#125; ip addr add $&#123;pod1_ip&#125;/24 dev $&#123;pod1_interface&#125;
sudo ip netns exec $&#123;pod2_namespace&#125; ip addr add $&#123;pod2_ip&#125;/24 dev $&#123;pod2_interface&#125;

# start new namespace loopback up
sudo ip netns exec $&#123;pod1_namespace&#125; ip link set lo up
sudo ip netns exec $&#123;pod2_namespace&#125; ip link set lo up

# start new namespace ethernet up
sudo ip netns exec $&#123;pod1_namespace&#125; ip link set dev $&#123;pod1_interface&#125; up
sudo ip netns exec $&#123;pod2_namespace&#125; ip link set dev $&#123;pod2_interface&#125; up

# start root namespace vpair interface up
sudo ip link set dev $&#123;vpair1&#125; up
sudo ip link set dev $&#123;vpair2&#125; up

# create a bridge
sudo ip link add name $&#123;bridge_interface&#125; type bridge

# assign a IP address to the bridge
sudo ip addr add $&#123;bridge_ip&#125;/24 dev $&#123;bridge_interface&#125;

# add two veth pair interface to bridge
sudo ip link set dev $&#123;vpair1&#125; master $&#123;bridge_interface&#125;
sudo ip link set dev $&#123;vpair2&#125; master $&#123;bridge_interface&#125;

# start the bridge up
sudo ip link set dev $&#123;bridge_interface&#125; up

# add the default route in two network namespaces
sudo ip netns exec $&#123;pod1_namespace&#125; ip route add default via $&#123;bridge_ip&#125; dev $&#123;pod1_interface&#125;
sudo ip netns exec $&#123;pod2_namespace&#125; ip route add default via $&#123;bridge_ip&#125; dev $&#123;pod2_interface&#125;

# two containers ping each other
ip netns exec $&#123;pod1_namespace&#125; ping -c 3 $&#123;pod2_ip&#125;
ip netns exec $&#123;pod2_namespace&#125; ping -c 3 $&#123;pod1_ip&#125;

######################################## above almost the same ############################################################
# add route to another node&#39;s bridge
sudo ip route add 10.10.0.0/24 via 192.168.31.100 dev eth0
sudo sysctl -w net.ipv4.ip_forward=1

# test
ip netns exec $&#123;pod1_namespace&#125; ping -c 3 10.10.0.11
</code></pre>
<blockquote>
<p>Note:</p>
<ul>
<li>it is a huge work if there are hundreds of nodes, so instead of manually configure, there are lots of CNI plugin for us to choose. such as flannel, calico…</li>
</ul>
</blockquote>
<p><img src=".images/kubernetes-cni-net.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://raw.githubusercontent.com/ssfwshutterbug/ssfwshutterbug.github.io/main/2022/04/23/kubernetes/" data-id="cl9ktb7v6001bdta87aopbzq7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-k8s" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/04/23/k8s/" class="article-date">
  <time datetime="2022-04-23T15:05:29.000Z" itemprop="datePublished">2022-04-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/learn/">learn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/23/k8s/">k8s</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="kubernetes"><a href="#kubernetes" class="headerlink" title="kubernetes"></a>kubernetes</h1><h2 id="core-component"><a href="#core-component" class="headerlink" title="core component"></a>core component</h2><ul>
<li>etcd：分布式存储，保存集群状态</li>
<li>apiserver：api操作接口</li>
<li>controller manager：维护集群状态</li>
<li>scheduler：资源调度</li>
<li>kubelet：容器生命周期，volume和网络管理</li>
<li>container runtime：镜像管理，pod和容器管理</li>
<li>kube-proxy：内部服务发现和负载均衡</li>
</ul>
<h2 id="basic-concept"><a href="#basic-concept" class="headerlink" title="basic concept"></a>basic concept</h2><p><strong>container</strong>: k8s构建在容器之上，容器被k8s所管理，容器间采用namespace进行隔离</p>
<p><strong>pod</strong>: k8s使用pod来管理容器，一个pod中一般运行相同的程序，因为pod内的容器共享网络（处于同网段）和文件系统，可进行进程间通信和文件共享</p>
<p><strong>node</strong>: node是部署pod的地方，所以node的大小决定能够部署虚拟机的多少</p>
<p><strong>service</strong>: 服务可以跨越pod，每个服务会分配一个内部的cluster ip和dns，供其它容器访问</p>
<p><strong>label &amp; annotation</strong>: label用来标识对象，annatation用来做注释</p>
<p><strong>volume</strong>: 为了pod的启停不对数据造成损坏，volume可实现数据持久化</p>
<p><em><strong>确保pod数量的方式</strong></em></p>
<p><strong>rc (replication controller)</strong>: 保证pod的高可用，申明确定的pod数量，并维持pod数量不变</p>
<p><strong>rs (replica set)</strong>: 新一代的rc，支持更多种类的匹配模式</p>
<p><strong>deployment</strong>：比rs应用更广，用于创建、更新、滚动升级服务</p>
<p><em><strong>服务发现和负载均衡</strong></em></p>
<p><strong>service</strong>提供了pod对外服务的确定ip和端口，不需要考虑pod新建和销毁所引起的ip地址变化</p>
<p><strong>job</strong>:用来控制批处理型任务，执行一次完成后自动退出</p>
<h2 id="commands"><a href="#commands" class="headerlink" title="commands"></a>commands</h2><pre><code class="shell">kubectl get                # list pods
kubectl describe         # detail info
kubectl logs            # logs
kubectl exec            # execute command in container
kubectl run                # run a simple container
kubectl create -f xx.yaml # run container commonly
</code></pre>
<h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><p>成功安装kubernetes的前提条件：</p>
<ol>
<li>安装k8s的机器保证cpu个数大于等于2</li>
<li>内存不使用swap分区</li>
<li>多节点的时候需要有主机名与对应ip的映射关系</li>
<li>关闭防火墙<code>setenforce</code> <code>firewalld</code></li>
<li>对应版本的docker和k8s</li>
</ol>
<blockquote>
<p>这里使用的版本为：</p>
<p>docker:</p>
<p>​    docker-ce-19.03.0-3.el7 </p>
<p>​    docker-ce-cli-19.03.0-3.el7 </p>
<p>​    containerd.io-1.4.4-3.1.el7</p>
<p>k8s:</p>
<p>​    kubelet-1.20.0-0 </p>
<p>​    kubeadm-1.20.0-0 </p>
<p>​    kubectl-1.20.0-0 </p>
</blockquote>
<h2 id="install-1"><a href="#install-1" class="headerlink" title="install"></a>install</h2><h4 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h4><pre><code class="shell"># leader
hostnamectl set-hostname k8l
# node
hostnamectl set-hostname k8n1
</code></pre>
<h4 id="设置主机与ip的映射关系"><a href="#设置主机与ip的映射关系" class="headerlink" title="设置主机与ip的映射关系"></a>设置主机与ip的映射关系</h4><blockquote>
<p>Note:</p>
<ol>
<li>k8s的节点主机最好设置为静态ip，因为ip变化之后node节点也会消失</li>
<li>一般多节点最好是奇数个，但这里采用2个</li>
</ol>
</blockquote>
<pre><code class="shell"># 建立映射关系
cat &gt;&gt; /etc/hosts &lt;&lt; EOF
192.168.31.11 k8l
192.168.31.12 k8n1
EOF

echo nameserver 114.114.114.114 &gt; /etc/resolv.conf
</code></pre>
<h4 id="关闭防火墙-amp-swap分区"><a href="#关闭防火墙-amp-swap分区" class="headerlink" title="关闭防火墙&amp;swap分区"></a>关闭防火墙&amp;swap分区</h4><pre><code class="shell"># 关闭firewalld
systemctl stop firewalld
systemctl disable firewalld

# 关闭selinux
setenforce 0
sed -i &#39;s/=enforcing/=permissive/&#39; /etc/sysconfig/selinux

# 关闭swap分区
swapoff -a
sed -i &#39;/swap/s/^/#/&#39; /etc/fstab
</code></pre>
<h4 id="docker安装-amp-配置"><a href="#docker安装-amp-配置" class="headerlink" title="docker安装&amp;配置"></a>docker安装&amp;配置</h4><pre><code class="shell"># 配置docker源
yum install -y yum-utils
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 安装docker
yum install docker-ce-19.03.0-3.el7 docker-ce-cli-19.03.0-3.el7 containerd.io-1.4.4-3.1.el7 -y
</code></pre>
<blockquote>
<p>Note:</p>
<p>查看版本：yum list containerd.io –showduplicates | sort -r</p>
</blockquote>
<p>修改docker<code>cgroupdriver</code>为<code>systemd</code> (默认为cgroupfs)</p>
<pre><code class="shell">mkdir /etc/docker
cat &gt; /etc/docker/daemon.json &lt;&lt; EOF
&#123;
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]
&#125;
EOF
</code></pre>
<p>启动docker，配置自启动</p>
<pre><code class="shell">systemctl enable docker
systemctl start docker
</code></pre>
<h4 id="k8s安装-amp-配置"><a href="#k8s安装-amp-配置" class="headerlink" title="k8s安装&amp;配置"></a>k8s安装&amp;配置</h4><pre><code class="shell"># 允许k8s进行流量代理
cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF

# 添加国内k8s镜像源
cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF
[kubernetes]
name=Kubernetes Repo
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
gpgcheck=0
enabled=1
EOF

# 安装k8s
yum install -y kubelet-1.20.0-0 kubeadm-1.20.0-0 kubectl-1.20.0-0 
</code></pre>
<p>允许k8s自启动</p>
<pre><code class="shell">systemctl enable kubelet
</code></pre>
<blockquote>
<p>Note:</p>
<p>这里不需要启动k8s，现在启动会报错</p>
</blockquote>
<h5 id="主节点配置"><a href="#主节点配置" class="headerlink" title="主节点配置"></a>主节点配置</h5><p>主节点初始化</p>
<pre><code class="shell"># 修改apiserver-advertise-address为master的ip
kubeadm init --kubernetes-version=1.20.0  \
--apiserver-advertise-address=192.168.31.11   \
--image-repository registry.aliyuncs.com/google_containers  \
--service-cidr=10.10.0.0/16 --pod-network-cidr=10.122.0.0/16
</code></pre>
<blockquote>
<p>Note:</p>
<p>主节点初始化失败后可以重新初始化，不过需要先清空之前初始化的配置</p>
<pre><code class="shell">kubeadm reset
rm -rf /etc/cni
rm -rf $HOME/.kube/config
</code></pre>
</blockquote>
<p>初始化完成后会在终端打印一些重要信息，需要记录下来。比如node接入的命令</p>
<pre><code class="shell"> mkdir -p $HOME/.kube
 sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
 sudo chown $(id -u):$(id -g) $HOME/.kube/config
 export KUBECONFIG=/etc/kubernetes/admin.conf
</code></pre>
<p>修改端口</p>
<pre><code class="shell">sed -i &#39;s/insecure-port=0/insecure-port=8080/&#39; /etc/kubernetes/manifests/kube-apiserver.yaml
</code></pre>
<p>启动kubelet</p>
<pre><code class="shell">systemctl start kubelet
</code></pre>
<p>安装网络管理插件</p>
<pre><code class="shell">kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
</code></pre>
<blockquote>
<p>Note:<br>The connection to the server 192.168.31.11:6443 was refused - did you specify the right host or port?</p>
<p>遇到以上报错时，需要重新初始化，一般是某些k8s的docker启动失败。</p>
<pre><code class="shell">systemctl stop kubelet
systemctl stop docker

kubeadm reset
rm -rf /etc/cni
rm -rf $HOME/.kube/config

systemctl start docker
systemctl start kubelet

kubeadm init --kubernetes-version=1.20.0  \
--apiserver-advertise-address=192.168.31.11   \
--image-repository registry.aliyuncs.com/google_containers  \
--service-cidr=10.10.0.0/16 --pod-network-cidr=10.122.0.0/16
</code></pre>
</blockquote>
<h5 id="node接入主节点"><a href="#node接入主节点" class="headerlink" title="node接入主节点"></a>node接入主节点</h5><pre><code class="shell"># node上运行
kubeadm join 192.168.31.11:6443 --token nfb8gw.46gfska1dhfevlg9 --discovery-token-ca-cert-hash sha256:5ca678d7bcda290d7a692474711cbf1e5d5a11bc51969cbd453561e1f3186476
</code></pre>
<p>如果忘记了以上命令，那么需要重新获取</p>
<pre><code class="shell"># 查看token的值
kubeadm token list

# 如果过期了重新生成
kubeadm token create

# 获取ca证书的sha256编码hash值
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssdgst -sha256 -hex | sed &#39;s/^.* //&#39;

# 组装
kubeadm join 192.168.31.11:6443 --token &#123;&#123;token&#125;&#125; --discovery-token-ca-cert-hash sha256:&#123;&#123;hash&#125;&#125;
</code></pre>
<h4 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h4><pre><code class="shell">kubectl get nodes
kubectl get pods -n kube-system
kubectl get namespace
kubectl get pods
</code></pre>
<p>需要等待一会才是ready状态</p>
<pre><code class="shell">[root@k8l ~]# kubectl get nodes
NAME   STATUS   ROLES                  AGE     VERSION
k8l    Ready    control-plane,master   25m     v1.20.0
k8n1   Ready    &lt;none&gt;                 8m33s   v1.20.0
</code></pre>
<h4 id="创建nginx"><a href="#创建nginx" class="headerlink" title="创建nginx"></a>创建nginx</h4><pre><code class="shell">kubectl create deployment nginx --image=nginx
kubectl expose deployment nginx --port=80 --type=NodePort
kubectl get pod,svc

# 查看80映射端口
[root@k8s-master ~]# kubectl get pod,svc
NAME                         READY   STATUS              RESTARTS   AGE
pod/nginx-6799fc88d8-7rgq6   0/1     ContainerCreating   0          16s

NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
service/kubernetes   ClusterIP   10.10.0.1      &lt;none&gt;        443/TCP        34m
service/nginx        NodePort    10.10.78.172   &lt;none&gt;        80:31613/TCP   7s

# web界面访问
http://192.168.31.111:31613
</code></pre>
<h2 id="daskboard"><a href="#daskboard" class="headerlink" title="daskboard"></a>daskboard</h2><p><strong>install</strong></p>
<p>follow <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/">this website</a>) to install dashboard</p>
<pre><code class="shell"># run this command 
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml
</code></pre>
<pre><code class="shell"># 如果上面下载不下来也可以用我的gitee文件。内容和上面一样
kubectl apply -f https://gitee.com/ulomo/some-config-file/raw/master/recommended.yaml
</code></pre>
<p><strong>edit settting</strong></p>
<p>in default we cannot access dashboard outsite the host machine where k8s installed. with [this method](<a target="_blank" rel="noopener" href="https://www.thegeekdiary.com/how-to-access-kubernetes-dashboard-externally/">How To Access Kubernetes Dashboard Externally – The Geek Diary</a>) we can access dashboard with host ip address </p>
<pre><code class="shell"># change service “type” from ClusterIP to NodePort
kubectl -n kubernetes-dashboard edit service kubernetes-dashboard
</code></pre>
<p>then find port to visit.<code> it is 31235</code></p>
<pre><code class="shell">[root@k8m ~]# kubectl get services --all-namespaces
NAMESPACE              NAME                        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                  AGE
default                kubernetes                  ClusterIP   10.10.0.1      &lt;none&gt;        443/TCP                  74m
kube-system            kube-dns                    ClusterIP   10.10.0.10     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   74m
kubernetes-dashboard   dashboard-metrics-scraper   ClusterIP   10.10.27.176   &lt;none&gt;        8000/TCP                 59m
kubernetes-dashboard   kubernetes-dashboard        NodePort    10.10.222.86   &lt;none&gt;        443:31235/TCP            59m
</code></pre>
<p><strong>create user</strong></p>
<p>[follow this website](<a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">dashboard/creating-sample-user.md at master · kubernetes/dashboard · GitHub</a>) to create user</p>
<pre><code class="shell">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
EOF

cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard
EOF
</code></pre>
<p><strong>get tocken</strong></p>
<p>get tocken login needed</p>
<pre><code class="shell">kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath=&quot;&#123;.secrets[0].name&#125;&quot;) -o go-template=&quot;&#123;&#123;.data.token | base64decode&#125;&#125;&quot; |less
</code></pre>
<p>at last, we can visit dashboard with k8s master ip address: <code>https://192.168.31.11:31235/</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://raw.githubusercontent.com/ssfwshutterbug/ssfwshutterbug.github.io/main/2022/04/23/k8s/" data-id="cl9ktb7v40018dta80685adag" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-iptables" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/04/23/iptables/" class="article-date">
  <time datetime="2022-04-23T15:04:53.000Z" itemprop="datePublished">2022-04-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/learn/">learn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/23/iptables/">iptables</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="IPTABLES"><a href="#IPTABLES" class="headerlink" title="IPTABLES"></a>IPTABLES</h1><p>iptables is a powerful tool(front of kernel netfilter module) to manually change the way that network connection of our computer. we can do everything with the network connection such as port forward, nat network transfer, load balancer and etc.</p>
<h2 id="tables"><a href="#tables" class="headerlink" title="tables"></a>tables</h2><p>as first we need to know that there are 5 tables for us to store our ip table rules:</p>
<table>
<thead>
<tr>
<th>table</th>
<th>aims</th>
</tr>
</thead>
<tbody><tr>
<td>raw</td>
<td>exempt from connection tracking</td>
</tr>
<tr>
<td>filter</td>
<td>common to adjust input and output policy</td>
</tr>
<tr>
<td>nat</td>
<td>common to do network address translation</td>
</tr>
<tr>
<td>mangle</td>
<td>specialized packet alterations</td>
</tr>
<tr>
<td>security</td>
<td>security access</td>
</tr>
</tbody></table>
<p>the most important thing is that the life of packet working though isn’t from one table to another table, so, table is just a group of rules that have the same effective function. in order to make the configuration much easier, there comes <code>chain</code> concept. each table has different chains.</p>
<h2 id="startup-and-save"><a href="#startup-and-save" class="headerlink" title="startup and save"></a>startup and save</h2><p>in my archlinux, it isn’t enabled by default.</p>
<pre><code class="shell"># enable iptables and start
sudo systemctl enable --now iptables
</code></pre>
<p>terminal setting of iptables will not store in disk, in order to make it effect after reboot we need to save it.</p>
<pre><code class="shell">sudo iptables-save -f /etc/iptables/iptables.rules
</code></pre>
<p>in general, we don’t modify this file directly. however if we do that a reload is needed.</p>
<pre><code class="shell">sudo iptables-restart /etc/iptables/iptables.rules
</code></pre>
<h2 id="list-rules"><a href="#list-rules" class="headerlink" title="list rules"></a>list rules</h2><p><code>--list</code>: list all rules with DNS resolve, don’t use this along since it will display for a long time.</p>
<p><code>--numeric</code>: don’t resolve DNS, display ip directly.</p>
<p><code>--list-rules</code>: list all origin commands.</p>
<p><code>--line-number</code>: list rules with line number.</p>
<p><code>--verbose</code>: show packet account.</p>
<pre><code class="shell">sudo iptables --table filter --list --numeric
sudo iptables --table nat --list --numeric --line-number
sudo iptables --table mangle --list-rules
</code></pre>
<blockquote>
<p>Note:</p>
<p>use <code>list</code> with <code>numeric</code> together, or it will <a target="_blank" rel="noopener" href="https://serverfault.com/questions/85602/iptables-l-pretty-slow-is-this-normal">spend lots of time</a> to reverse ip address to DNS/hostname</p>
</blockquote>
<h2 id="import-modules"><a href="#import-modules" class="headerlink" title="import modules"></a>import modules</h2><p>In iptables, there are lots of modules we can use. For example <code>--protocol tcp</code> will import a module named tcp in backend. If we want to use other modules, we can use <code>--module module_name</code> to import.</p>
<p>Module <code>comment</code> is very useful for us to add a comment to a rule in case of forgotten.</p>
<pre><code class="shell">sudo iptables --table filter --append FORWARD --jump DROP --module comment --comment &quot;disable all forward traffice by default&quot;
</code></pre>
<h2 id="disable-input-request"><a href="#disable-input-request" class="headerlink" title="disable input request"></a>disable input request</h2><p>in order to enhance personal PC security, i want to disable all request to my PC but only allow local area ssh connect.</p>
<p>if i disable all input traffic, though all output traffic is allowed i cannot access any web site via browser. The reason is that when i send a request to remote web server, the remote server need reply the information that i need, but i already disabled all input traffic, so i cannot visit any web site. Since all connection have a state, if the connection is established, the state will be changed. So i can use this feature.</p>
<pre><code class="shell"># disable all input traffic by default
sudo iptables --table filter --policy INPUT DROP

# allow established connection
sudo iptables --table filter --append INPUT --module state --state ESTABLISHED --jump ACCEPT --module comment --comment &quot;allow established connection&quot;

# allow local area network ssh connectin
sudo iptables --table filter --append INPUT --protocol tcp --dport 22 --jump ACCEPT --module comment --comment &quot;allow local area network ssh connection&quot;
</code></pre>
<h2 id="flush-old-rule-and-modify-default-chain-policy"><a href="#flush-old-rule-and-modify-default-chain-policy" class="headerlink" title="flush old rule and modify default chain policy"></a>flush old rule and modify default chain policy</h2><p>we can choose which one to flush, all table/ one table/ a chain?</p>
<pre><code class="shell"># flush all table
sudo iptables --flush
# flush specified table
sudo iptables --table [table_name] --flush
# flush specified table&#39;s chain
sudo iptables --table [table_name] --flush [chain_name]
</code></pre>
<p>there are two ways to change the default chain policy:</p>
<ol>
<li>directly change chain policy</li>
<li>add a global policy at the end of one chain</li>
</ol>
<pre><code class="shell"># eg: change default ACCEPT to DROP of filter table INPUT chain
sudo iptables --table filter --policy INPUT DROP
sudo iptables --table filter --append INPUT --jump DROP
</code></pre>
<h2 id="NAT-table"><a href="#NAT-table" class="headerlink" title="NAT table"></a>NAT table</h2><p>learn from <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=NAdJojxENEU">youtube video</a>. net table is used to forward packet, much powerful in port forward, ip forward, even load balance.</p>
<h3 id="port-forward"><a href="#port-forward" class="headerlink" title="port forward"></a>port forward</h3><p>all traffic coming to local network will work though nat’s <code>PREROUTING</code> chain. in this chain, we can modify access port to other port realizing port forward.</p>
<p>for example i want other people access my PC’s 8080 port to really visit 80  port.</p>
<pre><code class="shell">sudo iptables --table nat --append PREROUTING --protocol tcp --dport 8080 --jump REDIRECT --to 80 --module comment --comment &quot;redirect 8080 to 80 port&quot;
</code></pre>
<p>now other people visit my PC’s 8080 port will redirect to 80 port.</p>
<p>it is very useful, yeah? one hand, we can enhance security, on the other hand, we can start several same applications with different ports in one machine.</p>
<h3 id="ip-forward"><a href="#ip-forward" class="headerlink" title="ip forward"></a>ip forward</h3><p><img src=".images/image-20210313153205046.png" alt="ip forward"></p>
<p>环境：192.168.31.235主机安装了nginx服务，可以进行web页面80端口访问。现在需要在192.168.31.31（本机）访问192.168.31.114的80端口来间接访问192.168.31.235的nginx服务</p>
<p><code>所有iptables策略在转发192.168.31.114主机上进行配置</code></p>
<pre><code class="shell"># 将来自114：80端口的请求转发到235:80端口
iptables --table nat \
--append PREROUTING \
--protocol tcp \
--dport 80 \
--destination 192.168.31.114 \
--jump DNAT \
--to-destination 192.168.31.235:80

# 将转发到235:80端口的数据源地址31（本机）地址修改为114
iptables --table nat \
--append POSTROUTING \
--protocol tcp \
--dport 80 \
--destination 192.168.31.235 \
--jump SNAT \
--to-source 192.168.31.114
</code></pre>
<blockquote>
<p>Note: </p>
<p>默认主机的ip转发是关闭的，需要手动开启。如果需要永久开启需要在/etc/sysctl.conf中添加</p>
<p>net.ipv4.ip_forward=1</p>
</blockquote>
<pre><code class="shell">echo 1 &gt; /proc/sys/net/ipv4/ip_forward
</code></pre>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://raw.githubusercontent.com/ssfwshutterbug/ssfwshutterbug.github.io/main/2022/04/23/iptables/" data-id="cl9ktb7v30015dta88we37fil" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ip-route" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/04/23/ip-route/" class="article-date">
  <time datetime="2022-04-23T15:04:20.000Z" itemprop="datePublished">2022-04-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/learn/">learn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/23/ip-route/">ip_route</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="IP-addr-and-route"><a href="#IP-addr-and-route" class="headerlink" title="IP addr and route"></a>IP addr and route</h1><h2 id="ip-address-setting"><a href="#ip-address-setting" class="headerlink" title="ip address setting"></a>ip address setting</h2><p>Most of time we login a new system, there has no ip address and we cannot connect to the web and also cannot download packages with package manager. At this time, we have so many methods to configure a system with ip address.</p>
<p><em>if we have dhcpcd client or have network/NetworkManager installed</em></p>
<ol>
<li><p>the easily way is using <code>dhcpcd</code> or <code>dhcpcd network_interface</code> command to get a dynamic ip address. for instance:</p>
<pre><code class="shell">dhcpcd 
# or
dhcpcd wlan0
</code></pre>
</li>
<li><p>if the system use <code>network</code> or <code>NetworkManager</code> to manage network, we can configure static or dynamic ip address. for instance:</p>
<pre><code class="shell">cat /etc/sysconfig/network-scripts/ifcfg-enp0s3

TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=static        # static mathod
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
NAME=enp0s3
UUID=9362a50a-b4fc-4943-ab54-a865b328ef0f
DEVICE=enp0s3
ONBOOT=yes                # auto start

IPADDR=10.10.10.10        # ip
PREFIX=24                # netmask
GATEWAY=10.10.10.1        # gateway
</code></pre>
<p>or simple dynamic ip</p>
<pre><code class="shell">cat /etc/sysconfig/network-scripts/ifcfg-enp0s3

TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=dhcp            # dhcp mathod
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
NAME=enp0s3
UUID=9362a50a-b4fc-4943-ab54-a865b328ef0f
DEVICE=enp0s3
ONBOOT=yes                # auto start
</code></pre>
<blockquote>
<p>Note: if we have a requirement of visiting website, we need set local DNS in <code>/etc/resolv.conf </code></p>
<p>​          eg: <code>echo nameserver 192.168.31.1 &gt; /etc/resolv.conf</code></p>
</blockquote>
</li>
</ol>
<p><em>if there has no dhcpcd and network/NetworkManager</em></p>
<ol>
<li><p>add a ip address and route by hand</p>
<pre><code class="shell">ip address add 192.168.31.33 dev enp0s3
</code></pre>
<p>then add route</p>
<pre><code class="shell">ip route add 192.168.31.0/24 dev enp0s3
</code></pre>
<p>add nameserver</p>
<pre><code class="shell">echo nameserver 192.168.31.1 &gt; /etc/resolv.conf
</code></pre>
<blockquote>
<p>Note: the configuration above we write is temporary, when we reboot the computer or restart network service the configuration will lost. </p>
<ol>
<li>If we use network/NetworkManager, the way to store route configuration is writing command to <code>/etc/sysconfig/network-scripts/route-*</code>, store ip configuration is writing command to <code>/etc/sysconfig/network-scripts/ifcfg-eth*</code>.</li>
<li>if we don’t use network service, the easiest way is writing commands to a start script such as <code>.xinitrc</code> or  setting a service with scripts to execute those commands.</li>
</ol>
</blockquote>
<p><strong>For Example</strong>:</p>
<pre><code class="shell"># add ip address
ip address add 192.168.31.31 dev enp0s3
ip address add 10.10.10.10 dev enp0s3
# add route
ip route add 10.10.10.0/24 dev enp0s3
ip route add 192.168.31.0/24 dev enp0s3
ip route add default via 192.168.31.1 dev enp0s3

# store route configure
cat /etc/sysconfig/network-scripts/route-enp0s3
10.10.10.0/24 dev enp0s3
192.168.31.0/24 dev enp0s3
default via 192.168.31.1 dev enp0s3

# store ip address
cat /etc/sysconfig/network-scripts/ifcfg-enp0s3
IPADDR1=192.168.31.31
PREFIX1=24
GATEWAY1=192.168.31.1

IPADDR2=10.10.10.10
PREFIX2=24
GATEWAY2=10.10.10.1
</code></pre>
</li>
</ol>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><p>if there has more than one network device and we need to configure it by hand where can we  find network interface and mac address?</p>
<p> if <code>ip link show</code> cannot find, we can find it in <code>/sys/class/net</code>.</p>
<p>where to find network interface mac address?</p>
<p>we can find it in <code>/sys/class/net/network_interface/address</code>.</p>
<h2 id="ip-address-alias"><a href="#ip-address-alias" class="headerlink" title="ip address alias"></a>ip address alias</h2><p>we can add more then one ip address to a network interface using</p>
<pre><code class="shell">ip address add 10.10.10.1 dev enp0s3
</code></pre>
<p>it may look like this</p>
<pre><code class="shell">
2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:a9:ce:40 brd ff:ff:ff:ff:ff:ff
    inet 10.10.10.10/24 brd 10.10.10.255 scope global enp0s3
       valid_lft forever preferred_lft forever
    inet 192.168.31.33/32 scope global enp0s3
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fea9:ce40/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre>
<p>or we can use ip alias by using</p>
<pre><code class="shell">ip address add 12.12.12.12/24 dev enp0s3 label enp0s3:1
</code></pre>
<p>it may look like this</p>
<pre><code class="shell">2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:a9:ce:40 brd ff:ff:ff:ff:ff:ff
    inet 10.10.10.10/24 brd 10.10.10.255 scope global enp0s3
       valid_lft forever preferred_lft forever
    inet 192.168.31.33/32 scope global enp0s3
       valid_lft forever preferred_lft forever
    inet 12.12.12.12/24 scope global enp0s3:1    # alias
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fea9:ce40/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre>
<p>the way to save ip alias configure is</p>
<pre><code class="shell">cd /etc/sysconfig/network-scripts/
cp ifcfg-enp0s3 ifcfg-enp0s3:1

cat ifcfg-enp0s3:1

IPADDR=12.12.12.12
PREFIX=24
GATEWAY=12.12.12.1
</code></pre>
<h2 id="nat-路由转发"><a href="#nat-路由转发" class="headerlink" title="nat 路由转发"></a>nat 路由转发</h2><p>可以连接外网的网段是192.168.31.0/24，自己组建局域网的网段是10.10.10.0/24，要用一个linux主机做路由转发，让10.10.10.0/24网段的主机可以连接外网。</p>
<h3 id="设备"><a href="#设备" class="headerlink" title="设备"></a>设备</h3><ul>
<li>一台做路由的linux主机，有两张网卡，分别为192网段和10网段ip</li>
<li>其它10.10.10.0/24网段的主机</li>
</ul>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>用virtualbox启动两个centos7的系统：centos-nat分配两张网卡，centos7.1分配一张网卡。</p>
<p>centos-nat需要关闭默认的防火墙firewalld，然后才能使用iptables</p>
<p><em>centos-nat</em></p>
<pre><code class="shell"># centos-nat步骤


## 设置ip
ip address add 192.168.31.33/24 dev enp0s3
ip address add 10.10.10.10/24 dev enp0s8

## 设置路由
ip route add 192.168.31.0/24 dev enp0s3
ip route add 10.10.10.0/24 dev enp0s8
ip route add default via 192.168.31.33 dev enp0s3

## 关闭防火墙
systemctl stop firewalld

## 开启路由
echo 1 &gt; /proc/sys/net/ipv4/ip_forward

## 设置iptables nat转发策略
iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE
</code></pre>
<p><em>centos7.1</em></p>
<pre><code class="shell"># centos7.1步骤

## 设置ip
ip address add 10.10.10.11/24 dev enp0s3

## 设置默认路由
ip address add default via 10.10.10.10 dev enp0s3

## 设置DNS解析
echo nameserver 192.168.31.1 &gt; /etc/resolv.conf
</code></pre>
<p>然后centos7.1（10.10.10.0/24的主机）就可以连接外网了,done.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://raw.githubusercontent.com/ssfwshutterbug/ssfwshutterbug.github.io/main/2022/04/23/ip-route/" data-id="cl9ktb7v20011dta8451n04gg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/route/" rel="tag">route</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/learn/">learn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/think/">think</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/thinking/">thinking</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BB%E5%8E%86%E5%8F%B2/">读历史</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/anaconda/" rel="tag">anaconda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/anbox/" rel="tag">anbox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ansible/" rel="tag">ansible</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/archlinux/" rel="tag">archlinux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boring/" rel="tag">boring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/container/" rel="tag">container</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cursor-theme/" rel="tag">cursor theme</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ed/" rel="tag">ed</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grub/" rel="tag">grub</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/haskell/" rel="tag">haskell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/inject-js-css/" rel="tag">inject js/css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mind/" rel="tag">mind</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/optimized/" rel="tag">optimized</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pentablet/" rel="tag">pentablet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/positive/" rel="tag">positive</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reality-is-aweful/" rel="tag">reality is aweful</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/route/" rel="tag">route</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rust/" rel="tag">rust</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shield/" rel="tag">shield</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/" rel="tag">ssh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp/" rel="tag">tcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vbox/" rel="tag">vbox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vscode/" rel="tag">vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xmonad/" rel="tag">xmonad</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zabbix/" rel="tag">zabbix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zk/" rel="tag">zk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zsh/" rel="tag">zsh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%9D%E7%BB%AA/" rel="tag">思绪</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A5%9E%E8%AF%9D/" rel="tag">神话</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%89%AF%E7%9F%A5/" rel="tag">良知</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/anaconda/" style="font-size: 10px;">anaconda</a> <a href="/tags/anbox/" style="font-size: 10px;">anbox</a> <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/archlinux/" style="font-size: 10px;">archlinux</a> <a href="/tags/boring/" style="font-size: 10px;">boring</a> <a href="/tags/container/" style="font-size: 10px;">container</a> <a href="/tags/cursor-theme/" style="font-size: 10px;">cursor theme</a> <a href="/tags/ed/" style="font-size: 10px;">ed</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/go/" style="font-size: 10px;">go</a> <a href="/tags/grub/" style="font-size: 10px;">grub</a> <a href="/tags/haskell/" style="font-size: 10px;">haskell</a> <a href="/tags/inject-js-css/" style="font-size: 10px;">inject js/css</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a> <a href="/tags/k8s/" style="font-size: 20px;">k8s</a> <a href="/tags/life/" style="font-size: 10px;">life</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/mind/" style="font-size: 10px;">mind</a> <a href="/tags/optimized/" style="font-size: 10px;">optimized</a> <a href="/tags/pentablet/" style="font-size: 10px;">pentablet</a> <a href="/tags/positive/" style="font-size: 10px;">positive</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/reality-is-aweful/" style="font-size: 10px;">reality is aweful</a> <a href="/tags/route/" style="font-size: 10px;">route</a> <a href="/tags/rust/" style="font-size: 10px;">rust</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/shield/" style="font-size: 10px;">shield</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/tcp/" style="font-size: 10px;">tcp</a> <a href="/tags/vbox/" style="font-size: 10px;">vbox</a> <a href="/tags/vscode/" style="font-size: 10px;">vscode</a> <a href="/tags/xmonad/" style="font-size: 20px;">xmonad</a> <a href="/tags/zabbix/" style="font-size: 10px;">zabbix</a> <a href="/tags/zk/" style="font-size: 10px;">zk</a> <a href="/tags/zsh/" style="font-size: 10px;">zsh</a> <a href="/tags/%E6%80%9D%E7%BB%AA/" style="font-size: 15px;">思绪</a> <a href="/tags/%E7%A5%9E%E8%AF%9D/" style="font-size: 10px;">神话</a> <a href="/tags/%E8%89%AF%E7%9F%A5/" style="font-size: 10px;">良知</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/10/23/our-body-may-cheat-ourselves-md/">our-body-may-cheat-ourselves.md</a>
          </li>
        
          <li>
            <a href="/2022/07/04/the-reality/">the-reality</a>
          </li>
        
          <li>
            <a href="/2022/06/25/%E4%BB%8E%E5%AE%B9/">从容</a>
          </li>
        
          <li>
            <a href="/2022/06/25/magic-of-xmonad/">magic-of-xmonad</a>
          </li>
        
          <li>
            <a href="/2022/06/24/xp-pentablet/">xp-pentablet</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 shutterbug<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>